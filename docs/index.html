<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.16">
<meta name="author" content="openQA Team">
<title>openQA Documentation</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/*! Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment the following line when using as a custom stylesheet */
/* @import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700"; */
html{font-family:sans-serif;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
b,strong{font-weight:bold}
abbr{font-size:.9em}
abbr[title]{cursor:help;border-bottom:1px dotted #dddddf;text-decoration:none}
dfn{font-style:italic}
hr{height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type=button],input[type=reset],input[type=submit]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type=checkbox],input[type=radio]{padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,::before,::after{box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;line-height:1;position:relative;cursor:auto;-moz-tab-size:4;-o-tab-size:4;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:1px solid #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;border-radius:3px;box-shadow:0 1px 0 rgba(0,0,0,.2),inset 0 0 0 .1em #fff;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin:0 auto;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:flex;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border:1px solid #e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:hsla(0,0%,100%,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details{margin-left:1.25rem}
details>summary{cursor:pointer;display:block;position:relative;line-height:1.6;margin-bottom:.625rem;-webkit-tap-highlight-color:transparent}
details>summary::before{content:"";border:solid transparent;border-left:solid;border-width:.3em 0 .3em .5em;position:absolute;top:.5em;left:-1.25rem;transform:translateX(15%)}
details[open]>summary::before{border:solid transparent;border-top:solid;border-width:.5em .3em 0;transform:translateY(15%)}
details>summary::after{content:"";width:1.25rem;height:1em;position:absolute;top:.3em;left:-1.25rem}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class=paragraph]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border:1px solid #e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border:1px solid #dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class=highlight],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos{border-right:1px solid;opacity:.35;padding-right:.5em}
pre.pygments .lineno{border-right:1px solid;opacity:.35;display:inline-block;margin-right:.75em}
pre.pygments .lineno::before{content:"";margin-right:-.125em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans-serif;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;font-size:.85rem;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd),table.stripes-even tr:nth-of-type(even),table.stripes-hover tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist>li>p:first-child{margin-left:-1em}
ul.checklist>li>p:first-child>.fa-square-o:first-child,ul.checklist>li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist>li>p:first-child>input[type=checkbox]:first-child{margin-right:.25em}
ul.inline{display:flex;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:4px solid #fff;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt,summary{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt,summary{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]{border-bottom:1px dotted}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media amzn-kf8,print{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<style>
pre { line-height: 125%; }
td.linenos .normal { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
span.linenos { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
td.linenos .special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
span.linenos.special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
pre.pygments .hll { background-color: #ffffcc }
pre.pygments { background: #f8f8f8; }
pre.pygments .tok-c { color: #408080; font-style: italic } /* Comment */
pre.pygments .tok-err { border: 1px solid #FF0000 } /* Error */
pre.pygments .tok-k { color: #008000; font-weight: bold } /* Keyword */
pre.pygments .tok-o { color: #666666 } /* Operator */
pre.pygments .tok-ch { color: #408080; font-style: italic } /* Comment.Hashbang */
pre.pygments .tok-cm { color: #408080; font-style: italic } /* Comment.Multiline */
pre.pygments .tok-cp { color: #BC7A00 } /* Comment.Preproc */
pre.pygments .tok-cpf { color: #408080; font-style: italic } /* Comment.PreprocFile */
pre.pygments .tok-c1 { color: #408080; font-style: italic } /* Comment.Single */
pre.pygments .tok-cs { color: #408080; font-style: italic } /* Comment.Special */
pre.pygments .tok-gd { color: #A00000 } /* Generic.Deleted */
pre.pygments .tok-ge { font-style: italic } /* Generic.Emph */
pre.pygments .tok-gr { color: #FF0000 } /* Generic.Error */
pre.pygments .tok-gh { color: #000080; font-weight: bold } /* Generic.Heading */
pre.pygments .tok-gi { color: #00A000 } /* Generic.Inserted */
pre.pygments .tok-go { color: #888888 } /* Generic.Output */
pre.pygments .tok-gp { color: #000080; font-weight: bold } /* Generic.Prompt */
pre.pygments .tok-gs { font-weight: bold } /* Generic.Strong */
pre.pygments .tok-gu { color: #800080; font-weight: bold } /* Generic.Subheading */
pre.pygments .tok-gt { color: #0044DD } /* Generic.Traceback */
pre.pygments .tok-kc { color: #008000; font-weight: bold } /* Keyword.Constant */
pre.pygments .tok-kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
pre.pygments .tok-kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
pre.pygments .tok-kp { color: #008000 } /* Keyword.Pseudo */
pre.pygments .tok-kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
pre.pygments .tok-kt { color: #B00040 } /* Keyword.Type */
pre.pygments .tok-m { color: #666666 } /* Literal.Number */
pre.pygments .tok-s { color: #BA2121 } /* Literal.String */
pre.pygments .tok-na { color: #7D9029 } /* Name.Attribute */
pre.pygments .tok-nb { color: #008000 } /* Name.Builtin */
pre.pygments .tok-nc { color: #0000FF; font-weight: bold } /* Name.Class */
pre.pygments .tok-no { color: #880000 } /* Name.Constant */
pre.pygments .tok-nd { color: #AA22FF } /* Name.Decorator */
pre.pygments .tok-ni { color: #999999; font-weight: bold } /* Name.Entity */
pre.pygments .tok-ne { color: #D2413A; font-weight: bold } /* Name.Exception */
pre.pygments .tok-nf { color: #0000FF } /* Name.Function */
pre.pygments .tok-nl { color: #A0A000 } /* Name.Label */
pre.pygments .tok-nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
pre.pygments .tok-nt { color: #008000; font-weight: bold } /* Name.Tag */
pre.pygments .tok-nv { color: #19177C } /* Name.Variable */
pre.pygments .tok-ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
pre.pygments .tok-w { color: #bbbbbb } /* Text.Whitespace */
pre.pygments .tok-mb { color: #666666 } /* Literal.Number.Bin */
pre.pygments .tok-mf { color: #666666 } /* Literal.Number.Float */
pre.pygments .tok-mh { color: #666666 } /* Literal.Number.Hex */
pre.pygments .tok-mi { color: #666666 } /* Literal.Number.Integer */
pre.pygments .tok-mo { color: #666666 } /* Literal.Number.Oct */
pre.pygments .tok-sa { color: #BA2121 } /* Literal.String.Affix */
pre.pygments .tok-sb { color: #BA2121 } /* Literal.String.Backtick */
pre.pygments .tok-sc { color: #BA2121 } /* Literal.String.Char */
pre.pygments .tok-dl { color: #BA2121 } /* Literal.String.Delimiter */
pre.pygments .tok-sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
pre.pygments .tok-s2 { color: #BA2121 } /* Literal.String.Double */
pre.pygments .tok-se { color: #BB6622; font-weight: bold } /* Literal.String.Escape */
pre.pygments .tok-sh { color: #BA2121 } /* Literal.String.Heredoc */
pre.pygments .tok-si { color: #BB6688; font-weight: bold } /* Literal.String.Interpol */
pre.pygments .tok-sx { color: #008000 } /* Literal.String.Other */
pre.pygments .tok-sr { color: #BB6688 } /* Literal.String.Regex */
pre.pygments .tok-s1 { color: #BA2121 } /* Literal.String.Single */
pre.pygments .tok-ss { color: #19177C } /* Literal.String.Symbol */
pre.pygments .tok-bp { color: #008000 } /* Name.Builtin.Pseudo */
pre.pygments .tok-fm { color: #0000FF } /* Name.Function.Magic */
pre.pygments .tok-vc { color: #19177C } /* Name.Variable.Class */
pre.pygments .tok-vg { color: #19177C } /* Name.Variable.Global */
pre.pygments .tok-vi { color: #19177C } /* Name.Variable.Instance */
pre.pygments .tok-vm { color: #19177C } /* Name.Variable.Magic */
pre.pygments .tok-il { color: #666666 } /* Literal.Number.Integer.Long */
</style>
</head>
<body class="book toc2 toc-left">
<div id="header">
<h1>openQA Documentation</h1>
<div class="details">
<span id="author" class="author">openQA Team</span><br>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel0">
<li><a href="#gettingstarted">openQA starter guide</a>
<ul class="sectlevel1">
<li><a href="#_introduction">Introduction</a></li>
<li><a href="#_architecture">Architecture</a></li>
<li><a href="#_basic_concepts">Basic concepts</a>
<ul class="sectlevel2">
<li><a href="#concepts">Glossary</a></li>
<li><a href="#_jobs">Jobs</a></li>
<li><a href="#_needles">Needles</a>
<ul class="sectlevel3">
<li><a href="#_areas">Areas</a></li>
</ul>
</li>
<li><a href="#_access_management">Access management</a></li>
<li><a href="#_job_groups">Job groups</a></li>
<li><a href="#_cleanup">Cleanup</a></li>
</ul>
</li>
<li><a href="#_using_the_client_script">Using the client script</a></li>
<li><a href="#get-testing">Testing openSUSE or Fedora</a>
<ul class="sectlevel2">
<li><a href="#_getting_tests">Getting tests</a></li>
<li><a href="#_getting_openqa_configuration">Getting openQA configuration</a></li>
<li><a href="#_adding_a_new_iso_to_test">Adding a new ISO to test</a></li>
</ul>
</li>
<li><a href="#_pitfalls">Pitfalls</a></li>
</ul>
</li>
<li><a href="#installing">openQA installation guide</a>
<ul class="sectlevel1">
<li><a href="#_introduction_2">Introduction</a></li>
<li><a href="#bootstrapping">Quick bootstrapping under openSUSE</a>
<ul class="sectlevel2">
<li><a href="#_directly_on_your_machine">Directly on your machine</a></li>
<li><a href="#_openqa_in_a_container">openQA in a container</a></li>
</ul>
</li>
<li><a href="#_container_based_setup">Container based setup</a></li>
<li><a href="#_custom_installation_repositories_and_procedure">Custom installation - repositories and procedure</a>
<ul class="sectlevel2">
<li><a href="#_official_repositories">Official repositories</a></li>
<li><a href="#_development_version_repository">Development version repository</a></li>
<li><a href="#_installation">Installation</a></li>
</ul>
</li>
<li><a href="#_system_requirements">System requirements</a></li>
<li><a href="#_basic_configuration">Basic configuration</a>
<ul class="sectlevel2">
<li><a href="#_apache_proxy">Apache proxy</a></li>
<li><a href="#_tlsssl">TLS/SSL</a></li>
<li><a href="#database">Database</a>
<ul class="sectlevel3">
<li><a href="#_example_for_connecting_to_local_postgresql_database">Example for connecting to local PostgreSQL database</a></li>
<li><a href="#_example_for_connecting_to_remote_postgresql_database">Example for connecting to remote PostgreSQL database</a></li>
</ul>
</li>
<li><a href="#authentication">User authentication</a>
<ul class="sectlevel3">
<li><a href="#_openid">OpenID</a></li>
<li><a href="#_oauth2">OAuth2</a></li>
<li><a href="#_fake">Fake</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_run_the_web_ui">Run the web UI</a></li>
<li><a href="#_run_openqa_workers">Run openQA workers</a></li>
<li><a href="#_where_to_now">Where to now?</a></li>
<li><a href="#_advanced_configuration">Advanced configuration</a>
<ul class="sectlevel2">
<li><a href="#advanced">Setting up git support</a></li>
<li><a href="#_referer_settings_to_auto_mark_important_jobs">Referer settings to auto-mark important jobs</a></li>
<li><a href="#_worker_settings">Worker settings</a></li>
<li><a href="#_further_systemd_units_for_the_worker">Further systemd units for the worker</a>
<ul class="sectlevel3">
<li><a href="#_stoppingrestarting_workers_without_interrupting_currently_running_jobs">Stopping/restarting workers without interrupting currently running jobs</a></li>
</ul>
</li>
<li><a href="#_configuring_remote_workers">Configuring remote workers</a></li>
<li><a href="#_configuring_amqp_message_emission">Configuring AMQP message emission</a></li>
<li><a href="#_configuring_worker_to_use_more_than_one_openqa_server">Configuring worker to use more than one openQA server</a></li>
<li><a href="#asset-caching">Asset Caching</a></li>
<li><a href="#_enable_linking_files_referred_by_job_settings">Enable linking files referred by job settings</a></li>
<li><a href="#_enable_custom_hook_scripts_on_job_done_based_on_result">Enable custom hook scripts on "job done" based on result</a></li>
<li><a href="#_automatic_cloning_of_incomplete_jobs">Automatic cloning of incomplete jobs</a></li>
</ul>
</li>
<li><a href="#_auditing_tracking_openqa_changes">Auditing - tracking openQA changes</a>
<ul class="sectlevel2">
<li><a href="#_list_of_events_tracked_by_the_auditing_plugin">List of events tracked by the auditing plugin</a></li>
</ul>
</li>
<li><a href="#_automatic_system_upgrades_and_reboots_of_openqa_hosts">Automatic system upgrades and reboots of openQA hosts</a></li>
<li><a href="#_filesystem_layout">Filesystem layout</a>
<ul class="sectlevel2">
<li><a href="#_terms_and_variables_for_certain_directories_used_by_openqa_and_isotovideo">Terms and variables for certain directories used by openQA and isotovideo</a>
<ul class="sectlevel3">
<li><a href="#_further_notes">Further notes</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_automatic_installation_of_the_operating_systems_for_openqa_machines">Automatic installation of the operating systems for openQA machines</a></li>
<li><a href="#_troubleshooting">Troubleshooting</a>
<ul class="sectlevel2">
<li><a href="#troubleshooting">Tests fail quickly</a></li>
<li><a href="#_kvm_doesnt_work">KVM doesn&#8217;t work</a></li>
<li><a href="#_openid_login_times_out">openid login times out</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#usersguide">openQA users guide</a>
<ul class="sectlevel1">
<li><a href="#_introduction_3">Introduction</a></li>
<li><a href="#_using_job_templates_to_automate_jobs_creation">Using job templates to automate jobs creation</a>
<ul class="sectlevel2">
<li><a href="#job_templates">The problem</a></li>
<li><a href="#_machines">Machines</a></li>
<li><a href="#_medium_types_products">Medium Types (products)</a></li>
<li><a href="#_test_suites">Test Suites</a></li>
<li><a href="#_job_groups_2">Job Groups</a></li>
<li><a href="#_variable_expansion">Variable expansion</a></li>
<li><a href="#_variable_precedence">Variable precedence</a></li>
</ul>
</li>
<li><a href="#_use_of_the_web_interface">Use of the web interface</a>
<ul class="sectlevel2">
<li><a href="#_description_of_test_suites">Description of test suites</a></li>
<li><a href="#_testsoverview_customizable_test_overview_page">/tests/overview - Customizable test overview page</a></li>
<li><a href="#_review_badges">Review badges</a>
<ul class="sectlevel3">
<li><a href="#_meaning_of_the_different_colors">Meaning of the different colors</a></li>
</ul>
</li>
<li><a href="#_show_bug_or_label_icon_on_overview_if_labeled_gh550">Show bug or label icon on overview if labeled gh#550</a></li>
<li><a href="#_distinguish_product_and_test_issues_bugref_gh708">Distinguish product and test issues bugref gh#708</a></li>
<li><a href="#_build_tagging">Build tagging</a>
<ul class="sectlevel3">
<li><a href="#_tag_builds_with_special_comments_on_group_overview">Tag builds with special comments on group overview</a></li>
<li><a href="#_keeping_important_builds">Keeping important builds</a></li>
</ul>
</li>
<li><a href="#_filtering_test_results_and_builds">Filtering test results and builds</a></li>
<li><a href="#_highlighting_job_dependencies_in_all_tests_table">Highlighting job dependencies in 'All tests' table</a></li>
<li><a href="#_show_previous_results_in_test_results_page_gh538">Show previous results in test results page gh#538</a></li>
<li><a href="#_link_to_latest_in_scenario_name_gh836">Link to latest in scenario name gh#836</a></li>
<li><a href="#_add_latest_query_route_gh815">Add `latest' query route gh#815</a></li>
<li><a href="#_allow_group_overview_query_by_result_gh531">Allow group overview query by result gh#531</a></li>
<li><a href="#_add_web_ui_controls_to_select_more_builds_in_group_overview_gh804">Add web UI controls to select more builds in group_overview gh#804</a></li>
<li><a href="#_more_query_parameters_for_configuring_last_builds_gh575">More query parameters for configuring last builds gh#575</a></li>
<li><a href="#_web_ui_controls_to_filter_only_tagged_or_all_builds_gh807">Web UI controls to filter only tagged or all builds gh#807</a></li>
<li><a href="#_carry_over_bugrefs_from_previous_jobs_in_same_scenario_if_still_failing_gh564">Carry over bugrefs from previous jobs in same scenario if still failing gh#564</a></li>
<li><a href="#_pinning_comments_as_group_description">Pinning comments as group description</a></li>
<li><a href="#_developer_mode">Developer mode</a>
<ul class="sectlevel3">
<li><a href="#_workflow_for_creating_or_updating_needles">Workflow for creating or updating needles</a></li>
</ul>
</li>
<li><a href="#_job_group_editor_gh2111">Job group editor gh#2111</a>
<ul class="sectlevel3">
<li><a href="#_yaml_job_templates_editor">YAML job templates editor</a></li>
<li><a href="#_deprecated_table_based_pre_migration">Deprecated: Table-based (pre-migration)</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_configuring_job_groups_via_yaml_documents">Configuring job groups via YAML documents</a>
<ul class="sectlevel2">
<li><a href="#_defaults">Defaults</a></li>
<li><a href="#_yaml_aliases">YAML Aliases</a></li>
<li><a href="#_yaml_merge_keys">YAML Merge Keys</a></li>
<li><a href="#_general_yaml_documentation">General YAML documentation</a></li>
</ul>
</li>
<li><a href="#_use_of_the_rest_api">Use of the REST API</a>
<ul class="sectlevel2">
<li><a href="#_finding_tests">Finding tests</a>
<ul class="sectlevel3">
<li><a href="#_remarks">Remarks</a></li>
</ul>
</li>
<li><a href="#_triggering_tests">Triggering tests</a>
<ul class="sectlevel3">
<li><a href="#_cloning_existing_jobs_openqa_clone_job">Cloning existing jobs - openqa-clone-job</a></li>
<li><a href="#_spawning_single_new_jobs_jobs_post">Spawning single new jobs - jobs post</a></li>
<li><a href="#_spawning_multiple_jobs_based_on_templates_isos_post">Spawning multiple jobs based on templates - isos post</a></li>
<li><a href="#_remarks_2">Remarks</a></li>
</ul>
</li>
<li><a href="#_job_template_yaml">Job template YAML</a></li>
</ul>
</li>
<li><a href="#_asset_handling">Asset handling</a>
<ul class="sectlevel2">
<li><a href="#_asset_cleanup">Asset cleanup</a>
<ul class="sectlevel3">
<li><a href="#_cleanup_strategy">Cleanup strategy</a></li>
</ul>
</li>
<li><a href="#_configure_limit_for_assets_within_job_groups">Configure limit for assets within job groups</a></li>
<li><a href="#_configure_limit_for_groupless_assets">Configure limit for groupless assets</a></li>
</ul>
</li>
<li><a href="#_cli_interface">CLI interface</a></li>
<li><a href="#_where_to_now_2">Where to now?</a></li>
</ul>
</li>
<li><a href="#writingtests">openQA tests developer guide</a>
<ul class="sectlevel1">
<li><a href="#_introduction_4">Introduction</a></li>
<li><a href="#_basic">Basic</a></li>
<li><a href="#_api">API</a></li>
<li><a href="#_how_to_write_tests">How to write tests</a>
<ul class="sectlevel2">
<li><a href="#_test_case_examples">Test Case Examples</a></li>
</ul>
</li>
<li><a href="#_variables">Variables</a></li>
<li><a href="#_advanced_test_features">Advanced test features</a>
<ul class="sectlevel2">
<li><a href="#_changing_timeouts">Changing timeouts</a></li>
<li><a href="#_capturing_kernel_exceptions_andor_any_other_exceptions_from_the_serial_console">Capturing kernel exceptions and/or any other exceptions from the serial console</a></li>
<li><a href="#_assigning_jobs_to_workers">Assigning jobs to workers</a></li>
<li><a href="#_writing_multi_machine_tests">Writing multi-machine tests</a>
<ul class="sectlevel3">
<li><a href="#_job_dependencies">Job dependencies</a>
<ul class="sectlevel4">
<li><a href="#_dependency_types">Dependency types</a>
<ul class="sectlevel5">
<li><a href="#_chained_dependencies">Chained dependencies</a></li>
<li><a href="#_parallel_dependencies">Parallel dependencies</a></li>
</ul>
</li>
<li><a href="#_inter_machine_dependencies">Inter-machine dependencies</a></li>
<li><a href="#_handling_of_related_jobs_on_failure_cancellation_restart">Handling of related jobs on failure / cancellation / restart</a>
<ul class="sectlevel5">
<li><a href="#_further_notes_2">Further notes</a></li>
</ul>
</li>
<li><a href="#_examples">Examples</a>
<ul class="sectlevel5">
<li><a href="#_specify_machine_explicitly">Specify machine explicitly</a></li>
<li><a href="#_implicitly_inherit_machines_from_parent">Implicitly inherit machines from parent</a></li>
<li><a href="#_conflicting_machines_prevent_inheritance_from_parent">Conflicting machines prevent inheritance from parent</a></li>
<li><a href="#_implicitly_creating_a_dependency_on_same_machine">Implicitly creating a dependency on same machine</a></li>
</ul>
</li>
<li><a href="#_notes_regarding_directly_chained_dependencies">Notes regarding directly chained dependencies</a></li>
<li><a href="#_worker_requirements">Worker requirements</a>
<ul class="sectlevel5">
<li><a href="#_examples_2">Examples</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#_test_synchronization_and_locking_api">Test synchronization and locking API</a></li>
<li><a href="#_support_server_based_tests">Support Server based tests</a>
<ul class="sectlevel3">
<li><a href="#_preparing_the_supportserver">Preparing the supportserver</a></li>
<li><a href="#_using_the_supportserver">Using the supportserver</a></li>
</ul>
</li>
<li><a href="#_using_text_consoles_and_the_serial_terminal">Using text consoles and the serial terminal</a>
<ul class="sectlevel3">
<li><a href="#_using_a_serial_terminal">Using a serial terminal</a></li>
<li><a href="#_sending_new_lines_and_continuation_characters">Sending new lines and continuation characters</a></li>
<li><a href="#_sending_signals_ctrl_c_and_ctrl_d">Sending signals - ctrl-c and ctrl-d</a></li>
<li><a href="#_the_virtio_serial_terminal_implementation">The virtio serial terminal implementation</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_test_development_tricks">Test Development tricks</a>
<ul class="sectlevel2">
<li><a href="#_trigger_new_tests_by_modifying_settings_from_existing_test_runs">Trigger new tests by modifying settings from existing test runs</a></li>
<li><a href="#_backend_variables_for_faster_test_execution">Backend variables for faster test execution</a></li>
<li><a href="#_using_snapshots_to_speed_up_development_of_tests">Using snapshots to speed up development of tests</a>
<ul class="sectlevel3">
<li><a href="#snapshots-for-each-module">Enable snapshots for each module</a></li>
<li><a href="#_storing_only_the_last_successful_snapshot">Storing only the last successful snapshot</a></li>
</ul>
</li>
<li><a href="#_defining_a_custom_test_schedule_or_custom_test_modules">Defining a custom test schedule or custom test modules</a>
<ul class="sectlevel3">
<li><a href="#_exclude_modules">EXCLUDE_MODULES</a></li>
<li><a href="#_include_modules">INCLUDE_MODULES</a></li>
<li><a href="#_schedule">SCHEDULE</a></li>
<li><a href="#_schedule_asset_nr_url">SCHEDULE + ASSET_&lt;NR&gt;_URL</a></li>
</ul>
</li>
<li><a href="#_triggering_tests_based_on_an_any_remote_git_refspec_or_open_github_pull_request">Triggering tests based on an any remote git refspec or open github pull request</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#installing_harness">openQA test harness result processing</a>
<ul class="sectlevel1">
<li><a href="#_introduction_5">Introduction</a></li>
<li><a href="#_usage">Usage</a>
<ul class="sectlevel2">
<li><a href="#_openqa_test_distribution">openQA test distribution</a></li>
</ul>
</li>
<li><a href="#parser-formats">Available parser formats</a></li>
<li><a href="#_extending_the_parser">Extending the parser</a>
<ul class="sectlevel2">
<li><a href="#_oop_interface">OOP Interface</a></li>
<li><a href="#_structured_data">Structured data</a></li>
<li><a href="#_openqa_internal_test_result_storage">openQA internal test result storage</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#client">openQA client</a>
<ul class="sectlevel1">
<li><a href="#_help">Help</a></li>
<li><a href="#_authentication">Authentication</a>
<ul class="sectlevel2">
<li><a href="#_personal_access_token">Personal access token</a></li>
</ul>
</li>
<li><a href="#_features">Features</a>
<ul class="sectlevel2">
<li><a href="#_http_methods">HTTP Methods</a></li>
<li><a href="#_http_headers">HTTP Headers</a></li>
<li><a href="#_http_body">HTTP Body</a></li>
<li><a href="#_forms">Forms</a></li>
<li><a href="#_json">JSON</a></li>
<li><a href="#_unicode">Unicode</a></li>
<li><a href="#_host_shortcuts">Host shortcuts</a></li>
<li><a href="#_debugging">Debugging</a></li>
</ul>
</li>
<li><a href="#_archive_mode">Archive mode</a></li>
</ul>
</li>
<li><a href="#pitfalls">openQA pitfalls</a>
<ul class="sectlevel1">
<li><a href="#_needle_editing">Needle editing</a></li>
<li><a href="#_403_messages_when_using_scripts">403 messages when using scripts</a></li>
<li><a href="#_mixed_production_and_development_environment">Mixed production and development environment</a></li>
<li><a href="#_performance_impact">Performance impact</a></li>
<li><a href="#db-migration">DB migration from SQlite to postgreSQL</a></li>
<li><a href="#debugdevelmode">Steps to debug developer mode setup</a></li>
</ul>
</li>
<li><a href="#networking">Networking in OpenQA</a>
<ul class="sectlevel1">
<li><a href="#_qemu_user_networking">QEMU User Networking</a></li>
<li><a href="#_tap_based_network">TAP Based Network</a>
<ul class="sectlevel2">
<li><a href="#_multi_machine_tests_setup">Multi Machine Tests Setup</a></li>
<li><a href="#_debugging_open_vswitch_configuration">Debugging Open vSwitch Configuration</a></li>
<li><a href="#_gre_tunnels">GRE Tunnels</a></li>
</ul>
</li>
<li><a href="#_vde_based_network">VDE Based Network</a>
<ul class="sectlevel2">
<li><a href="#_basic_single_machine_tests">Basic, Single Machine Tests</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#contributing">openQA developer guide</a>
<ul class="sectlevel1">
<li><a href="#_introduction_6">Introduction</a></li>
<li><a href="#_development_guidelines">Development guidelines</a>
<ul class="sectlevel2">
<li><a href="#repo-urls">Repository URLs</a></li>
<li><a href="#_rules_for_commits">Rules for commits</a></li>
<li><a href="#_code_style_suggestions">Code style suggestions</a></li>
</ul>
</li>
<li><a href="#_getting_involved_into_development">Getting involved into development</a></li>
<li><a href="#_technologies">Technologies</a></li>
<li><a href="#_folder_structure">Folder structure</a></li>
<li><a href="#development-setup">Development setup</a>
<ul class="sectlevel2">
<li><a href="#testing">Conducting tests</a></li>
<li><a href="#dependencies">Dependencies</a></li>
<li><a href="#setup-postgresql">Setting up the PostgreSQL database</a>
<ul class="sectlevel3">
<li><a href="#_importing_production_data">Importing production data</a></li>
</ul>
</li>
<li><a href="#_manual_daemon_setup">Manual daemon setup</a>
<ul class="sectlevel3">
<li><a href="#_further_tips">Further tips</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#dependency-handling">Handling of dependencies</a>
<ul class="sectlevel2">
<li><a href="#_javascript_and_css">Javascript and CSS</a></li>
<li><a href="#_perl_and_other_packages">Perl and other packages</a></li>
<li><a href="#_remarks_regarding_ci">Remarks regarding CI</a></li>
<li><a href="#update-asset-cache">Update asset cache for openSUSE RPM package</a></li>
</ul>
</li>
<li><a href="#_managing_the_database">Managing the database</a>
<ul class="sectlevel2">
<li><a href="#_when_is_it_required_to_update_the_database_schema">When is it required to update the database schema?</a></li>
<li><a href="#_how_to_update_the_database_schema">How to update the database schema</a></li>
<li><a href="#_how_to_add_fixtures_to_the_database">How to add fixtures to the database</a></li>
</ul>
</li>
<li><a href="#_how_to_overwrite_config_files">How to overwrite config files</a></li>
<li><a href="#_adding_new_authentication_module">Adding new authentication module</a></li>
<li><a href="#_customize_base_directory">Customize base directory</a></li>
<li><a href="#_running_tests_of_openqa_itself">Running tests of openQA itself</a>
<ul class="sectlevel2">
<li><a href="#_run_tests_without_container">Run tests without container</a></li>
<li><a href="#_run_tests_with_docker">Run tests with Docker</a>
<ul class="sectlevel3">
<li><a href="#_tips">Tips</a></li>
</ul>
</li>
<li><a href="#_logging_behavior">Logging behavior</a></li>
<li><a href="#_test_runtime_limits">Test runtime limits</a></li>
</ul>
</li>
<li><a href="#circleci-workflow">CircleCI workflow</a>
<ul class="sectlevel2">
<li><a href="#_dependency_artefacts">Dependency artefacts</a></li>
<li><a href="#_managing_and_troubleshooting_dependencies">Managing and troubleshooting dependencies</a></li>
<li><a href="#circleci-local-docker">Run tests locally using Docker</a></li>
<li><a href="#_run_tests_using_the_circleci_tool">Run tests using the circleci tool</a></li>
<li><a href="#_changing_config_cnf">Changing config.cnf</a></li>
</ul>
</li>
<li><a href="#_building_plugins">Building plugins</a></li>
<li><a href="#_checking_for_javascript_problems">Checking for JavaScript problems</a></li>
<li><a href="#_profiling_the_web_ui">Profiling the web UI</a>
<ul class="sectlevel2">
<li><a href="#_note">Note</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#branding">openQA branding</a>
<ul class="sectlevel1">
<li><a href="#_web_ui_template">Web UI template</a></li>
</ul>
</li>
<li><a href="#containerizedsetup">Containerized setup</a>
<ul class="sectlevel1">
<li><a href="#_get_container_images">Get container images</a>
<ul class="sectlevel2">
<li><a href="#_download_fedora_based_images_from_the_docker_hub">Download Fedora-based images from the Docker Hub</a></li>
<li><a href="#_build_opensuse_based_images_locally">Build openSUSE-based images locally</a></li>
</ul>
</li>
<li><a href="#_setup_with_fedora_based_images">Setup with Fedora-based images</a></li>
<li><a href="#_data_storage_and_directory_structure">Data storage and directory structure</a>
<ul class="sectlevel2">
<li><a href="#_update_firewall_rules">Update firewall rules</a></li>
<li><a href="#_run_the_data_and_web_ui_containers">Run the data and web UI containers</a>
<ul class="sectlevel3">
<li><a href="#_generate_and_configure_api_credentials">Generate and configure API credentials</a></li>
</ul>
</li>
<li><a href="#_run_the_worker_container">Run the worker container</a></li>
<li><a href="#_enable_services">Enable services</a></li>
<li><a href="#_get_tests_isos_and_create_disks">Get tests, ISOs and create disks</a></li>
</ul>
</li>
<li><a href="#_setup_with_opensuse_based_images_and_docker_compose">Setup with openSUSE-based images and docker-compose</a>
<ul class="sectlevel2">
<li><a href="#_run_the_data_and_web_ui_containers_in_ha_mode">Run the data and web UI containers in HA mode</a>
<ul class="sectlevel3">
<li><a href="#_change_the_number_of_web_ui_replicas_optional">Change the number of web UI replicas (optional)</a></li>
<li><a href="#_change_the_exported_port_for_the_load_balancer_optional">Change the exported port for the load balancer (optional)</a></li>
<li><a href="#_enable_the_ssl_access_to_the_load_balancer_optional">Enable the SSL access to the load balancer (optional)</a></li>
<li><a href="#_generate_and_configure_api_credentials_2">Generate and configure API credentials</a></li>
</ul>
</li>
<li><a href="#_run_the_worker_container_2">Run the worker container</a>
<ul class="sectlevel3">
<li><a href="#_run_a_pool_of_workers_automatically">Run a pool of workers automatically</a></li>
</ul>
</li>
<li><a href="#_get_tests_isos_and_create_disks_2">Get tests, ISOs and create disks</a></li>
</ul>
</li>
<li><a href="#_running_jobs">Running jobs</a></li>
<li><a href="#_further_configuration_options">Further configuration options</a>
<ul class="sectlevel2">
<li><a href="#_change_the_openid_provider">Change the OpenID provider</a></li>
<li><a href="#_adding_workers_on_other_hosts">Adding workers on other hosts</a></li>
<li><a href="#_keeping_all_data_in_the_data_volume_container">Keeping all data in the Data Volume container</a></li>
<li><a href="#_keeping_all_data_on_the_host_system">Keeping all data on the host system</a></li>
<li><a href="#_developing_tests_with_container_setup">Developing tests with container setup</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<!-- toc disabled -->
</div>
</div>
<h1 id="gettingstarted" class="sect0">openQA starter guide</h1>
<div class="sect1">
<h2 id="_introduction">Introduction</h2>
<div class="sectionbody">
<div class="paragraph">
<p>openQA is an automated test tool that makes it possible to test the whole
installation process of an operating system. It uses virtual machines to
reproduce the process, check the output (both serial console and
screen) in every step and send the necessary keystrokes and commands to
proceed to the next. openQA can check whether the system can be installed,
whether it works properly in 'live' mode, whether applications work
or whether the system responds as expected to different installation options and
commands.</p>
</div>
<div class="paragraph">
<p>Even more importantly, openQA can run several combinations of tests for every
revision of the operating system, reporting the errors detected for each
combination of hardware configuration, installation options and variant of the
operating system.</p>
</div>
<div class="paragraph">
<p>openQA is free software released under the
<a href="http://www.gnu.org/licenses/gpl-2.0.html">GPLv2 license</a>. The source code and
documentation are hosted in the <a href="https://github.com/os-autoinst">os-autoinst
organization on GitHub</a>.</p>
</div>
<div class="paragraph">
<p>This document describes the general operation and usage of openQA. The main goal
is to provide a general overview of the tool, with all the information needed to
become a happy user.</p>
</div>
<div class="paragraph">
<p>For a quick start, if you already have an openQA instance available you can
refer to the section
<a href="#_cloning_existing_jobs_openqa_clone_job">Cloning existing jobs - openqa-clone-job</a>
directly to trigger a new test based on already existing job. For a quick
installation refer directly to
<a href="#_openqa_quick_bootstrap">openQA quick bootstrap</a>.</p>
</div>
<div class="paragraph">
<p>For the installation of openQA in general see the
<a href="#installing">Installation Guide</a>, as a user of an
existing instance see the <a href="#usersguide">Users Guide</a>.
More advanced topics can be found in other documents. All documents are also
available in the <a href="https://github.com/os-autoinst/openQA">official repository</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_architecture">Architecture</h2>
<div class="sectionbody">
<div id="architecture" class="paragraph">
<p>Although the project as a whole is referred to as openQA, there are in fact
several components that are hosted in separate repositories as shown in
<a href="#arch_img">the following figure</a>.</p>
</div>
<div id="arch_img" class="imageblock">
<div class="content">
<img src="images/openqa_architecture.png" alt="openQA architecture">
</div>
<div class="title">Figure 1. openQA architecture</div>
</div>
<div class="paragraph">
<p>The heart of the test engine is a standalone application called 'os-autoinst'
(blue). In each execution, this application creates a virtual machine and uses
it to run a set of test scripts (red).  'os-autoinst' generates a video,
screenshots and a JSON file with detailed results.</p>
</div>
<div class="paragraph">
<p>'openQA' (green) on the other hand provides a web based user interface and
infrastructure to run 'os-autoinst' in a distributed way. The web interface
also provides a JSON based REST-like API for external scripting and for use by
the worker program. Workers fetch data and input files from openQA for
os-autoinst to run the tests. A host system can run several workers. The openQA
web application takes care of distributing test jobs among workers. Web
application and workers can run on the same machine as well as connected via
network on multiple machines within the same network or distributed. Running
the web application as well as the workers in the cloud is perfectly possible.</p>
</div>
<div class="paragraph">
<p>Note that the diagram shown above is simplified. There exists
<a href="images/architecture.svg">a more sophisticated version</a> which is more
complete and detailed. (The diagram can be edited via its underlying
<a href="images/architecture.graphml">GraphML file</a>.)</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_basic_concepts">Basic concepts</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="concepts">Glossary</h3>
<div class="hdlist">
<div class="title">The following terms are used within the context of openQA</div>
<table>
<tr>
<td class="hdlist1">
test modules
</td>
<td class="hdlist2">
<p>an individual test case in a single perl module file, e.g.
"sshxterm". If not further specified a test module is denoted with its "short
name" equivalent to the filename including the test definition. The "full name"
is composed of the <em>test group</em> (TBC), which itself is formed by the top-folder
of the test module file, and the short name, e.g. "x11-sshxterm" (for
x11/sshxterm.pm)</p>
</td>
</tr>
<tr>
<td class="hdlist1">
test suite
</td>
<td class="hdlist2">
<p>a collection of <em>test modules</em>, e.g. "textmode". All <em>test
modules</em> within one <em>test suite</em> are run serially</p>
</td>
</tr>
<tr>
<td class="hdlist1">
job
</td>
<td class="hdlist2">
<p>one run of individual test cases in a row denoted by a unique number for
one instance of openQA, e.g. one installation with subsequent testing of
applications within gnome</p>
</td>
</tr>
<tr>
<td class="hdlist1">
test run
</td>
<td class="hdlist2">
<p>equivalent to <em>job</em></p>
</td>
</tr>
<tr>
<td class="hdlist1">
test result
</td>
<td class="hdlist2">
<p>the result of one job, e.g. "passed" with the details of each
individual <em>test module</em></p>
</td>
</tr>
<tr>
<td class="hdlist1">
test step
</td>
<td class="hdlist2">
<p>the execution of one <em>test module</em> within a <em>job</em></p>
</td>
</tr>
<tr>
<td class="hdlist1">
distri
</td>
<td class="hdlist2">
<p>a test distribution but also sometimes referring to a <em>product</em>
(CAUTION: ambiguous, historically a "GNU/Linux distribution"), composed of
multiple <em>test modules</em> in a folder structure that compose <em>test suites</em>, e.g.
"opensuse" (test distribution, short for "os-autoinst-distri-opensuse")</p>
</td>
</tr>
<tr>
<td class="hdlist1">
product
</td>
<td class="hdlist2">
<p>the main "system under test" (SUT), e.g. "openSUSE", also called
"Medium Types" in the web interface of openQA</p>
</td>
</tr>
<tr>
<td class="hdlist1">
job group
</td>
<td class="hdlist2">
<p>equivalent to <em>product</em>, used in context of the webUI</p>
</td>
</tr>
<tr>
<td class="hdlist1">
version
</td>
<td class="hdlist2">
<p>one version of a <em>product</em>, don&#8217;t confuse with <em>builds</em>, e.g.
"Tumbleweed"</p>
</td>
</tr>
<tr>
<td class="hdlist1">
flavor
</td>
<td class="hdlist2">
<p>a specific variant of a <em>product</em> to distinguish differing variants,
e.g. "DVD"</p>
</td>
</tr>
<tr>
<td class="hdlist1">
arch
</td>
<td class="hdlist2">
<p>an architecture variant of a <em>product</em>, e.g. "x86_64"</p>
</td>
</tr>
<tr>
<td class="hdlist1">
machine
</td>
<td class="hdlist2">
<p>additional variant of machine, e.g. used for "64bit", "uefi", etc.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
scenario
</td>
<td class="hdlist2">
<p>A composition of
<code>&lt;distri&gt;-&lt;version&gt;-&lt;flavor&gt;-&lt;arch&gt;-&lt;test_suite&gt;@&lt;machine&gt;</code>, e.g.
"openSUSE-Tumbleweed-DVD-x86_64-gnome@64bit", nicknamed <em>koala</em></p>
</td>
</tr>
<tr>
<td class="hdlist1">
build
</td>
<td class="hdlist2">
<p>Different versions of a product as tested, can be considered a
"sub-version" of <em>version</em>, e.g. "Build1234"; <strong>CAUTION:</strong> ambiguity: either with
the prefix "Build" included or not</p>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_jobs">Jobs</h3>
<div class="paragraph">
<p>One of the most important features of openQA is that it can be used to test
several combinations of actions and configurations. For every one of those
combinations, the system creates a virtual machine, performs certain steps and
returns an overall result. Every one of those executions is called a 'job'.
Every job is labeled with a numeric identifier and has several associated
'settings' that will drive its behavior.</p>
</div>
<div class="paragraph">
<p>A job goes through several states. Here is (an incomplete list) of these
states:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>scheduled</strong> Initial state for newly created jobs. Queued for future
execution.</p>
</li>
<li>
<p><strong>setup</strong>/<strong>running</strong>/<strong>uploading</strong> In progress.</p>
</li>
<li>
<p><strong>cancelled</strong> The job was explicitly cancelled by the user or was
replaced by a clone (see below) and the worker has not acknowledged the
cancellation yet.</p>
</li>
<li>
<p><strong>done</strong> The worker acknowledged that the execution finished or the web UI
considers the job as abandoned by the worker.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Jobs in the final states 'cancelled' and 'done' have typically gone through a
whole sequence of steps (called 'testmodules') each one with its own result.
But in addition to those partial results, a finished job also provides an
overall result from the following list.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>none</strong> For jobs that have not reached one of the final states.</p>
</li>
<li>
<p><strong>passed</strong> No critical check failed during the process. It does not necessarily
mean that all testmodules were successful or that no single assertion failed.</p>
</li>
<li>
<p><strong>failed</strong> At least one assertion considered to be critical was not satisfied at some
point.</p>
</li>
<li>
<p><strong>softfailed</strong> At least one known, non-critical issue has been found. That could be
that workaround needles are in place, a softfailure has been recorded explicitly
via <code>record_soft_failure</code> (from os-autoinst) or a job failure has been ignored
explicitly via a <a href="#_show_bug_or_label_icon_on_overview_if_labeled_gh550">job label</a>.</p>
</li>
<li>
<p><strong>timeout_exceeded</strong> The job was aborted because <code>MAX_JOB_TIME</code> or <code>MAX_SETUP_TIME</code>
has been exceeded, see <a href="#_changing_timeout">Changing timeout</a> for details.</p>
</li>
<li>
<p><strong>skipped</strong> Dependencies failed so the job was not started.</p>
</li>
<li>
<p><strong>obsoleted</strong> The job was superseded by scheduling a new product.</p>
</li>
<li>
<p><strong>parallel_failed</strong>/<strong>parallel_restarted</strong> The job could not continue because a job
which is supposed to run in parallel failed or was restarted.</p>
</li>
<li>
<p><strong>user_cancelled</strong>/<strong>user_restarted</strong> The job was cancelled/restarted by the user.</p>
</li>
<li>
<p><strong>incomplete</strong> The test execution failed due to an unexpected error, e.g. the network
connection to the worker was lost.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Sometimes, the reason of a failure is not an error in the tested operating system
itself, but an outdated test or a problem in the execution of the job for some
external reason. In those situations, it makes sense to re-run a given job from
the beginning once the problem is fixed or the tests have been updated.
This is done by means of 'cloning'. Every job can be superseded by a clone which
is scheduled to run with exactly the same settings as the original job. If the
original job is still not in 'done' state, it&#8217;s cancelled immediately.
From that point in time, the clone becomes the current version and the original
job is considered outdated (and can be filtered in the listing) but its
information and results (if any) are kept for future reference.</p>
</div>
</div>
<div class="sect2">
<h3 id="_needles">Needles</h3>
<div class="paragraph">
<p>One of the main mechanisms for openQA to know the state of the virtual machine
is checking the presence of some elements in the machine&#8217;s 'screen'.
This is performed using fuzzy image matching between the screen and the so
called 'needles'. A needle specifies both the elements to search for and a
list of tags used to decide which needles should be used at any moment.</p>
</div>
<div class="paragraph">
<p>A needle consists of a full screenshot in PNG format and a json file with
the same name (e.g. foo.png and foo.json) containing the associated data, like
which areas inside the full screenshot are relevant or the mentioned list of
tags.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="json"><span></span><span class="tok-p">{</span>
   <span class="tok-nt">&quot;area&quot;</span> <span class="tok-p">:</span> <span class="tok-p">[</span>
      <span class="tok-p">{</span>
         <span class="tok-nt">&quot;xpos&quot;</span> <span class="tok-p">:</span> <span class="tok-err">INTEGER</span><span class="tok-p">,</span>
         <span class="tok-nt">&quot;ypos&quot;</span> <span class="tok-p">:</span> <span class="tok-err">INTEGER</span><span class="tok-p">,</span>
         <span class="tok-nt">&quot;width&quot;</span> <span class="tok-p">:</span> <span class="tok-err">INTEGER</span><span class="tok-p">,</span>
         <span class="tok-nt">&quot;height&quot;</span> <span class="tok-p">:</span> <span class="tok-err">INTEGER</span><span class="tok-p">,</span>
         <span class="tok-nt">&quot;type&quot;</span> <span class="tok-p">:</span> <span class="tok-err">(</span> <span class="tok-s2">&quot;match&quot;</span> <span class="tok-err">|</span> <span class="tok-s2">&quot;ocr&quot;</span> <span class="tok-err">|</span> <span class="tok-s2">&quot;exclude&quot;</span> <span class="tok-err">)</span><span class="tok-p">,</span>
         <span class="tok-nt">&quot;match&quot;</span> <span class="tok-p">:</span> <span class="tok-err">INTEGER</span><span class="tok-p">,</span> <span class="tok-err">//</span> <span class="tok-mf">0-100.</span> <span class="tok-err">similari</span><span class="tok-kc">t</span><span class="tok-err">y</span> <span class="tok-err">perce</span><span class="tok-kc">nta</span><span class="tok-err">ge</span>
      <span class="tok-p">},</span>
      <span class="tok-err">...</span>
   <span class="tok-p">],</span>
   <span class="tok-nt">&quot;tags&quot;</span> <span class="tok-p">:</span> <span class="tok-p">[</span>
      <span class="tok-err">STRING</span><span class="tok-p">,</span> <span class="tok-err">...</span>
   <span class="tok-p">]</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_areas">Areas</h4>
<div class="paragraph">
<p>There are three kinds of areas:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Regular areas</strong> define relevant parts of the screenshot. Those must match
with at least the specified similarity percentage. Regular areas are
displayed as green boxes in the needle editor and as green or red frames
in the needle view (green for matching areas, red for non-matching ones).</p>
</li>
<li>
<p><strong>OCR areas</strong> also define relevant parts of the screenshot. However, an OCR
algorithm is used for matching. In the needle editor OCR areas are
displayed as orange boxes. To turn a regular area into an OCR area within
the needle editor, double click the concerning area twice. Note that such
needles are only rarely used.</p>
</li>
<li>
<p><strong>Exclude areas</strong> can be used to ignore parts of the reference picture.
In the needle editor exclude areas are displayed as red boxes. To turn a
regular area into an exclude area within the needle editor, double click
the concerning area.
In the needle view exclude areas are displayed as gray boxes.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_access_management">Access management</h3>
<div class="paragraph">
<p>Some actions in openQA require special privileges. openQA provides
authentication through <a href="http://en.wikipedia.org/wiki/OpenID">openID</a>. By default,
openQA is configured to use the openSUSE openID provider, but it can very
easily be configured to use any other valid provider. Every time a new user logs
into an instance, a new user profile is created. That profile only
contains the openID identity and two flags used for access control:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>operator</strong> Means that the user is able to manage jobs, performing actions like
creating new jobs, cancelling them, etc.</p>
</li>
<li>
<p><strong>admin</strong> Means that the user is able to manage users (granting or revoking
operator and admin rights) as well as job templates and other related
information (see the <a href="#job_templates">the corresponding section</a>).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Many of the operations in an openQA instance are not performed through the web
interface but using the REST-like API. The most obvious examples are the
workers and the scripts that fetch new versions of the operating system and
schedule the corresponding tests. Those clients must be authorized by an
operator using an
<a href="http://en.wikipedia.org/wiki/Application_programming_interface_key">API key</a> with
an associated shared secret.</p>
</div>
<div class="paragraph">
<p>For that purpose, users with the operator flag have access in the web interface
to a page that allows them to manage as many API keys as they may need. For every
key, a secret is automatically generated. The user can then configure the
workers or any other client application to use whatever pair of API key and
secret owned by him. Any client to the REST-like API using one of those API keys
will be considered to be acting on behalf of the associated user. So the API key
not only has to be correct and valid (not expired), it also has to belong to a
user with operator rights.</p>
</div>
<div class="paragraph">
<p>For more insights about authentication, authorization and the technical details
of the openQA security model, refer to the
<a href="http://lizards.opensuse.org/2014/02/28/about-openqa-and-authentication/">detailed
blog post</a> about the subject by the openQA development team.</p>
</div>
</div>
<div class="sect2">
<h3 id="_job_groups">Job groups</h3>
<div class="paragraph">
<p>A job can belong to a job group. Those job groups are displayed on the index
page when there are recent test results in these job groups and in the <code>Job
Groups</code> menu on the navigation bar. From there the job group overview pages
can be accessed. Besides the test results the job group overview pages provide
a description about the job group and allow commenting.</p>
</div>
<div class="paragraph">
<p>Job groups have properties. These properties are mostly cleanup related. The
configuration can be done in the operators menu for job groups.</p>
</div>
<div class="paragraph">
<p>It is also possible to put job groups into categories. The nested groups will then
inherit properties from the category. The categories are meant to combine job groups
with common builds so test results for the same build can be shown together on
the index page.</p>
</div>
</div>
<div class="sect2">
<h3 id="_cleanup">Cleanup</h3>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
openQA automatically deletes data that it considers "old" based on
different settings. For example job data is deleted from old jobs by the <code>gru</code> task.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The following cleanup settings can be done on job-group-level:</p>
</div>
<div class="hdlist">
<table>
<tr>
<td class="hdlist1">
size limit
</td>
<td class="hdlist2">
<p>Limits size of assets</p>
</td>
</tr>
<tr>
<td class="hdlist1">
keep logs for
</td>
<td class="hdlist2">
<p>Specifies how long logs of a non-important job are retained after
it finished</p>
</td>
</tr>
<tr>
<td class="hdlist1">
keep important logs for
</td>
<td class="hdlist2">
<p>How long logs of an important job are retained after it
finished</p>
</td>
</tr>
<tr>
<td class="hdlist1">
keep results for
</td>
<td class="hdlist2">
<p>specifies How long results of a non-important job are retained
after it finished</p>
</td>
</tr>
<tr>
<td class="hdlist1">
keep important results for
</td>
<td class="hdlist2">
<p>How long results of an important job are retained after
it finished</p>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The defaults for those values are defined in
<a href="https://github.com/os-autoinst/openQA/blob/master/lib/OpenQA/JobGroupDefaults.pm">lib/OpenQA/JobGroupDefaults.pm</a>.</p>
</div>
<div class="paragraph">
<p><strong>NOTE</strong> Deletion of job results includes deletion of logs and will cause the job to
be completely removed from the database.</p>
</div>
<div class="paragraph">
<p><strong>NOTE</strong> Jobs which do not belong to a job group are currently not affected by
the mentioned cleanup properties.</p>
</div>
<div class="paragraph">
<p><strong>NOTE</strong> Archiving of important jobs can be enabled. Checkout the related settings
within the <code>[archiving]</code> section of the config file for details.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_using_the_client_script">Using the client script</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Just as the worker uses an API key+secret every user of the <code>client script</code>
must do the same. The same API key+secret as previously created can be used or
a new one created over the webUI.</p>
</div>
<div class="paragraph">
<p>The personal configuration should be stored in a file
<code>~/.config/openqa/client.conf</code> in the same format as previously described for
the <code>client.conf</code>, i.e. sections for each machine, e.g. <code>localhost</code>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="get-testing">Testing openSUSE or Fedora</h2>
<div class="sectionbody">
<div class="paragraph">
<p>An easy way to start using openQA is to start testing openSUSE or Fedora as they
have everything setup and prepared to ease the initial deployment. If you want
to play deeper, you can configure the whole openQA manually from scratch, but
this document should help you to get started faster.</p>
</div>
<div class="sect2">
<h3 id="_getting_tests">Getting tests</h3>
<div class="paragraph">
<p>First you need to get actual tests. You can get openSUSE tests and needles (the
expected results) from
<a href="https://github.com/os-autoinst/os-autoinst-distri-opensuse">GitHub</a>. It belongs
into the <code>/var/lib/openqa/tests/opensuse</code> directory. To make it easier, you can just
run</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span>/usr/share/openqa/script/fetchneedles</code></pre>
</div>
</div>
<div class="paragraph">
<p>Which will download the tests to the correct location and will set the correct
rights as well.</p>
</div>
<div class="paragraph">
<p>Fedora&#8217;s tests are also in <a href="https://pagure.io/fedora-qa/os-autoinst-distri-fedora">git</a>. To
use them, you may do:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span><span class="tok-nb">cd</span> /var/lib/openqa/share/tests
mkdir fedora
<span class="tok-nb">cd</span> fedora
git clone https://pagure.io/fedora-qa/os-autoinst-distri-fedora.git
./templates --clean
<span class="tok-nb">cd</span> ..
chown -R geekotest fedora/</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_getting_openqa_configuration">Getting openQA configuration</h3>
<div class="paragraph">
<p>To get everything configured to actually run the tests, there are plenty of
options to set in the admin interface. If you plan to test openSUSE Factory, using
tests mentioned in the previous section, the easiest way to get started is the
following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span>/var/lib/openqa/share/tests/opensuse/products/opensuse/templates <span class="tok-o">[</span>--apikey API_KEY<span class="tok-o">]</span> <span class="tok-o">[</span>--apisecret API_SECRET<span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This will load some default settings that were used at some point of time in
openSUSE production openQA. Therefore those should work reasonably well with
openSUSE tests and needles. This script uses <code>/usr/share/openqa/script/load_templates</code>,
consider reading its help page (<code>--help</code>) for documentation on possible extra arguments.</p>
</div>
<div class="paragraph">
<p>For Fedora, similarly, you can call:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span>/var/lib/openqa/share/tests/fedora/templates <span class="tok-o">[</span>--apikey API_KEY<span class="tok-o">]</span> <span class="tok-o">[</span>--apisecret API_SECRET<span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Some Fedora tests require special hard disk images to be present in
<code>/var/lib/openqa/share/factory/hdd/fixed</code>. The <code>createhdds.py</code> script in the
<a href="https://pagure.io/fedora-qa/createhdds">createhdds</a>
repository can be used to create these. See the documentation in that repo
for more information.</p>
</div>
</div>
<div class="sect2">
<h3 id="_adding_a_new_iso_to_test">Adding a new ISO to test</h3>
<div class="paragraph">
<p>To start testing a new ISO put it in <code>/var/lib/openqa/share/factory/iso</code> and call
the following commands:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span><span class="tok-c1"># Run the first test</span>
openqa-cli api -X POST isos <span class="tok-se">\</span>
         <span class="tok-nv">ISO</span><span class="tok-o">=</span>openSUSE-Factory-NET-x86_64-Build0053-Media.iso <span class="tok-se">\</span>
         <span class="tok-nv">DISTRI</span><span class="tok-o">=</span>opensuse <span class="tok-se">\</span>
         <span class="tok-nv">VERSION</span><span class="tok-o">=</span>Factory <span class="tok-se">\</span>
         <span class="tok-nv">FLAVOR</span><span class="tok-o">=</span>NET <span class="tok-se">\</span>
         <span class="tok-nv">ARCH</span><span class="tok-o">=</span>x86_64 <span class="tok-se">\</span>
         <span class="tok-nv">BUILD</span><span class="tok-o">=</span><span class="tok-m">0053</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If your openQA is not running on port 80 on 'localhost', you can add option
<code>--host=http://otherhost:9526</code> to specify a different port or host.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
Use only the ISO filename in the 'client' command. You must place the
file in <code>/var/lib/openqa/share/factory/iso</code>. You cannot place the file elsewhere and
specify its path in the command. However, openQA also supports a
remote-download feature of assets from trusted domains.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For Fedora, a sample run might be:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span><span class="tok-c1"># Run the first test</span>
openqa-cli api -X POST isos <span class="tok-se">\</span>
         <span class="tok-nv">ISO</span><span class="tok-o">=</span>Fedora-Everything-boot-x86_64-Rawhide-20160308.n.0.iso <span class="tok-se">\</span>
         <span class="tok-nv">DISTRI</span><span class="tok-o">=</span>fedora <span class="tok-se">\</span>
         <span class="tok-nv">VERSION</span><span class="tok-o">=</span>Rawhide <span class="tok-se">\</span>
         <span class="tok-nv">FLAVOR</span><span class="tok-o">=</span>Everything-boot-iso <span class="tok-se">\</span>
         <span class="tok-nv">ARCH</span><span class="tok-o">=</span>x86_64 <span class="tok-se">\</span>
         <span class="tok-nv">BUILD</span><span class="tok-o">=</span>Rawhide-20160308.n.0</code></pre>
</div>
</div>
<div class="paragraph">
<p>More details on triggering tests can also be found in the
<a href="#usersguide">Users Guide</a>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_pitfalls">Pitfalls</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Take a look at <a href="#pitfalls">Documented Pitfalls</a>.</p>
</div>
</div>
</div>
<h1 id="installing" class="sect0">openQA installation guide</h1>
<div class="sect1">
<h2 id="_introduction_2">Introduction</h2>
<div class="sectionbody">
<div class="paragraph">
<p>openQA is an automated test tool that makes it possible to test the whole
installation process of an operating system. It is free software released
under the <a href="http://www.gnu.org/licenses/gpl-2.0.html">GPLv2 license</a>. The source
code and documentation are hosted in the
<a href="https://github.com/os-autoinst">os-autoinst organization on GitHub</a>.</p>
</div>
<div class="paragraph">
<p>This document provides the information needed to install and setup the tool,
as well as information useful for everyday administration of the system. It is
assumed that the reader is already familiar with the concepts of openQA and
has already read the <a href="#gettingstarted">Getting Started
Guide</a>, also available at the <a href="https://github.com/os-autoinst/openQA">official
repository</a>.</p>
</div>
<div class="paragraph">
<p>Continue with the next section to get a simple, ready-to-use installation,
useful for a single user setup. To setup using containers follow the
<a href="#container_setup">Container based setup</a>. Else, continue with the more
advanced section about <a href="#custom_installation">Custom installation</a>. For a
setup suitable to develop openQA itself, have a look at the
<a href="#development-setup">Development setup</a> section.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="bootstrapping">Quick bootstrapping under openSUSE</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To quickly get a working openQA installation, you can use the openqa-bootstrap
script. It essentially automates the steps mentioned in the
<a href="#custom_installation">Custom installation</a> section.</p>
</div>
<div class="sect2">
<h3 id="_directly_on_your_machine">Directly on your machine</h3>
<div class="paragraph">
<p>On openSUSE Leap and openSUSE Tumbleweed to setup openQA on your machine
simply download and execute the openqa-bootstrap script as root - it will do
the rest for you:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span>curl -s https://raw.githubusercontent.com/os-autoinst/openQA/master/script/openqa-bootstrap <span class="tok-p">|</span> bash -x</code></pre>
</div>
</div>
<div class="paragraph">
<p>The script is also available from an openSUSE package to install from:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span>zypper <span class="tok-k">in</span> openQA-bootstrap
/usr/share/openqa/script/openqa-bootstrap</code></pre>
</div>
</div>
<div class="paragraph">
<p>openQA-bootstrap supports to immediately clone an existing job simply by
supplying <code>openqa-clone-job</code> parameters directly for a quickstart:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span>/usr/share/openqa/script/openqa-bootstrap --from openqa.opensuse.org <span class="tok-m">12345</span> <span class="tok-nv">SCHEDULE</span><span class="tok-o">=</span>tests/boot/boot_to_desktop,tests/x11/kontact</code></pre>
</div>
</div>
<div class="paragraph">
<p>The above command will bootstrap an openQA installation and immediately
afterwards start a local test job clone from a test job from a remote instance
with optional, overridden parameters. More information about
<code>openqa-clone-job</code> can be found in
<a href="#_cloning_existing_jobs_openqa_clone_job">Cloning existing jobs - openqa-clone-job</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_openqa_in_a_container">openQA in a container</h3>
<div class="paragraph">
<p><strong>NOTE</strong> This method is not available on openSUSE Leap older than version 15.1.</p>
</div>
<div class="paragraph">
<p>You can also setup a systemd-nspawn container with openQA with the following
commands.
and you need to have no application listening on port 80 yet because the container
will share the host system&#8217;s network stack.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span>zypper <span class="tok-k">in</span> openQA-bootstrap
/usr/share/openqa/script/openqa-bootstrap-container

systemd-run -tM openqa1 /bin/bash <span class="tok-c1"># start a shell in the container</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_container_based_setup">Container based setup</h2>
<div class="sectionbody">
<div id="container_setup" class="paragraph">
<p>Containers are provided for both the web UI and worker.</p>
</div>
<div class="paragraph">
<p>For example the web UI container can be pulled and started using the <code>podman</code>
container engine:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span>podman run --rm -it registry.opensuse.org/devel/openqa/containers15.2/openqa_webui:latest</code></pre>
</div>
</div>
<div class="paragraph">
<p>The worker container can be pulled and started with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span>podman run --rm -it registry.opensuse.org/devel/openqa/containers15.2/openqa_worker:latest</code></pre>
</div>
</div>
<div class="paragraph">
<p>Some parameters are necessary to run them properly. See the
<a href="#containerizedsetup">containerized setup section</a>
for more details and how to configure and run these containers.</p>
</div>
<div class="paragraph">
<p>Take a look at
<a href="https://registry.opensuse.org/cgi-bin/cooverview?srch_term=project%3Ddevel%3AopenQA">openSUSE&#8217;s registry</a>
for all available container images.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_custom_installation_repositories_and_procedure">Custom installation - repositories and procedure</h2>
<div class="sectionbody">
<div id="custom_installation" class="paragraph">
<p>Keep in mind that there can be disruptive changes between openQA versions.
You need to be sure that the webui and the worker that you are using have the
same version number or, at least, are compatible.</p>
</div>
<div class="paragraph">
<p>For example, the packages distributed with older versions of openSUSE Leap are
not compatible with the version on Tumbleweed. And the package distributed
with Tumbleweed may not be compatible with the version in the development
package.</p>
</div>
<div class="sect2">
<h3 id="_official_repositories">Official repositories</h3>
<div class="paragraph">
<p>The easiest way to install openQA is from distribution packages.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>For openSUSE, packages are available for Leap and Tumbleweed</p>
</li>
<li>
<p>For Fedora, packages are available in the official repositories for Fedora 23
and later.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_development_version_repository">Development version repository</h3>
<div class="paragraph">
<p>You can find the development version of openQA in OBS in the
<a href="https://build.opensuse.org/project/show/devel:openQA">openQA:devel</a> repository.</p>
</div>
<div class="paragraph">
<p>To add the development repository to your system, you can use these commands.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span><span class="tok-c1"># openSUSE Tumbleweed</span>
zypper ar -p <span class="tok-m">95</span> -f <span class="tok-s1">&#39;http://download.opensuse.org/repositories/devel:openQA/openSUSE_Tumbleweed&#39;</span> devel_openQA

<span class="tok-c1"># openSUSE Leap</span>
zypper ar -p <span class="tok-m">95</span> -f <span class="tok-s1">&#39;http://download.opensuse.org/repositories/devel:openQA/openSUSE_Leap_$releasever&#39;</span> devel_openQA
zypper ar -p <span class="tok-m">90</span> -f <span class="tok-s1">&#39;http://download.opensuse.org/repositories/devel:openQA:Leap:$releasever/openSUSE_Leap_$releasever&#39;</span> devel_openQA_Leap</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
If you installed openQA from the official repository first, you may need to change the vendor of the dependencies.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span><span class="tok-c1"># openSUSE Tumbleweed and Leap</span>
zypper dup --from devel_openQA --allow-vendor-change

<span class="tok-c1"># openSUSE Leap</span>
zypper dup --from devel_openQA_Leap --allow-vendor-change</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_installation">Installation</h3>
<div class="paragraph">
<p>You can install the main openQA server package using these commands.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span><span class="tok-c1"># openSUSE</span>
zypper <span class="tok-k">in</span> openQA

<span class="tok-c1"># Fedora</span>
dnf install openqa openqa-httpd</code></pre>
</div>
</div>
<div class="paragraph">
<p>To install the openQA worker package use the following.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span><span class="tok-c1"># openSUSE</span>
zypper <span class="tok-k">in</span> openQA-worker</code></pre>
</div>
</div>
<div class="paragraph">
<p>Different convenience packages exist for convenience in openSUSE, for example:
<code>openQA-local-db</code> to install the server including the setup of a local
PostgreSQL database or <code>openQA-single-instance</code> which sets up a web UI server,
a web proxy as well as a local worker. Install <code>openQA-client</code> if you only
want to interact with existing, external openQA instances.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_system_requirements">System requirements</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To run tests based on the default qemu backend the following hardware
specifications are recommended per openQA worker instance:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>1x CPU core with 2x hyperthreads (or 2x CPU cores)</p>
</li>
<li>
<p>8GB RAM</p>
</li>
<li>
<p>40GB HDD (preferably SSD or NVMe)</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_basic_configuration">Basic configuration</h2>
<div class="sectionbody">
<div class="paragraph">
<p>For a local instance setup you can simply execute the script:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span>/usr/share/openqa/script/configure-web-proxy</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will automatically setup a local apache http proxy. Read on for more
detailed setup instructions with all the details.</p>
</div>
<div class="sect2">
<h3 id="_apache_proxy">Apache proxy</h3>
<div class="paragraph">
<p>It is required to run openQA behind an http proxy (apache, nginx, etc..). See the
<strong>openqa.conf.template</strong> config file in <strong>/etc/apache2/vhosts.d</strong> (openSUSE) or
<code>/etc/httpd/conf.d</code> (Fedora). To make everything work correctly on openSUSE, you
need to enable the 'headers', 'proxy', 'proxy_http', 'proxy_wstunnel' and 'rewrite'
modules using the command 'a2enmod'. This is not necessary on Fedora.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span><span class="tok-c1"># openSUSE Only</span>
<span class="tok-c1"># You can check what modules are enabled by using &#39;a2enmod -l&#39;</span>
a2enmod headers
a2enmod proxy
a2enmod proxy_http
a2enmod proxy_wstunnel
a2enmod rewrite</code></pre>
</div>
</div>
<div class="paragraph">
<p>For a basic setup, you can copy <strong>openqa.conf.template</strong> to <strong>openqa.conf</strong> and modify the <code>ServerName</code> if required
setting. This will direct all HTTP traffic to openQA.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span>cp /etc/apache2/vhosts.d/openqa.conf.template /etc/apache2/vhosts.d/openqa.conf</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_tlsssl">TLS/SSL</h3>
<div class="paragraph">
<p>By default openQA expects to be run with HTTPS. The <code>openqa-ssl.conf.template</code>
Apache config file is available as a base for creating the Apache config; you
can copy it to <code>openqa-ssl.conf</code> and uncomment any lines you like, then
ensure a key and certificate are installed to the appropriate location
(depending on distribution and whether you uncommented the lines for key and
cert location in the config file). On openSUSE, you should also add <strong>SSL</strong> to the
<strong>APACHE_SERVER_FLAGS</strong> so it looks like this in <code>/etc/sysconfig/apache2</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span><span class="tok-nv">APACHE_SERVER_FLAGS</span><span class="tok-o">=</span><span class="tok-s2">&quot;SSL&quot;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If you don&#8217;t have a TLS/SSL certificate for your host you must turn HTTPS off.
You can do that in <code>/etc/openqa/openqa.ini</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ini"><span></span><span class="tok-k">[openid]</span>
<span class="tok-na">httpsonly</span> <span class="tok-o">=</span> <span class="tok-s">0</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="database">Database</h3>
<div class="paragraph">
<p>Since version <em>4.5.1512500474.437cc1c7</em> of openQA, PostgreSQL is used as the
database.</p>
</div>
<div class="paragraph">
<p>To configure access to the database in openQA, edit <code>/etc/openqa/database.ini</code>
and change the settings in the <code>[production]</code> section.</p>
</div>
<div class="paragraph">
<p>The <code>dsn</code> value format technically depends on the database type and is
documented for PostgreSQL at
<a href="https://metacpan.org/pod/DBD::Pg#DBI-Class-Methods">DBD::Pg</a></p>
</div>
<div class="sect3">
<h4 id="_example_for_connecting_to_local_postgresql_database">Example for connecting to local PostgreSQL database</h4>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ini"><span></span><span class="tok-k">[production]</span>
<span class="tok-na">dsn</span> <span class="tok-o">=</span> <span class="tok-s">dbi:Pg:dbname=openqa</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_example_for_connecting_to_remote_postgresql_database">Example for connecting to remote PostgreSQL database</h4>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ini"><span></span><span class="tok-k">[production]</span>
<span class="tok-na">dsn</span> <span class="tok-o">=</span> <span class="tok-s">dbi:Pg:dbname=openqa;host=db.example.org</span>
<span class="tok-na">user</span> <span class="tok-o">=</span> <span class="tok-s">openqa</span>
<span class="tok-na">password</span> <span class="tok-o">=</span> <span class="tok-s">somepassword</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>For older versions of openQA, you can migrate from SQLite to PostgreSQL
according to
<a href="#db-migration">DB migration from SQLite to PostgreSQL</a></p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="authentication">User authentication</h3>
<div class="paragraph">
<p>OpenQA supports three different authentication methods: OpenID (default),
OAuth2 and Fake (for development).</p>
</div>
<div class="paragraph">
<p>Use the <code>auth</code> section in <code>/etc/openqa/openqa.ini</code> to configure the method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ini"><span></span><span class="tok-k">[auth]</span>
<span class="tok-c1"># method name is case sensitive!</span>
<span class="tok-na">method</span> <span class="tok-o">=</span> <span class="tok-s">OpenID</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Independently of method used, the first user that logs in (if there is no
admin yet) will automatically get administrator rights!</p>
</div>
<div class="paragraph">
<p>Note that only one authentication method and only one OpenID/OAuth2 provider
can be configured at a time. When changing the method/provider no
users/permissions are lost. However, a new and distinct user (with default
permissions) will be created when logging in via a different method/provider
because there is no automatic mapping of identities across different
methods/providers.</p>
</div>
<div class="sect3">
<h4 id="_openid">OpenID</h4>
<div class="paragraph">
<p>By default openQA uses OpenID with opensuse.org as OpenID provider.
OpenID method has its own <code>openid</code> section in <code>/etc/openqa/openqa.ini</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ini"><span></span><span class="tok-k">[auth]</span>
<span class="tok-c1"># method name is case sensitive!</span>
<span class="tok-na">method</span> <span class="tok-o">=</span> <span class="tok-s">OpenID</span>

<span class="tok-k">[openid]</span>
<span class="tok-c1">## base url for openid provider</span>
<span class="tok-na">provider</span> <span class="tok-o">=</span> <span class="tok-s">https://www.opensuse.org/openid/user/</span>
<span class="tok-c1">## enforce redirect back to https</span>
<span class="tok-na">httpsonly</span> <span class="tok-o">=</span> <span class="tok-s">1</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This method supports OpenID version up to 2.0.</p>
</div>
</div>
<div class="sect3">
<h4 id="_oauth2">OAuth2</h4>
<div class="paragraph">
<p>An additional Mojolicious plugin is required to use this feature:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span><span class="tok-c1"># openSUSE</span>
zypper <span class="tok-k">in</span> <span class="tok-s1">&#39;perl(Mojolicious::Plugin::OAuth2)&#39;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Example for configuring OAuth2 with GitHub:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ini"><span></span><span class="tok-k">[auth]</span>
<span class="tok-c1"># method name is case sensitive!</span>
<span class="tok-na">method</span> <span class="tok-o">=</span> <span class="tok-s">OAuth2</span>

<span class="tok-k">[oauth2]</span>
<span class="tok-na">provider</span> <span class="tok-o">=</span> <span class="tok-s">github</span>
<span class="tok-na">key</span> <span class="tok-o">=</span> <span class="tok-s">mykey</span>
<span class="tok-na">secret</span> <span class="tok-o">=</span> <span class="tok-s">mysecret</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In order to use GitHub for authorization, an "OAuth App" needs to be
<a href="https://github.com/settings/applications/new">registered on GitHub</a>. Use <code>…/login</code>
as callback URL. Afterwards the key and secret will be visible to the application
owner(s).</p>
</div>
<div class="paragraph">
<p>As shown in the comments of the default configuration file, it is also possible
to use different providers.</p>
</div>
</div>
<div class="sect3">
<h4 id="_fake">Fake</h4>
<div class="paragraph">
<p>For development purposes only! Fake authentication bypass any authentication and
automatically allow any login requests as 'Demo user' with administrator privileges
and without password. To ease worker testing, API key and secret is created (or updated)
with validity of one day during login.
You can then use following as <code>/etc/openqa/client.conf</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ini"><span></span><span class="tok-k">[auth]</span>
<span class="tok-c1"># method name is case sensitive!</span>
<span class="tok-na">method</span> <span class="tok-o">=</span> <span class="tok-s">Fake</span>

<span class="tok-k">[localhost]</span>
<span class="tok-na">key</span> <span class="tok-o">=</span> <span class="tok-s">1234567890ABCDEF</span>
<span class="tok-na">secret</span> <span class="tok-o">=</span> <span class="tok-s">1234567890ABCDEF</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If you switch authentication method from Fake to any other, review your API keys!
You may be vulnerable for up to a day until Fake API key expires.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_run_the_web_ui">Run the web UI</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To start openQA and enable it to run on each boot call</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span>systemctl <span class="tok-nb">enable</span> --now postgresql
systemctl <span class="tok-nb">enable</span> --now openqa-webui
systemctl <span class="tok-nb">enable</span> --now openqa-scheduler
<span class="tok-c1"># openSUSE</span>
systemctl restart apache2
<span class="tok-c1"># Fedora</span>
<span class="tok-c1"># for now this is necessary to allow Apache to connect to openQA</span>
setsebool -P httpd_can_network_connect <span class="tok-m">1</span>
systemctl restart httpd</code></pre>
</div>
</div>
<div class="paragraph">
<p>The openQA web UI should be available on <a href="http://localhost/" class="bare">http://localhost/</a> now. To simply
start openQA without enabling it permanently one can simply use <code>systemctl
start</code> instead.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_run_openqa_workers">Run openQA workers</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Workers are services running backends to perform the actual testing. The
testing is commonly performed by running virtual machines but depending on the
specific backend configuration different options exist.</p>
</div>
<div class="paragraph">
<p>It is possible to run openQA workers on the same machine as the web UI as well
as on different machines, even in different networks, for example instances in
public cloud. The only requirement is access to the web UI host over
HTTP/HTTPS. For running tests based on virtual machines KVM support is
recommended.</p>
</div>
<div class="paragraph">
<p>The openQA worker is distributed as a separate package which be installed on
multiple machines while still using only one web UI.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span><span class="tok-c1"># openSUSE</span>
zypper <span class="tok-k">in</span> openQA-worker
<span class="tok-c1"># Fedora</span>
dnf install openqa-worker</code></pre>
</div>
</div>
<div class="paragraph">
<p>To allow workers to access your instance, you need to log into openQA as
operator and create a pair of API key and secret. Once you are logged in, in the
top right corner, is the user menu, follow the link 'manage API keys'.  Click
the 'create' button to generate <code>key</code> and <code>secret</code>. There is also a script
available for creating an admin user and an API key+secret pair
non-interactively, <code>/usr/share/openqa/script/create_admin</code>, which can be useful
for scripted deployments of openQA. Copy and paste the key and secret into
<code>/etc/openqa/client.conf</code> on the machine(s) where the worker is installed. Make
sure to put in a section reflecting your webserver URL. In the simplest case,
your <code>client.conf</code> may look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ini"><span></span><span class="tok-k">[localhost]</span>
<span class="tok-na">key</span> <span class="tok-o">=</span> <span class="tok-s">1234567890ABCDEF</span>
<span class="tok-na">secret</span> <span class="tok-o">=</span> <span class="tok-s">1234567890ABCDEF</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To start the workers you can use the provided systemd files via:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span>systemctl start openqa-worker@1</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will start worker number one. You can start as
many workers as you need, you just need to supply a different 'instance number'
(the number after <code>@</code>).</p>
</div>
<div class="paragraph">
<p>You can also run workers manually from command line.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span>install -d -m <span class="tok-m">0755</span> -o _openqa-worker /var/lib/openqa/pool/X
sudo -u _openqa-worker /usr/share/openqa/script/worker --instance X</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will run a worker manually showing you debug output. If you haven&#8217;t
installed 'os-autoinst' from packages make sure to pass <code>--isotovideo</code> option
to point to the checkout dir where isotovideo is, not to <code>/usr/lib</code>! Otherwise
it will have trouble finding its perl modules.</p>
</div>
<div class="paragraph">
<p>If you start openQA workers on a different machine than the web UI host make
sure to have synchronized clocks, for example using NTP, to prevent
inconsistent test results.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_where_to_now">Where to now?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>From this point on, you can refer to the <a href="#get-testing">Getting Started</a> guide to
fetch the tests cases and possibly take a look at <a href="#writingtests">Test Developer Guide</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_advanced_configuration">Advanced configuration</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="advanced">Setting up git support</h3>
<div class="paragraph">
<p>Editing needles from web can optionally commit new or changed needles
automatically to git. To do so, you need to enable git support by setting</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ini"><span></span><span class="tok-k">[global]</span>
<span class="tok-na">scm</span> <span class="tok-o">=</span> <span class="tok-s">git</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>in <code>/etc/openqa/openqa.ini</code>. Once you do so and restart the web interface, openQA will
automatically commit new needles to the git repository.</p>
</div>
<div class="paragraph">
<p>You may want to add some description to automatic commits coming from the web
UI.
You can do so by setting your configuration in the repository
(<code>/var/lib/os-autoinst/needles/.git/config</code>) to some reasonable defaults such as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ini"><span></span><span class="tok-k">[user]</span>
	<span class="tok-na">email</span> <span class="tok-o">=</span> <span class="tok-s">whatever@example.com</span>
	<span class="tok-na">name</span> <span class="tok-o">=</span> <span class="tok-s">openQA web UI</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To enable automatic pushing of the repo as well, you need to add the following
to your openqa.ini:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ini"><span></span><span class="tok-k">[scm git]</span>
<span class="tok-na">do_push</span> <span class="tok-o">=</span> <span class="tok-s">yes</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Depending on your setup, you might need to generate and propagate
ssh keys for user 'geekotest' to be able to push.</p>
</div>
<div class="paragraph">
<p>It might also be useful to rebase first. To enable that, add the remote to get the
latest updates from and the branch to rebase against to your openqa.ini:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ini"><span></span><span class="tok-k">[scm git]</span>
<span class="tok-na">update_remote</span> <span class="tok-o">=</span> <span class="tok-s">origin</span>
<span class="tok-na">update_branch</span> <span class="tok-o">=</span> <span class="tok-s">origin/master</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_referer_settings_to_auto_mark_important_jobs">Referer settings to auto-mark important jobs</h3>
<div class="paragraph">
<p>Automatic cleanup of old results (see GRU jobs) can sometimes render important
tests useless. For example bug report with link to openQA job which no longer
exists. Job can be manually marked as important to prevent quick cleanup or
referer can be set so when job is accessed from particular web page (for
example bugzilla), this job is automatically labeled as linked and treated as
important.</p>
</div>
<div class="paragraph">
<p>List of recognized referers is space separated list configured in
<code>/etc/openqa/openqa.ini</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ini"><span></span><span class="tok-k">[global]</span>
<span class="tok-na">recognized_referers</span> <span class="tok-o">=</span> <span class="tok-s">bugzilla.suse.com bugzilla.opensuse.org</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_worker_settings">Worker settings</h3>
<div class="paragraph">
<p>Default behavior for all workers is to use the 'Qemu' backend and connect to
'http://localhost'. If you want to change some of those options, you can do so
in <code>/etc/openqa/workers.ini</code>. For example to point the workers to the FQDN of
your host (needed if test cases need to access files of the host) use the
following setting:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ini"><span></span><span class="tok-k">[global]</span>
<span class="tok-na">HOST</span> <span class="tok-o">=</span> <span class="tok-s">http://openqa.example.com</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Once you got workers running they should show up in the admin section of openQA in
the workers section as 'idle'. When you get so far, you have your own instance
of openQA up and running and all that is left is to set up some tests.</p>
</div>
</div>
<div class="sect2">
<h3 id="_further_systemd_units_for_the_worker">Further systemd units for the worker</h3>
<div class="paragraph">
<p>The following information is partially openSUSE specific. The <code>openQA-worker</code>
package provides further systemd units:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>openqa-worker-no-cleanup@.service</code>: see
<a href="#snapshots-for-each-module">enabling snapshots</a></p>
</li>
<li>
<p><code>openqa-worker-auto-restart@.service</code>: worker that restarts automatically
after processing assigned jobs</p>
</li>
<li>
<p><code>openqa-worker-cacheservice</code>/<code>openqa-worker-cacheservice-minion</code>: services
for <a href="#asset-caching">the asset cache</a></p>
</li>
<li>
<p><code>openqa-worker.target</code></p>
<div class="ulist">
<ul>
<li>
<p>Starts <code>openqa-worker@.service</code> (but no other worker units) when started.</p>
<div class="ulist">
<ul>
<li>
<p>The number of started worker slots depends on the pool directories present
under <code>/var/lib/openqa/pool</code>. This information is determined via a systemd
generator and can be refreshed via <code>systemctl daemon-reload</code>.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Stops <code>openqa-worker-no-cleanup@.service</code> and other units conflicting with
<code>openqa-worker@.service</code> when started.</p>
</li>
<li>
<p>Stops/restarts <strong>all</strong> worker units when stopped/restarted.</p>
</li>
<li>
<p>Is restarted automatically when the <code>openQA-worker</code> package is updated
(unless <code>DISABLE_RESTART_ON_UPDATE="yes"</code> is set in <code>/etc/sysconfig/services</code>).</p>
</li>
</ul>
</div>
</li>
<li>
<p><code>openqa-reload-worker-auto-restart@.path</code>: allows to restart the worker service
automatically on configuration changes without interrupting jobs (see next
section for details)</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_stoppingrestarting_workers_without_interrupting_currently_running_jobs">Stopping/restarting workers without interrupting currently running jobs</h4>
<div class="paragraph">
<p>It is possible to stop a worker as soon as it becomes idle and immediately if it
is already idling by sending <code>SIGHUP</code> to the worker process.</p>
</div>
<div class="paragraph">
<p>When the worker is setup to be always restarted (e.g. using a systemd unit
with <code>Restart=always</code> like <code>openqa-worker-auto-restart@*.service</code>) this leads
to the worker being restarted without interrupting currently running jobs. This
can be useful to apply configuration changes and updates without interfering
ongoing testing. Example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span>systemctl reload <span class="tok-s1">&#39;openqa-worker-auto-restart@*.service&#39;</span> <span class="tok-c1"># sends SIGHUP to worker</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>There is also the systemd unit <code>openqa-reload-worker-auto-restart@.path</code> which
invokes the command above (for the specified slot) whenever the worker configuration
under <code>/etc/openqa/workers.ini</code> changes. This unit is not enabled by default and
only affects <code>openqa-worker-auto-restart@.service</code> but not other worker services.</p>
</div>
<div class="paragraph">
<p>This kind of setup makes it easy to take out worker slots temporarily without
interrupting currently running jobs:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span><span class="tok-c1"># prevent worker services from restarting</span>
systemctl mask openqa-worker-auto-restart@<span class="tok-o">{</span><span class="tok-m">1</span>..28<span class="tok-o">}</span>
<span class="tok-c1"># ensure idling worker services stop now (`--kill-who=main` ensures only the</span>
<span class="tok-c1"># worker receives the signal and *not* isotovideo)</span>
systemctl <span class="tok-nb">kill</span> --kill-who<span class="tok-o">=</span>main --signal HUP openqa-worker-auto-restart@<span class="tok-o">{</span><span class="tok-m">1</span>..28<span class="tok-o">}</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_configuring_remote_workers">Configuring remote workers</h3>
<div class="paragraph">
<p>There are some additional requirements to get remote worker running. First is to
ensure shared storage between openQA web UI and workers.
Directory <code>/var/lib/openqa/share</code> contains all required data and should be
shared with read-write access across all nodes present in openQA cluster.
This step is intentionally left on system administrator to choose proper shared
storage for her specific needs.</p>
</div>
<div class="paragraph">
<p>Example of NFS configuration:
NFS server is where openQA web UI is running. Content of <code>/etc/exports</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span>/var/lib/openqa/share *<span class="tok-o">(</span><span class="tok-nv">fsid</span><span class="tok-o">=</span><span class="tok-m">0</span>,rw,no_root_squash,sync,no_subtree_check<span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>NFS clients are where openQA workers are running. Run following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span>mount -t nfs openQA-webUI-host:/var/lib/openqa/share /var/lib/openqa/share</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_configuring_amqp_message_emission">Configuring AMQP message emission</h3>
<div class="paragraph">
<p>You can configure openQA to send events (new comments, tests finished, …)
to an AMQP message bus.
The messages consist of a topic and a body.
The body contains json encoded info about the event.
See <a href="https://github.com/openSUSE/suse_msg/blob/master/amqp_infra.md">amqp_infra.md</a>
for more info about the server and the message topic format.
There you will find instructions how to configure the AMQP server as well.</p>
</div>
<div class="paragraph">
<p>To let openQA send messages to an AMQP message bus,
first make sure that the <code>perl-Mojo-RabbitMQ-Client</code> RPM is installed.
Then you will need to configure amqp in <code>/etc/openqa/openqa.ini</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ini"><span></span><span class="tok-c1"># Configuration for AMQP plugin</span>
<span class="tok-k">[amqp]</span>
<span class="tok-na">heartbeat_timeout</span> <span class="tok-o">=</span> <span class="tok-s">60</span>
<span class="tok-na">reconnect_timeout</span> <span class="tok-o">=</span> <span class="tok-s">5</span>
<span class="tok-c1"># guest/guest is the default anonymous user/pass for RabbitMQ</span>
<span class="tok-na">url</span> <span class="tok-o">=</span> <span class="tok-s">amqp://guest:guest@localhost:5672/</span>
<span class="tok-na">exchange</span> <span class="tok-o">=</span> <span class="tok-s">pubsub</span>
<span class="tok-na">topic_prefix</span> <span class="tok-o">=</span> <span class="tok-s">suse</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>For a TLS connection use <code>amqps://</code> and port <code>5671</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_configuring_worker_to_use_more_than_one_openqa_server">Configuring worker to use more than one openQA server</h3>
<div class="paragraph">
<p>When there are multiple openQA web interfaces (openQA instances) available a worker
can be configured to register and accept jobs from all of them.</p>
</div>
<div class="paragraph">
<p>Requirements:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>/etc/openqa/client.conf</code> must contain API keys and secrets to all instances</p>
</li>
<li>
<p>Shared storage from all instances must be properly mounted</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In the <code>/etc/openqa/workers.ini</code> enter space-separated instance hosts and optionally
configure where the shared storage is mounted. Example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ini"><span></span><span class="tok-k">[global]</span>
<span class="tok-na">HOST</span> <span class="tok-o">=</span> <span class="tok-s">openqa.opensuse.org openqa.fedora.fedoraproject.org</span>

<span class="tok-k">[openqa.opensuse.org]</span>
<span class="tok-na">SHARE_DIRECTORY</span> <span class="tok-o">=</span> <span class="tok-s">/var/lib/openqa/opensuse</span>

<span class="tok-k">[openqa.fedoraproject.org]</span>
<span class="tok-na">SHARE_DIRECTORY</span> <span class="tok-o">=</span> <span class="tok-s">/var/lib/openqa/fedora</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Configuring <code>SHARE_DIRECTORY</code> is not a hard requirement. Worker will try following
directories prior registering with openQA instance:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>SHARE_DIRECTORY</code></p>
</li>
<li>
<p><code>/var/lib/openqa/$instance_host</code></p>
</li>
<li>
<p><code>/var/lib/openqa/share</code></p>
</li>
<li>
<p><code>/var/lib/openqa</code></p>
</li>
<li>
<p>fail if none of above is available</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Once worker registers to openQA instance it checks for available job and starts
accepting websockets commands. Worker accepts jobs as they will come in, there
is no priority, or other ordering, support at the moment.
It is possible to mix local openQA instance with remote instances or use only
remote instances.</p>
</div>
</div>
<div class="sect2">
<h3 id="asset-caching">Asset Caching</h3>
<div class="paragraph">
<p>If your network is slow or you experience long time to load needles you might
want to consider to enable caching in your remote workers. To enable caching,
<code>/var/lib/openqa/cache</code> must exist, and right permissions given to the
'_openqa-worker' user to read everything under this path. If you install
openQA through the repositories, said directory will be created for you.
It is suggested to have the cache and pool directories on the same filesystem
to ensure assets used by tests are available as long as needed. This is
achieved by using hard links, resorting to symlinks in other cases with the
risk of assets being deleted from the cache before tests relying on these
assets end.</p>
</div>
<div class="paragraph">
<p>Start and enable the Cache Service:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span>systemctl <span class="tok-nb">enable</span> --now openqa-worker-cacheservice</code></pre>
</div>
</div>
<div class="paragraph">
<p>Enable and start the Cache Worker:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span>systemctl <span class="tok-nb">enable</span> --now openqa-worker-cacheservice-minion</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the <code>/etc/openqa/workers.ini</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ini"><span></span><span class="tok-k">[global]</span>
<span class="tok-na">HOST</span><span class="tok-o">=</span><span class="tok-s">http://webui</span>
<span class="tok-na">CACHEDIRECTORY</span> <span class="tok-o">=</span> <span class="tok-s">$cache_location</span>
<span class="tok-na">CACHELIMIT</span> <span class="tok-o">=</span> <span class="tok-s">50 # GB, default is 50.</span>
<span class="tok-na">CACHEWORKERS</span> <span class="tok-o">=</span> <span class="tok-s">5 # Number of parallel cache minion workers, defaults to 5</span>

<span class="tok-k">[http://webui]</span>
<span class="tok-na">TESTPOOLSERVER</span> <span class="tok-o">=</span> <span class="tok-s">rsync://yourlocation/tests</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Setup and run rsync server daemon on HOST machine, in /etc/rsyncd.conf should be:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ini"><span></span><span class="tok-na">gid</span> <span class="tok-o">=</span> <span class="tok-s">users</span>
<span class="tok-na">read only</span> <span class="tok-o">=</span> <span class="tok-s">true</span>
<span class="tok-na">use chroot</span> <span class="tok-o">=</span> <span class="tok-s">true</span>
<span class="tok-na">transfer logging</span> <span class="tok-o">=</span> <span class="tok-s">true</span>
<span class="tok-na">log format</span> <span class="tok-o">=</span> <span class="tok-s">%h %o %f %l %b</span>
<span class="tok-na">log file</span> <span class="tok-o">=</span> <span class="tok-s">/var/log/rsyncd.log</span>
<span class="tok-na">pid file</span> <span class="tok-o">=</span> <span class="tok-s">/var/run/rsyncd.pid</span>
<span class="tok-na">slp refresh</span> <span class="tok-o">=</span> <span class="tok-s">300</span>
<span class="tok-na">use slp</span> <span class="tok-o">=</span> <span class="tok-s">false</span>

<span class="tok-c1">#[Example]</span>
<span class="tok-c1">#	path = /home/Example</span>
<span class="tok-c1">#	comment = An Example</span>
<span class="tok-c1">#	auth users = user</span>
<span class="tok-c1">#	secrets file = /etc/rsyncd.secrets</span>

<span class="tok-k">[tests]</span>
<span class="tok-na">path</span> <span class="tok-o">=</span> <span class="tok-s">/var/lib/openqa/share/tests</span>
<span class="tok-na">comment</span> <span class="tok-o">=</span> <span class="tok-s">OpenQA Test Distributions</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>and</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span>systemctl <span class="tok-nb">enable</span> --now rsyncd</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will allow the workers to download the assets from the web UI and use them
locally. If <code>TESTPOOLSERVER</code> is set tests and needles will also be cached by the
worker.</p>
</div>
</div>
<div class="sect2">
<h3 id="_enable_linking_files_referred_by_job_settings">Enable linking files referred by job settings</h3>
<div class="paragraph">
<p>Specific job settings might refer to files within the test distribution.
You can configure openQA to display links to these files within the job settings tab.
To enable particular settings to be presented as a link within the settings tab
one can setup the relevant keys in <code>/etc/openqa/openqa.ini</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ini"><span></span><span class="tok-k">[job_settings_ui]</span>
<span class="tok-na">keys_to_render_as_links</span><span class="tok-o">=</span><span class="tok-s">FOO,AUTOYAST</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The files referenced by the configured keys should be located either under the root
of <code>CASEDIR</code> or the data folder within <code>CASEDIR</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_enable_custom_hook_scripts_on_job_done_based_on_result">Enable custom hook scripts on "job done" based on result</h3>
<div class="paragraph">
<p>If a job is done, especially if no label could be found for carry-over, often
more steps are needed for the review of the test result or providing the
information to either external systems or users. As there can be very custom
requirements openQA offers a point for optional configuration to let the
instance administrators define specific actions.</p>
</div>
<div class="paragraph">
<p>By setting custom hooks it is possible to call external scripts defined in
either environment variables or config settings.</p>
</div>
<div class="paragraph">
<p>If an environment variable corresponding to the job result is found following
the name pattern <code>OPENQA_JOB_DONE_HOOK_$RESULT</code>, any executable specified in
the variable as absolute path or executable name in <code>$PATH</code> is called with the
job ID as first and only parameter. For example for a job with result
"failed", the corresponding environment variable would be
<code>OPENQA_JOB_DONE_HOOK_FAILED</code>. As alternative to an environment variable a
corresponding config variable in the section <code>[hooks]</code> in lower-case without
the <code>OPENQA_</code> prefix can be used in the format <code>job_done_hook_$result</code>. The
corresponding environment value has precedence. The exit code of the
externally called script is not evaluated and will have no effect.</p>
</div>
<div class="paragraph">
<p>The execution time of the script is by default limited to five minutes. If the
script does not terminate after receiving <code>SIGTERM</code> for 30 seconds it is
terminated forcefully via <code>SIGKILL</code>. One can change that by setting the
environment variables <code>OPENQA_JOB_DONE_HOOK_TIMEOUT</code> and
<code>OPENQA_JOB_DONE_HOOK_KILL_TIMEOUT</code> to the desired timeouts. The format from the
<code>timeout</code> command is used (see <code>timeout --help</code>).</p>
</div>
<div class="paragraph">
<p>For example there is already an approach called "auto-review"
<a href="https://github.com/os-autoinst/scripts/#auto-review---automatically-detect-known-issues-in-openqa-jobs-label-openqa-jobs-with-ticket-references-and-optionally-retrigger" class="bare">https://github.com/os-autoinst/scripts/#auto-review---automatically-detect-known-issues-in-openqa-jobs-label-openqa-jobs-with-ticket-references-and-optionally-retrigger</a>
which offers helpful, external scripts. Config settings for
openqa.opensuse.org enabling the auto-review scripts could look like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code><span></span>[hooks]
job_done_hook_incomplete = /opt/openqa-scripts/openqa-label-known-issues-hook
job_done_hook_failed = /opt/openqa-scripts/openqa-label-known-issues-hook</code></pre>
</div>
</div>
<div class="paragraph">
<p>or for a host openqa.example.com:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code><span></span>[hooks]
job_done_hook_incomplete = env host=openqa.example.com /opt/openqa-scripts/openqa-label-known-issues-hook
job_done_hook_failed = env host=openqa.example.com /opt/openqa-scripts/openqa-label-known-issues-hook</code></pre>
</div>
</div>
<div class="paragraph">
<p>The environment variable should be set in a systemd service override for the
GRU service. A corresponding systemd override file
<code>/etc/systemd/system/openqa-gru.service.d/override.conf</code> could look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code><span></span>[Service]
Environment=&quot;OPENQA_JOB_DONE_HOOK_INCOMPLETE=/opt/os-autoinst-scripts/openqa-label-known-issues-hook&quot;</code></pre>
</div>
</div>
<div class="paragraph">
<p>When using <code>apparmor</code> the called hook scripts must be covered by according
<code>apparmor</code> rules, for example for the above in
<code>/etc/apparmor.d/usr.share.openqa.script.openqa</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code><span></span>  /opt/os-autoinst-scripts/** rix,
  /usr/bin/cat rix,
  /usr/bin/curl rix,
  /usr/bin/jq rix,
  /usr/bin/mktemp rix,
  /usr/share/openqa/script/client rix,</code></pre>
</div>
</div>
<div class="paragraph">
<p>Any stderr output of the hook scripts should be visible in the system logs of
the openQA GRU service, the general status and any stdout output is visible in
the GRU minion job dashboard on the route
<code>/minion/jobs?offset=0&amp;task=finalize_job_results</code> of the openQA instance.</p>
</div>
</div>
<div class="sect2">
<h3 id="_automatic_cloning_of_incomplete_jobs">Automatic cloning of incomplete jobs</h3>
<div class="paragraph">
<p>By default, when a worker reports an incomplete job due to a cache service related
problem, the job is automatically cloned. It is possible to extend the regex to cover
other types of incompletes as well by adjusting <code>auto_clone_regex</code> in the <code>global</code>
section of the config file. It is also possible to assign <code>0</code> to prevent the automatic
cloning.</p>
</div>
<div class="paragraph">
<p>Note that jobs marked as incomplete by the stale job detection are not affected by this
configuration and cloned in any case.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_auditing_tracking_openqa_changes">Auditing - tracking openQA changes</h2>
<div class="sectionbody">
<div id="auditing" class="paragraph">
<p>Auditing plugin enables openQA administrators to maintain overview about what is happening with the system.
Plugin records what event was triggered by whom, when and what the request looked like. Actions done by openQA
workers are tracked under user whose API keys are workers using.</p>
</div>
<div class="paragraph">
<p>Audit log is directly accessible from <code>Admin menu</code>.</p>
</div>
<div class="paragraph">
<p>Auditing, by default enabled, can be disabled by global configuration option in <code>/etc/openqa/openqa.ini</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ini"><span></span><span class="tok-k">[global]</span>
<span class="tok-na">audit_enabled</span> <span class="tok-o">=</span> <span class="tok-s">0</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>audit</code> section of <code>/etc/openqa/openqa.ini</code> allows to exclude some events from logging using
a space separated blocklist:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ini"><span></span><span class="tok-k">[audit]</span>
<span class="tok-na">blocklist</span> <span class="tok-o">=</span> <span class="tok-s">job_grab job_done</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>audit/storage_duration</code> section of <code>/etc/openqa/openqa.ini</code> allows to set the retention policy for
different audit event types:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ini"><span></span><span class="tok-k">[audit/storage_duration]</span>
<span class="tok-na">startup</span> <span class="tok-o">=</span> <span class="tok-s">10</span>
<span class="tok-na">jobgroup</span> <span class="tok-o">=</span> <span class="tok-s">365</span>
<span class="tok-na">jobtemplate</span> <span class="tok-o">=</span> <span class="tok-s">365</span>
<span class="tok-na">table</span> <span class="tok-o">=</span> <span class="tok-s">365</span>
<span class="tok-na">iso</span> <span class="tok-o">=</span> <span class="tok-s">60</span>
<span class="tok-na">user</span> <span class="tok-o">=</span> <span class="tok-s">60</span>
<span class="tok-na">asset</span> <span class="tok-o">=</span> <span class="tok-s">30</span>
<span class="tok-na">needle</span> <span class="tok-o">=</span> <span class="tok-s">30</span>
<span class="tok-na">other</span> <span class="tok-o">=</span> <span class="tok-s">15</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In this example events of the type <code>startup</code> would be cleaned up after 10 days, events related to
job groups after 365 days and so on. Events which do not fall into one of these categories would be
cleaned after 15 days. By default, cleanup is disabled.</p>
</div>
<div class="paragraph">
<p>Use <code>systemctl enable --now openqa-enqueue-audit-event-cleanup.timer</code> to schedule the cleanup
automatically every day. It is also possible to trigger the cleanup manually by invoking
<code>/usr/share/openqa/script/openqa minion job -e limit_audit_events</code>.</p>
</div>
<div class="sect2">
<h3 id="_list_of_events_tracked_by_the_auditing_plugin">List of events tracked by the auditing plugin</h3>
<div class="ulist">
<ul>
<li>
<p>Assets:</p>
<div class="ulist">
<ul>
<li>
<p>asset_register asset_delete</p>
</li>
</ul>
</div>
</li>
<li>
<p>Workers:</p>
<div class="ulist">
<ul>
<li>
<p>worker_register command_enqueue</p>
</li>
</ul>
</div>
</li>
<li>
<p>Jobs:</p>
<div class="ulist">
<ul>
<li>
<p>iso_create iso_delete iso_cancel</p>
</li>
<li>
<p>jobtemplate_create jobtemplate_delete</p>
</li>
<li>
<p>job_create job_grab job_delete job_update_result job_done jobs_restart job_restart job_cancel job_duplicate</p>
</li>
<li>
<p>jobgroup_create jobgroup_connect</p>
</li>
</ul>
</div>
</li>
<li>
<p>Tables:</p>
<div class="ulist">
<ul>
<li>
<p>table_create table_update table_delete</p>
</li>
</ul>
</div>
</li>
<li>
<p>Users:</p>
<div class="ulist">
<ul>
<li>
<p>user_new_comment user_update_comment user_delete_comment user_login</p>
</li>
</ul>
</div>
</li>
<li>
<p>Needles:</p>
<div class="ulist">
<ul>
<li>
<p>needle_delete needle_modify</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Some of these events are very common and may clutter audit database. For this reason <code>job_grab</code> and <code>job_done</code>
events are on the blocklist by default.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Upgrading openQA does not automatically update <code>/etc/openqa/openqa.ini</code>. Review your configuration after upgrade.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_automatic_system_upgrades_and_reboots_of_openqa_hosts">Automatic system upgrades and reboots of openQA hosts</h2>
<div class="sectionbody">
<div id="auto_upgrade" class="paragraph">
<p>The distribution package <code>openQA-auto-update</code> offers automatic system
upgrades and reboots of openQA hosts. To use that feature install the package
<code>openQA-auto-update</code> and enable the corresponding systemd timer:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span>systemctl <span class="tok-nb">enable</span> openqa-auto-update.timer</code></pre>
</div>
</div>
<div class="paragraph">
<p>This triggers a nightly system upgrade which first looks into configured openQA
repositories for stable packages, then conducts the upgrade and schedules
reboots during the configured reboot maintenance windows using <code>rebootmgr</code>.
As an alternative to the systemd timer the script
<code>/usr/share/openqa/script/openqa-auto-update</code> can be called when desired.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_filesystem_layout">Filesystem layout</h2>
<div class="sectionbody">
<div id="filesystem" class="paragraph">
<p>Tests, needles, assets, results and working directories (a.k.a. "pool directories") are located in certain
subdirectories within <code>/var/lib/openqa</code>. This directory is configurable (see
<a href="#customize_base_directory">Customize base directory</a>). Here we assume the default is in place.</p>
</div>
<div class="paragraph">
<p>Note that the sub directories within <code>/var/lib/openqa</code> must be accessible by the user that runs the openQA web UI
(by default 'geekotest') or by the user that runs the worker/isotovideo (by default '_openqa-worker').</p>
</div>
<div class="paragraph">
<p>These are the most important sub directories within <code>/var/lib/openqa</code>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>db</code> contains the web UI&#8217;s database lockfile</p>
</li>
<li>
<p><code>images</code> is where the web UI stores test screenshots and thumbnails</p>
</li>
<li>
<p><code>testresults</code> is where the web UI stores test logs and test-generated assets</p>
</li>
<li>
<p><code>webui</code> is where the web UI stores miscellaneous files</p>
</li>
<li>
<p><code>pool</code> contains working directories of the workers/isotovideo</p>
</li>
<li>
<p><code>share</code> contains directories shared between the web UI and (remote) workers, can be owned by root</p>
</li>
<li>
<p><code>share/factory</code> contains test assets and temp directory, can be owned by root but sysadmin must create subdirs</p>
</li>
<li>
<p><code>share/factory/iso</code> and <code>share/factory/iso/fixed</code> contain ISOs for tests</p>
</li>
<li>
<p><code>share/factory/hdd</code> and <code>share/factory/hdd/fixed</code> contain hard disk images for tests</p>
</li>
<li>
<p><code>share/factory/repo</code> and <code>share/factory/repo/fixed</code> contain repositories for tests</p>
</li>
<li>
<p><code>share/factory/other</code> and <code>share/factory/other/fixed</code> contain miscellaneous test assets (e.g. kernels and initrds)</p>
</li>
<li>
<p><code>share/factory/tmp</code> is used as a temporary directory (openQA will create it if it owns <code>share/factory</code>)</p>
</li>
<li>
<p><code>share/tests</code> contains the tests themselves</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Each of the asset directories (<code>factory/iso</code>, <code>factory/hdd</code>, <code>factory/repo</code> and
<code>factory/other</code>) may contain a <code>fixed/</code> subdirectory, and assets of the same
type may be placed in that directory. Placing an asset in the <code>fixed/</code>
subdirectory indicates that it should not be deleted to save space: the GRU
task which removes old assets when the size of all assets for a given job
group is above a specified size will ignore assets in the <code>fixed/</code>
subdirectories.</p>
</div>
<div class="paragraph">
<p>It also contains several symlinks which are necessary due to various things
moving around over the course of openQA&#8217;s development. All the symlinks
can of course be owned by root:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>script</code> (symlink to <code>/usr/share/openqa/script/</code>)</p>
</li>
<li>
<p><code>tests</code> (symlink to <code>share/tests</code>)</p>
</li>
<li>
<p><code>factory</code> (symlink to <code>share/factory</code>)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>It is always best to use the canonical locations, not the compatibility
symlinks - so run scripts from <code>/usr/share/openqa/script</code>, not
<code>/var/lib/openqa/script</code>.</p>
</div>
<div class="paragraph">
<p>You only need the asset directories for the asset types you will actually use,
e.g. if none of your tests refer to openQA-stored repositories, you will need
no <code>factory/repo</code> directory. The distribution packages may not create all
asset directories, so make sure the ones you need are created if necessary.
Packages will likewise usually not contain any tests; you must create your
own tests, or use existing tests for some distribution or other piece of
software.</p>
</div>
<div class="paragraph">
<p>The worker needs to own <code>/var/lib/openqa/pool/$INSTANCE</code>, e.g.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>/var/lib/openqa/pool/1</code></p>
</li>
<li>
<p><code>/var/lib/openqa/pool/2</code></p>
</li>
<li>
<p>&#8230;&#8203; - add more if you have more worker instances</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You can also give the whole pool directory to the <code>_openqa-worker</code> user and let
the workers create their own instance directories.</p>
</div>
<div class="sect2">
<h3 id="_terms_and_variables_for_certain_directories_used_by_openqa_and_isotovideo">Terms and variables for certain directories used by openQA and isotovideo</h3>
<div class="ulist">
<ul>
<li>
<p>the "base directory"</p>
<div class="ulist">
<ul>
<li>
<p>by default <code>/var/lib</code></p>
</li>
<li>
<p>configurable via environment variable <code>OPENQA_BASEDIR</code></p>
</li>
<li>
<p>referred as <code>$basedir</code> within openQA</p>
</li>
</ul>
</div>
</li>
<li>
<p>the "project directory"</p>
<div class="ulist">
<ul>
<li>
<p>defined as <code>$basedir/openqa</code>, by default <code>/var/lib/openqa</code></p>
</li>
<li>
<p>referred as <code>$prjdir</code> within openQA</p>
</li>
</ul>
</div>
</li>
<li>
<p>the "share directory": contains directories shared between web UI and (remote) workers</p>
<div class="ulist">
<ul>
<li>
<p>defined as <code>$prjdir/share</code>, by default <code>/var/lib/openqa/share</code></p>
</li>
<li>
<p>referred as <code>$sharedir</code> within openQA</p>
</li>
</ul>
</div>
</li>
<li>
<p>the "test case directory": contains a test distribution</p>
<div class="ulist">
<ul>
<li>
<p>by default <code>$sharedir/tests/$distri</code> or <code>$sharedir/tests/$distri-$version</code></p>
</li>
<li>
<p>configurable via the test variable <code>CASEDIR</code> (see backend variables documentation)</p>
</li>
<li>
<p>this default is provided by openQA; when starting isotovideo manually the <code>CASEDIR</code> variable <strong>must</strong> be
initialized by hand</p>
</li>
<li>
<p>might contain the sub directory <code>lib</code> for placing Perl modules used by the tests</p>
</li>
</ul>
</div>
</li>
<li>
<p>the "product directory": contains the test schedule (<code>main.pm</code>) for a certain product within a test distribution</p>
<div class="ulist">
<ul>
<li>
<p>by default identical to the "test case directory"</p>
</li>
<li>
<p>usually a directory <code>products/$distri</code> within the "test case directory"</p>
</li>
<li>
<p>configurable via the test variable <code>PRODUCTDIR</code> (see backend variables documentation)</p>
</li>
</ul>
</div>
</li>
<li>
<p>the "needles directory": contains reference images for a certain product within a test distribution</p>
<div class="ulist">
<ul>
<li>
<p>by default <code>$PRODUCTDIR/needles</code></p>
</li>
<li>
<p>configurable via the test variable <code>NEEDLES_DIR</code> (see backend variables documentation)</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_further_notes">Further notes</h4>
<div class="ulist">
<ul>
<li>
<p>Setting the test variables has only an influence on os-autoinst. The web UI on the other hand always relies
on the directory structure described above. For the exact details how these paths are computed by the web UI
have a look at <code>lib/OpenQA/Utils.pm</code>.</p>
</li>
<li>
<p>When enabling the worker cache parts of the usual "share directory" are located in the specified cache
directory on the worker host.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_automatic_installation_of_the_operating_systems_for_openqa_machines">Automatic installation of the operating systems for openQA machines</h2>
<div class="sectionbody">
<div id="auto_installation_machines" class="paragraph">
<p>As a maintainer of an openQA infrastructure running multiple openQA worker
machines one likely wants to use installation recipes for automatic
installations to provide a consistent and easy setup of new machines.</p>
</div>
<div class="paragraph">
<p>For this <a href="https://doc.opensuse.org/projects/autoyast/">AutoYaST</a> can be used. An
example template that provides the bare basics of installing a machine with
SSH and salt, e.g. to be used with
<a href="https://github.com/os-autoinst/salt-states-openqa/" class="bare">https://github.com/os-autoinst/salt-states-openqa/</a>, can be found in
<a href="https://github.com/os-autoinst/openQA/blob/master/contrib/ay-openqa-worker.xml" class="bare">https://github.com/os-autoinst/openQA/blob/master/contrib/ay-openqa-worker.xml</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_troubleshooting">Troubleshooting</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="troubleshooting">Tests fail quickly</h3>
<div class="paragraph">
<p>Check the log files in <code>/var/lib/openqa/testresults</code></p>
</div>
</div>
<div class="sect2">
<h3 id="_kvm_doesnt_work">KVM doesn&#8217;t work</h3>
<div class="ulist">
<ul>
<li>
<p>make sure you have a machine with kvm support</p>
</li>
<li>
<p>make sure <code>kvm_intel</code> or <code>kvm_amd</code> modules are loaded</p>
</li>
<li>
<p>make sure you do have virtualization enabled in BIOS</p>
</li>
<li>
<p>make sure the '_openqa-worker' user can access <code>/dev/kvm</code></p>
</li>
<li>
<p>make sure you are not already running other hypervisors such as VirtualBox</p>
</li>
<li>
<p>when running inside a vm make sure nested virtualization is enabled (pass nested=1 to your kvm module)</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_openid_login_times_out">openid login times out</h3>
<div class="paragraph">
<p>www.opensuse.org&#8217;s openid provider may have trouble with IPv6. openQA shows a message like this:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>no_identity_server: Could not determine ID provider from URL.</pre>
</div>
</div>
<div class="paragraph">
<p>To avoid that switch off IPv6 or add a special route that prevents the system
from trying to use IPv6 with www.opensuse.org:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span>ip -6 r a to unreachable <span class="tok-m">2620</span>:113:8044:66:130:57:66:6/128</code></pre>
</div>
</div>
</div>
</div>
</div>
<h1 id="usersguide" class="sect0">openQA users guide</h1>
<div class="sect1">
<h2 id="_introduction_3">Introduction</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This document provides additional information for use of the web interface or
the REST API as well as administration information.
For administrators it is recommend to have read the
<a href="#installing">Installation Guide</a> first to understand the structure
of components as well as the configuration of an installed instance.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_using_job_templates_to_automate_jobs_creation">Using job templates to automate jobs creation</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="job_templates">The problem</h3>
<div class="paragraph">
<p>When testing an operating system, especially when doing continuous testing,
there is always a certain combination of jobs, each one with its own
settings, that needs to be run for every revision. Those combinations can be
different for different 'flavors' of the same revision, like running a different
set of jobs for each architecture or for the Full and the Lite versions. This
combinational problem can go one step further if openQA is being used for
different kinds of tests, like running some simple pre-integration tests
for some snapshots combined with more comprehensive post-integration tests for
release candidates.</p>
</div>
<div class="paragraph">
<p>This section describes how an instance of openQA can be configured using the
options in the admin area to automatically create all the required jobs for each
revision of your operating system that needs to be tested. If you are starting
from scratch, you should probably go through the following order:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Define machines in 'Machines' menu</p>
</li>
<li>
<p>Define medium types (products) you have in 'Medium types' menu</p>
</li>
<li>
<p>Specify various collections of tests you want to run in the 'Test suites' menu</p>
</li>
<li>
<p>Define job groups in 'Job groups' menu for groups of tests</p>
</li>
<li>
<p>Select individual 'Job groups' and decide what combinations make sense and
need to be tested</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Machines, mediums, test suites and job templates  can all set various
configuration variables. The so called job templates within the job groups
define how the test suites, mediums and machines should be combined in various
ways to produce individual 'jobs'. All the variables from the test suite,
medium, machine and job template are combined and made available to the actual
test code run by the 'job', along with variables specified as part of the job
creation request. Certain variables also influence openQA&#8217;s and/or
os-autoinst&#8217;s own behavior in terms of how it configures the environment for
the job. Variables that influence os-autoinst&#8217;s behavior are documented in the
file <code>doc/backend_vars.asciidoc</code> in the os-autoinst repository.</p>
</div>
<div class="paragraph">
<p>In openQA we can parameterize a test to describe for what product it will run
and for what kind of machines it will be executed. For example, a test suite
<code>kde</code> can be run for any product that has the KDE software stack installed,
like <code>openSUSE-DVD-x86_64</code> and <code>openSUSE-NET-i586</code>, and can be tested in
different x86-64 and i586 machines like <code>64bit</code>, <code>64bit_USBBoot</code>, <code>32bit</code>. In
this example we could have the following test scenarios considering that the
&#8220;x86_64&#8221; flavor is not compatible with the <code>32bit</code> machine:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>openSUSE-DVD-x86_64-kde-64bit</p>
</li>
<li>
<p>openSUSE-DVD-x86_64-kde-64bit_USBBoot</p>
</li>
<li>
<p>openSUSE-NET-i586-kde-64bit</p>
</li>
<li>
<p>openSUSE-NET-i586-kde-64bit_USBBoot</p>
</li>
<li>
<p>openSUSE-NET-i586-kde-32bit</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For every test scenario we need to configure a different instance of the test
backend, for example <code>os-autoinst</code>, with a different set of parameters.</p>
</div>
</div>
<div class="sect2">
<h3 id="_machines">Machines</h3>
<div class="paragraph">
<p>You need to have at least one machine set up to be able to run any
tests. Those machines represent virtual machine types that you want to
test. To make tests actually happen, you have to have an 'openQA
worker' connected that can fulfill those specifications.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Name.</strong> User defined string - only needed for operator to identify the machine
configuration.</p>
</li>
<li>
<p><strong>Backend.</strong> What backend should be used for this machine. Recommended value is
<code>qemu</code> as it is the most tested one, but other options (such as <code>kvm2usb</code> or <code>vbox</code>)
are also possible.</p>
</li>
<li>
<p><strong>Variables</strong> Most machine variables influence os-autoinst&#8217;s behavior in terms
of how the test machine is set up. A few important examples:</p>
<div class="ulist">
<ul>
<li>
<p><code>QEMUCPU</code> can be 'qemu32' or 'qemu64' and specifies the architecture of the
virtual CPU.</p>
</li>
<li>
<p><code>QEMUCPUS</code> is an integer that specifies the number of cores you wish for.</p>
</li>
<li>
<p><code>LAPTOP</code> if set to 1, QEMU will create a laptop profile.</p>
</li>
<li>
<p><code>USBBOOT</code> when set to 1, the image will be loaded through an
emulated USB stick.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_medium_types_products">Medium Types (products)</h3>
<div class="paragraph">
<p>A medium type (product) in openQA is a simple description without any concrete
meaning. It basically consists of a name and a set of variables that
define or characterize this product in os-autoinst.</p>
</div>
<div class="paragraph">
<p>Some example variables used by openSUSE are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>ISO_MAXSIZE</code> contains the maximum size of the product. There is a
test that checks that the current size of the product is less or
equal than this variable.</p>
</li>
<li>
<p><code>DVD</code> if it is set to 1, this indicates that the medium is a DVD.</p>
</li>
<li>
<p><code>LIVECD</code> if it is set to 1, this indicates that the medium is a live
image (can be a CD or USB)</p>
</li>
<li>
<p><code>GNOME</code> this variable, if it is set to 1, indicates that it is a GNOME
only distribution.</p>
</li>
<li>
<p><code>PROMO</code> marks the promotional product.</p>
</li>
<li>
<p><code>RESCUECD</code> is set to 1 for rescue CD images.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_test_suites">Test Suites</h3>
<div class="paragraph">
<p>A test suite consists of a name and a set of test variables that are used
inside this particular test together with an optional description. The test
variables can be used to parameterize the actual test code and influence the
behaviour according to the settings.</p>
</div>
<div class="paragraph">
<p>Some sample variables used by openSUSE are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>BTRFS</code> if set, the file system will be BtrFS.</p>
</li>
<li>
<p><code>DESKTOP</code> possible values are 'kde' 'gnome' 'lxde' 'xfce' or
'textmode'. Used to indicate the desktop selected by the user during
the test.</p>
</li>
<li>
<p><code>DOCRUN</code> used for documentation tests.</p>
</li>
<li>
<p><code>DUALBOOT</code> dual boot testing, needs HDD_1 and HDDVERSION.</p>
</li>
<li>
<p><code>ENCRYPT</code> encrypt the home directory via YaST.</p>
</li>
<li>
<p><code>HDDVERSION</code> used together with HDD_1 to set the operating system
previously installed on the hard disk.</p>
</li>
<li>
<p><code>INSTALLONLY</code> only basic installation.</p>
</li>
<li>
<p><code>INSTLANG</code> installation language. Actually used only in documentation
tests.</p>
</li>
<li>
<p><code>LIVETEST</code> the test is on a live medium, do not install the distribution.</p>
</li>
<li>
<p><code>LVM</code> select LVM volume manager.</p>
</li>
<li>
<p><code>NICEVIDEO</code> used for rendering a result video for use in show rooms,
skipping ugly and boring tests.</p>
</li>
<li>
<p><code>NOAUTOLOGIN</code> unmark autologin in YaST</p>
</li>
<li>
<p><code>NUMDISKS</code> total number of disks in QEMU.</p>
</li>
<li>
<p><code>REBOOTAFTERINSTALL</code> if set to 1, will reboot after the installation.</p>
</li>
<li>
<p><code>SCREENSHOTINTERVAL</code> used with NICEVIDEO to improve the video quality.</p>
</li>
<li>
<p><code>SPLITUSR</code> a YaST configuration option.</p>
</li>
<li>
<p><code>TOGGLEHOME</code> a YaST configuration option.</p>
</li>
<li>
<p><code>UPGRADE</code> upgrade testing, need HDD_1 and HDDVERSION.</p>
</li>
<li>
<p><code>VIDEOMODE</code> if the value is 'text', the installation will be done in
text mode.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Some of the variables usually set in test suites that influence openQA
and/or os-autoinst&#8217;s own behavior are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>HDDMODEL</code> variable to set the HDD hardware model</p>
</li>
<li>
<p><code>HDDSIZEGB</code> hard disk size in GB. Used together with BtrFS variable</p>
</li>
<li>
<p><code>HDD_1</code> path for the pre-created hard disk</p>
</li>
<li>
<p><code>RAIDLEVEL</code> RAID configuration variable</p>
</li>
<li>
<p><code>QEMUVGA</code> parameter to declare the video hardware configuration in QEMU</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_job_groups_2">Job Groups</h3>
<div class="paragraph">
<p>The job groups are the place where the actual test scenarios are defined by
the selection of the medium type, the test suite and machine together with a
priority.</p>
</div>
<div class="paragraph">
<p>The priority is used in the scheduler to choose the next job. If multiple jobs
are scheduled and their requirements for running them are fulfilled the ones
with a lower value for the priority are triggered. The id is the second
sorting key: Of two jobs with equal requirements and same priority the one
with lower id is triggered first.</p>
</div>
<div class="paragraph">
<p>Job groups themselves can be created over the web UI as well as the REST API.
Job groups can optionally be nested into categories. The display order of job
groups and categories can be configured by drag-and-drop in the web UI.</p>
</div>
<div class="paragraph">
<p>The scenario definitions within the job groups can be created and configured
by different means:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A simple web UI wizard which is automatically shown for job groups when a
new medium is added to the job group.</p>
</li>
<li>
<p>An intuitive table within the web UI for adding additional test scenarios to
existing media including the possibility to configure the priority values.</p>
</li>
<li>
<p>The scripts <code>openqa-load-templates</code> and <code>openqa-dump-templates</code> to quickly
dump and load the configuration from custom plain-text dump format files
using the REST API.</p>
</li>
<li>
<p>Using declarative schedule definitions in the YAML format using REST API
routes or an online-editor within the web UI including a syntax checker.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_variable_expansion">Variable expansion</h3>
<div class="paragraph">
<p>Any variable defined in Test Suite, Machine, Product or Job Template table can
refer to another variable using this syntax: <code>%NAME%</code>. When the test job is created,
the string will be substituted with the value of the specified variable at that time.</p>
</div>
<div class="paragraph">
<p>For example this variable defined for Test Suite:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span><span class="tok-nv">PUBLISH_HDD_1</span> <span class="tok-o">=</span> %DISTRI%-%VERSION%-%ARCH%-%DESKTOP%.qcow2</code></pre>
</div>
</div>
<div class="paragraph">
<p>may be expanded to this job variable:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span><span class="tok-nv">PUBLISH_HDD_1</span> <span class="tok-o">=</span> opensuse-13.1-i586-kde.qcow2</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_variable_precedence">Variable precedence</h3>
<div class="paragraph">
<p>It&#8217;s possible to define the same variable in multiple places that would all be
used for a single job - for instance, you may have a variable defined in both
a test suite and a product that appear in the same job template. The precedence
order for variables is as follows (from lowest to highest):</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Product</p>
</li>
<li>
<p>Machine</p>
</li>
<li>
<p>Test suite</p>
</li>
<li>
<p>Job template</p>
</li>
<li>
<p>API POST query parameters</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>That is, variable values set as part of the API request that triggers the jobs will
'win' over values set at any of the other locations. In the special case of the
<code>BACKEND</code> variable, if there is a <code>MACHINE</code> specified, the <code>BACKEND</code> value for this
machine defined in openQA has highest priority.</p>
</div>
<div class="paragraph">
<p>If you need to override this precedence - for example, you want the value set in
one particular test suite to take precedence over a setting of the same value from
the API request - you can add a leading + to the variable name. For instance, if
you set <code>+VARIABLE = foo</code> in a test suite, and passed <code>VARIABLE=bar</code> in the API
request, the test suite setting would 'win' and the value would be foo.</p>
</div>
<div class="paragraph">
<p>If the same variable is set with a + prefix in multiple places, the same precedence
order described above will apply to those settings.</p>
</div>
<div class="paragraph">
<p>Note that the <code>WORKER_CLASS</code> variable is not overridden in the way described above.
Instead multiple occurrences are combined.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_use_of_the_web_interface">Use of the web interface</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In general the web UI should be intuitive or self-explanatory. Look out for the
little blue help icons and click them for detailed help on specific sections.</p>
</div>
<div class="paragraph">
<p>Some pages use queries to select what should be shown. The query parameters are
generated on clickable links, for example starting from the index page or the
group overview page clicking on single builds. On the query pages there can be
UI elements to control the parameters, for example to look for more older
builds or only show failed jobs or other settings. Additionally, the query
parameters can be tweaked by hand if you want to provide a link to specific
views.</p>
</div>
<div class="sect2">
<h3 id="_description_of_test_suites">Description of test suites</h3>
<div class="paragraph">
<p>Test suites can be described using API commands or the admin table for any operator using the web UI.</p>
</div>
<div id="test_suite_description_edit" class="imageblock">
<div class="content">
<img src="images/test_suite_description_edit.png" alt="test suite description edit field">
</div>
<div class="title">Figure 2. Entering a test suite description in the admin table using the web interface:</div>
</div>
<div class="paragraph">
<p>If a description is defined, the name of the test suite on the tests overview page shows up as a link. Clicking the link will show the description in a popup. The same syntax as for comments can be used, that is Markdown with custom extensions such as shortened links to ticket systems.</p>
</div>
<div id="test_suite_description_shown" class="imageblock">
<div class="content">
<img src="images/test_suite_description_shown.png" alt="test suite description popup">
</div>
<div class="title">Figure 3. popover in test overview with content as configured in the test suites database:</div>
</div>
</div>
<div class="sect2">
<h3 id="_testsoverview_customizable_test_overview_page">/tests/overview - Customizable test overview page</h3>
<div class="paragraph">
<p>The overview page is configurable by the filter box. Also, some additional
query parameters can be provided which can be considered advanced or
experimental. For example specifying no build will resolve the latest build
which matches the other parameters specified. Specifying no group will show
all jobs from all matching job groups. Also specifying multiple groups works,
see <a href="#overview_multiple_groups">the following example</a>.</p>
</div>
<div id="overview_multiple_groups" class="imageblock">
<div class="content">
<img src="images/tests-overview_multiple_groups.png" alt="test overview page showing multiple groups">
</div>
<div class="title">Figure 4. The openQA test overview page showing multiple groups at once. The URL query parameters specify the groupid parameter two times to resolve both the "opensuse" and "opensuse test" group.</div>
</div>
<div class="paragraph">
<p>Specifying multiple groups with no build will yield the result for the latest
build of each group. This can be useful to have a static URL for bookmarking.</p>
</div>
</div>
<div class="sect2">
<h3 id="_review_badges">Review badges</h3>
<div class="paragraph">
<p>Based on comments in the individual job results for each build a certificate
icon is shown on the group overview page as well as the index page to indicate
that every failure has been reviewed, e.g. a bug reference or a test issue
reason is stated:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/review_badges.png" alt="Review badges">
</div>
</div>
<div class="sect3">
<h4 id="_meaning_of_the_different_colors">Meaning of the different colors</h4>
<div class="ulist">
<ul>
<li>
<p>No icon is shown if at least one failure still need to be reviewed.</p>
</li>
<li>
<p>The green tick icon shows up when there is no work to be done.</p>
</li>
<li>
<p>The black certificate icon is shown if all review work has been done.</p>
</li>
<li>
<p>The grey comment icon is shown if all failures have at least one comment.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>(To simplify, checking for false-negatives is not considered here.)</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_show_bug_or_label_icon_on_overview_if_labeled_gh550">Show bug or label icon on overview if labeled <a href="https://github.com/os-autoinst/openQA/pull/550">gh#550</a></h3>
<div class="ulist">
<ul>
<li>
<p>Show bug icon with URL if mentioned in test comments</p>
</li>
<li>
<p>Show bug or label icon on overview if labeled</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For bugreferences write <code>&lt;bugtracker_shortname&gt;#&lt;bug_nr&gt;</code> in a comment, e.g. "bsc#1234", for generic labels use <code>label:&lt;keyword&gt;</code> where <code>&lt;keyword&gt;</code> can be any valid character up to the next whitespace, e.g. "false_positive". The keywords are not defined within openQA itself. A valid list of keywords should be decided upon within each project or environment of one openQA instance.</p>
</div>
<div id="generic_label" class="imageblock">
<div class="content">
<img src="images/generic_label.png" alt="Example of a generic label">
</div>
<div class="title">Figure 5. Example for a generic label</div>
</div>
<div id="bug_label" class="imageblock">
<div class="content">
<img src="images/bug_label.png" alt="Example of a bug label">
</div>
<div class="title">Figure 6. Example for bug label</div>
</div>
<div class="paragraph">
<p>Related issue: <a href="https://progress.opensuse.org/issues/10212">#10212</a></p>
</div>
<div class="paragraph">
<p>'Hint:' You can also write (or copy-paste) full links to bugs and issues. The links are automatically changed to the shortlinks (e.g. <code><a href="https://progress.opensuse.org/issues/11110" class="bare">https://progress.opensuse.org/issues/11110</a></code> turns into <a href="https://progress.opensuse.org/issues/11110">poo#11110</a>). Related issue: <a href="https://progress.opensuse.org/issues/11110"><strong class="line-through">poo#11110</strong></a></p>
</div>
<div class="paragraph">
<p>Also github pull requests and issues can be linked using the generic format
<code>&lt;marker&gt;[<mark>&lt;project/repo&gt;]</mark>&lt;id&gt;</code>, e.g. <a href="https://github.com/os-autoinst/openQA/issues/1234">gh#os-autoinst/openQA#1234</a>, see <a href="https://github.com/os-autoinst/openQA/pull/973">gh#973</a></p>
</div>
<div class="paragraph">
<p>All issue references are stored within the internal database of openQA. The status can be updated using the <code>/bugs</code> API route for example using external tools.</p>
</div>
<div id="labels_closed_tickets" class="imageblock">
<div class="content">
<img src="images/labels_closed_tickets.png" alt="Example for visualization of closed issue references">
</div>
<div class="title">Figure 7. Example for visualization of closed issue references. Upside down icons in red visualize closed issues.</div>
</div>
</div>
<div class="sect2">
<h3 id="_distinguish_product_and_test_issues_bugref_gh708">Distinguish product and test issues bugref <a href="https://github.com/os-autoinst/openQA/pull/708">gh#708</a></h3>
<div class="paragraph">
<p>&#8220;progress.opensuse.org&#8221; is used to track test issues, bugzilla for product
issues, at least for SUSE/openSUSE. openQA bugrefs distinguish this and show
corresponding icons</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/tests-overview-issue_icon.png" alt="Different icons for product and test issues">
</div>
</div>
</div>
<div class="sect2">
<h3 id="_build_tagging">Build tagging</h3>
<div class="sect3">
<h4 id="_tag_builds_with_special_comments_on_group_overview">Tag builds with special comments on group overview</h4>
<div class="paragraph">
<p>Based on comments on the group overview individual builds can be tagged. As
'build' by themselves do not own any data the job group is used to store this
information. A tag has a build to link it to a build. It also has a type
and an optional description. The type can later on be used to distinguish
tag types.</p>
</div>
<div class="paragraph">
<p>The generic format for tags is</p>
</div>
<div class="listingblock">
<div class="content">
<pre>tag:&lt;build_id&gt;:&lt;type&gt;[:&lt;description&gt;], e.g. tag:1234:important:Beta1.</pre>
</div>
</div>
<div class="paragraph">
<p>The more recent tag always wins.</p>
</div>
<div class="paragraph">
<p>A 'tag' icon is shown next to tagged builds together with the description on
the group_overview page. The index page does not show tags by default to prevent
a potential performance regression. Tags can be enabled on the index page using the
corresponding option in the filter form at the bottom of the page.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/build_tagging.png" alt="Example of a tag comment and corresponding tagged build">
</div>
</div>
</div>
<div class="sect3">
<h4 id="_keeping_important_builds">Keeping important builds</h4>
<div class="paragraph">
<p>As builds can now be tagged we come up with the convention that the
'important' type - the only one for now - is used to tag every job that
corresponds to a build as 'important' and keep the logs for these jobs longer so that
we can always refer to the attached data, e.g. for milestone builds, final
releases, jobs for which long-lasting bug reports exist, etc.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_filtering_test_results_and_builds">Filtering test results and builds</h3>
<div class="paragraph">
<p>At the top of the test results overview page is a form which allows filtering tests by result,
architecture and TODO-status.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/filter_form.png" alt="Filter form">
</div>
</div>
<div class="paragraph">
<p>There is also a similar form at the bottom of the index page which allows filtering builds by
group and customizing the limits.</p>
</div>
</div>
<div class="sect2">
<h3 id="_highlighting_job_dependencies_in_all_tests_table">Highlighting job dependencies in 'All tests' table</h3>
<div class="paragraph">
<p>When hovering over the branch icon after the test name children of the job will
be highlighted blue and parents red. So far this only works for jobs displayed on
the same page of the table.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/highlighting_job_dependencies.png" alt="highlighted child jobs">
</div>
</div>
</div>
<div class="sect2">
<h3 id="_show_previous_results_in_test_results_page_gh538">Show previous results in test results page <a href="https://github.com/os-autoinst/openQA/pull/538">gh#538</a></h3>
<div class="paragraph">
<p>On a tests result page there is a tab for &#8220;Next &amp; previous results&#8221; showing
the result of test runs in the same scenario. This shows next and previous
builds as well as test runs in the same build. This way you can easily check
and compare results from before including any comments, labels, bug references
(see next section). This helps to answer questions like &#8220;Is this a new
issue&#8221;, &#8220;Is it reproducible&#8221;, &#8220;has it been seen in before&#8221;, &#8220;how does
the history look like&#8221;.</p>
</div>
<div class="paragraph">
<p>Querying the database for former test runs of the same scenario is a
rather costly operation which we do not want to do for multiple test
results at once but only for each individual test result (1:1 relation).
This is why this is done in each individual test result and not for a
complete build.</p>
</div>
<div class="paragraph">
<p>Related issue: <a href="https://progress.opensuse.org/issues/10212">#10212</a></p>
</div>
<div class="paragraph">
<p>Screenshot of the feature:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/test_details-next_and_previous.png" alt="Next and previous job results">
</div>
</div>
</div>
<div class="sect2">
<h3 id="_link_to_latest_in_scenario_name_gh836">Link to latest in scenario name <a href="https://github.com/os-autoinst/openQA/pull/836">gh#836</a></h3>
<div class="paragraph">
<p>Find the always latest job in a scenario with the link after the
scenario name in the tab &#8220;Next &amp; previous results&#8221; Screenshot:
image::images/test_details-link_to_latest.png[Link to latest in scenario]</p>
</div>
</div>
<div class="sect2">
<h3 id="_add_latest_query_route_gh815">Add `latest' query route <a href="https://github.com/os-autoinst/openQA/pull/815">gh#815</a></h3>
<div class="paragraph">
<p>Should always refer to most recent job for the specified scenario.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>have the same link for test development, i.e. if one retriggers tests,
the person has to always update the URL. If there would be a static URL
even the browser can be instructed to reload the page automatically</p>
</li>
<li>
<p>for linking to the always current execution of the last job within one
scenario, e.g. to respond faster to the standard question in bug reports
&#8220;does this bug still happen?&#8221;</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Examples:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>tests/latest?distri=opensuse&amp;version=13.1&amp;flavor=DVD&amp;arch=x86_64&amp;test=kde&amp;machine=64bit</code></p>
</li>
<li>
<p><code>tests/latest?flavor=DVD&amp;arch=x86_64&amp;test=kde</code></p>
</li>
<li>
<p><code>tests/latest?test=foobar</code> - this searches for the most recent job
using test_suite `foobar' covering all distri, version, flavor, arch,
machines. To be more specific, add the other query entries.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_allow_group_overview_query_by_result_gh531">Allow group overview query by result <a href="https://github.com/os-autoinst/openQA/pull/531">gh#531</a></h3>
<div class="paragraph">
<p>This allows e.g. to show only failed builds. Could be included like in
<a href="http://lists.opensuse.org/opensuse-factory/2016-02/msg00018.html" class="bare">http://lists.opensuse.org/opensuse-factory/2016-02/msg00018.html</a> for
&#8220;known defects&#8221;.</p>
</div>
<div class="paragraph">
<p>Example: Add query parameters like <code>…&amp;result=failed&amp;arch=x86_64</code> to show
only failed for the single architecture selected.</p>
</div>
</div>
<div class="sect2">
<h3 id="_add_web_ui_controls_to_select_more_builds_in_group_overview_gh804">Add web UI controls to select more builds in group_overview <a href="https://github.com/os-autoinst/openQA/pull/804">gh#804</a></h3>
<div class="paragraph">
<p>The query parameter `limit_builds' allows to show more than the default
10 builds on demand. Just like we have for configuring previous results,
the current commit adds web UI selections to reload the same page with
higher number of builds on demand. For this, the limit of days is
increased to show more builds but still limited by the selected number.</p>
</div>
<div class="paragraph">
<p>Example screenshot:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/job_group-limit_builds.png" alt="Select different limit for number of displayed builds">
</div>
</div>
</div>
<div class="sect2">
<h3 id="_more_query_parameters_for_configuring_last_builds_gh575">More query parameters for configuring last builds <a href="https://github.com/os-autoinst/openQA/pull/575">gh#575</a></h3>
<div class="paragraph">
<p>By using advanced query parameters in the URLs you can configure the
search for builds. Higher numbers would yield more complex database
queries but can be selected for special investigation use cases with the
advanced query parameters, e.g. if one wants to get an overview of a
longer history. This applies to both the index dashboard and group
overview page.</p>
</div>
<div class="paragraph">
<p>Example to show up to three week old builds instead of the default two
weeks with up to 20 builds instead of up to 10 being the default for the
group overview page:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>http://openqa/group_overview/1?time_limit_days=21&amp;limit_builds=20</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_web_ui_controls_to_filter_only_tagged_or_all_builds_gh807">Web UI controls to filter only tagged or all builds <a href="https://github.com/os-autoinst/openQA/pull/807">gh#807</a></h3>
<div class="paragraph">
<p>Using a new query parameter `only_tagged=[0|1]' the list can be
filtered, e.g. show only tagged (important) builds.</p>
</div>
<div class="paragraph">
<p>Example screenshot:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/job_group-limit_builds_tagged.png" alt="Show only tagged or all builds">
</div>
</div>
<div class="paragraph">
<p>Related issue: <a href="https://progress.opensuse.org/issues/11052">#11052</a></p>
</div>
</div>
<div class="sect2">
<h3 id="_carry_over_bugrefs_from_previous_jobs_in_same_scenario_if_still_failing_gh564">Carry over bugrefs from previous jobs in same scenario if still failing <a href="https://github.com/os-autoinst/openQA/pull/564">gh#564</a></h3>
<div class="paragraph">
<p>It is possible to label all failing tests but tedious to do by a human
user as many failures are just having the same issue until it gets
fixed. It helps if a label is preserved for a build that is still
failing. This idea is inspired by
<a href="https://wiki.jenkins-ci.org/display/JENKINS/Claim+plugin" class="bare">https://wiki.jenkins-ci.org/display/JENKINS/Claim+plugin</a> and has been
activated for bugrefs.</p>
</div>
<div class="paragraph">
<p>Does not carry over bugrefs over passes: After a job passed a new issue
in a subsequent fail is assumed to be failed for a different reason.</p>
</div>
<div class="paragraph">
<p>Related issue: <a href="https://progress.opensuse.org/issues/10212">#10212</a></p>
</div>
<div class="paragraph">
<p>Note that the carry-over feature works based on test module level. Only if the
same module as in a predecessor job fails the latest label is carried over.</p>
</div>
<div class="paragraph">
<p>For an approach to label jobs based on a search expression found in the job
reason for incomplete jobs or job logs consider to
<a href="#_enable_custom_hook_scripts_on_job_done_based_on_result">Enable custom hook scripts on "job done" based on result</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_pinning_comments_as_group_description">Pinning comments as group description</h3>
<div class="paragraph">
<p>This is possible by adding the keyword <code>pinned-description</code> anywhere in
a comment on the group overview page. Then the comment will be shown at
the top of the group overview page. However, it only works as operator
or admin.</p>
</div>
</div>
<div class="sect2">
<h3 id="_developer_mode">Developer mode</h3>
<div class="paragraph">
<p>The developer mode allows to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Create or update needles from <code>assert_screen</code> mismatches ("re-needling")</p>
</li>
<li>
<p>Pause the test execution (at a certain module) for manual investigation of the SUT</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>It can be accessed via the "Live View" tab of a running test. Only registered
users can take control over a tests. Basic instructions and buttons providing further
information about the different options are already contained on the web page itself.
So I am not repeating that information here and rather explain the overall workflow.</p>
</div>
<div class="paragraph">
<p>In case the developer mode in not working on your instance, try to follow the
<a href="#debugdevelmode">steps for debugging the developer mode under 'Pitfalls'</a>.</p>
</div>
<div class="sect3">
<h4 id="_workflow_for_creating_or_updating_needles">Workflow for creating or updating needles</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>In case a new needles should be created, add the corresponding <code>assert_screen</code> calls
to your test.</p>
</li>
<li>
<p>Start the test with the <code>assert_screen</code> calls which are supposed to fail.</p>
</li>
<li>
<p>Select "`assert_screen` timeout" under "Pause on screen mismatch" and confirm.</p>
</li>
<li>
<p>Wait until the test has paused. There is a button to skip the current timeout to speed
this up.</p>
</li>
<li>
<p>A button for accessing the needle editor should occur. It may take a few seconds till
it occurs because the screenshots created so far need to be uploaded from the worker to
the web UI. Of course it is also possible to go back to the "Details" tab to create a new
needle from any previous screenshot/match available.</p>
</li>
<li>
<p>After creating the new needle, click the resume button to test whether it worked.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Steps 4. to 6. can be repeated for further needles without restarting the test.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_job_group_editor_gh2111">Job group editor <a href="https://github.com/os-autoinst/openQA/pull/2111">gh#2111</a></h3>
<div class="paragraph">
<p>Scenarios are defined as part of a job group. The <code>Edit job group</code> button exposes the editor.</p>
</div>
<div class="sect3">
<h4 id="_yaml_job_templates_editor">YAML job templates editor</h4>
<div class="paragraph">
<p>Settings can be specified as a key/value pair for each scenario. There is no
equivalent in the table view so you need to migrate groups to use this feature.</p>
</div>
<div class="paragraph">
<p>Any settings specified on test suites, machines or products are also used and
can still be modified independently. However, the YAML document should be
updated before renaming or deleting test suites, products or machines used by
it, otherwise that would create an inconsistent state.</p>
</div>
<div class="paragraph">
<p>Job groups can be updated through the YAML editor or the YAML-related
REST API routes.</p>
</div>
</div>
<div class="sect3">
<h4 id="_deprecated_table_based_pre_migration">Deprecated: Table-based (pre-migration)</h4>
<div class="paragraph">
<p>In old versions openQA had a table-based UI for defining job templates, listed
in a table per medium. Machines can be added by selecting the architecture
column and picking a machine from the list. Remove scenarios by removing all
of their machines. Add new scenarios via the blue Plus icon at the top of the
table. Changes to the priority are applied immediately.</p>
</div>
<div class="paragraph">
<p>If job groups still exist showing the old mode, the <code>Edit YAML</code> button can be
used to reveal the YAML editor and migrate a group. After saving for the first
time, the group can only be configured in YAML. The table view will not be
shown anymore.</p>
</div>
<div class="paragraph">
<p>Note that making a backup before migrating groups may be a good idea, for example using
<code>openqa-dump-templates</code>.</p>
</div>
<div class="paragraph">
<p>To migrate an old job group using the API the current schedule can be
retrieved in YAML format and sent back to save as a complete YAML document.
For example for all job groups in the old format:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span><span class="tok-k">for</span> i <span class="tok-k">in</span> <span class="tok-k">$(</span>ssh openqa.example.com <span class="tok-s2">&quot;sudo -u geekotest psql --no-align --tuples-only --command=\&quot;select id from job_groups where template is null order by id;\&quot; openqa&quot;</span><span class="tok-k">)</span> <span class="tok-p">;</span> <span class="tok-k">do</span>
    curl -s http://openqa.example.com/api/v1/job_templates_scheduling/<span class="tok-nv">$i</span> <span class="tok-p">|</span> openqa-cli api --host http://openqa.example.com -X POST job_templates_scheduling/<span class="tok-nv">$i</span> <span class="tok-nv">schema</span><span class="tok-o">=</span>JobTemplates-01.yaml <span class="tok-nv">template</span><span class="tok-o">=</span><span class="tok-s2">&quot;</span><span class="tok-k">$(</span>cat -<span class="tok-k">)</span><span class="tok-s2">&quot;</span>
<span class="tok-k">done</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that in some cases you might run into errors where old test suites or
products have invalid names which the old editor did not enforce:</p>
</div>
<div class="paragraph">
<p><strong>Product names</strong> may not contain <code>:</code> or <code>@</code> characters. Something like
<code>Server-DVD-Staging:A</code> would require replacing the <code>:</code> with eg. a <code>-</code>.</p>
</div>
<div class="paragraph">
<p><strong>Test suites</strong> may not contain <code>:</code> or <code>@</code> characters. A test suite such as
<code>ext4_uefi@staging</code> would have been allowed previously. The use of the <code>@</code>
as a suffix could be replaced with a <code>-</code> or if it is used for variants of
the same test suite with different settings, settings can be specified in
YAML directly.</p>
</div>
<div class="paragraph">
<p>More generally the regular expression <code>[A-Za-z0-9._*-]+</code> could be used to
check if a name is allowed for a product or test suite.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_configuring_job_groups_via_yaml_documents">Configuring job groups via YAML documents</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A new job group starts out empty, which in YAML means that the two mandatory
sections are present but contain nothing. This is what can be seen when
editing a completely group, and what is also the state to revert to before
deleting a job group that is no longer useful:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">products</span><span class="tok-p">:</span> <span class="tok-p tok-p-Indicator">{}</span>
<span class="tok-nt">scenarios</span><span class="tok-p">:</span> <span class="tok-p tok-p-Indicator">{}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>A job group is comprised of up to three main sections. <code>products</code> defines
one or more mediums to run the scenarios in the group. At least one needs to
be specified to be able to run tests. Going by an example of openSUSE 15.1
the name, distri, flavor and version could be written like so. Note that the
version is a string in single quotes.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">products</span><span class="tok-p">:</span>
  <span class="tok-nt">opensuse-15.1-DVD-Updates-x86_64</span><span class="tok-p">:</span>
    <span class="tok-nt">distri</span><span class="tok-p">:</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">opensuse</span>
    <span class="tok-nt">flavor</span><span class="tok-p">:</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">DVD-Updates</span>
    <span class="tok-nt">version</span><span class="tok-p">:</span> <span class="tok-s">&#39;15.1&#39;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To complete the job group at least one scenario has to be added. A scenario is
a combination of a test suite, a machine and an architecture. Scenarios must
also be unique across job groups - trying to add it to multiple job groups is
an error. Case in point, <code>textmode</code> and <code>gnome</code> could be defined like so:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">scenarios</span><span class="tok-p">:</span>
  <span class="tok-nt">x86_64</span><span class="tok-p">:</span>
    <span class="tok-nt">opensuse-15.1-DVD-Updates-x86_64</span><span class="tok-p">:</span>
    <span class="tok-p tok-p-Indicator">-</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">textmode</span>
    <span class="tok-p tok-p-Indicator">-</span> <span class="tok-nt">gnome</span><span class="tok-p">:</span>
      <span class="tok-nt">machine</span><span class="tok-p">:</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">uefi</span>
      <span class="tok-nt">priority</span><span class="tok-p">:</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">70</span>
      <span class="tok-nt">settings</span><span class="tok-p">:</span>
        <span class="tok-nt">QEMUVGA</span><span class="tok-p">:</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">cirrus</span></code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_defaults">Defaults</h3>
<div class="paragraph">
<p>Now there are two scenarios for <code>x86_64</code>, one by giving just the name of the
test suite and another which has a machine, priority and settings. Both are
allowed. However since at least one scenario relies on defaults those need to
be specified once in their own section:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">defaults</span><span class="tok-p">:</span>
  <span class="tok-nt">x86_64</span><span class="tok-p">:</span>
    <span class="tok-nt">machine</span><span class="tok-p">:</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">64bit</span>
    <span class="tok-nt">priority</span><span class="tok-p">:</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">50</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The defaults section is only required whenever a scenario is not completely
defined in-place. When it is used, the available parameters are identical to
those for a single scenario. For instance the example could be amended to use
settings and run every test suite for that architecture on several machines by
default.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">defaults</span><span class="tok-p">:</span>
  <span class="tok-nt">x86_64</span><span class="tok-p">:</span>
    <span class="tok-nt">machine</span><span class="tok-p">:</span> <span class="tok-p tok-p-Indicator">[</span><span class="tok-nv">64bit</span><span class="tok-p tok-p-Indicator">,</span> <span class="tok-nv">32bit</span><span class="tok-p tok-p-Indicator">]</span>
    <span class="tok-nt">priority</span><span class="tok-p">:</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">50</span>
    <span class="tok-nt">settings</span><span class="tok-p">:</span>
      <span class="tok-nt">FOO</span><span class="tok-p">:</span> <span class="tok-s">&#39;1&#39;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Defaults are always overwritten by explicit parameters on scenarios. Further
more, all settings can be specified in YAML. Using this together with custom
job template names, variants of a scenario can even be specified when they
would normally be considered duplicated:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">scenarios</span><span class="tok-p">:</span>
  <span class="tok-nt">x86_64</span><span class="tok-p">:</span>
    <span class="tok-nt">opensuse-15.1-DVD-Updates-x86_64</span><span class="tok-p">:</span>
    <span class="tok-p tok-p-Indicator">-</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">textmode</span>
    <span class="tok-p tok-p-Indicator">-</span> <span class="tok-nt">gnome</span><span class="tok-p">:</span>
      <span class="tok-nt">machine</span><span class="tok-p">:</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">uefi</span>
      <span class="tok-nt">priority</span><span class="tok-p">:</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">70</span>
      <span class="tok-nt">settings</span><span class="tok-p">:</span>
        <span class="tok-nt">QEMUVGA</span><span class="tok-p">:</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">cirrus</span>
    <span class="tok-p tok-p-Indicator">-</span> <span class="tok-nt">gnome_staging</span><span class="tok-p">:</span>
      <span class="tok-nt">testsuite</span><span class="tok-p">:</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">gnome</span>
      <span class="tok-nt">machine</span><span class="tok-p">:</span> <span class="tok-p tok-p-Indicator">[</span><span class="tok-nv">32bit</span><span class="tok-p tok-p-Indicator">,</span> <span class="tok-nv">64bit-staging</span><span class="tok-p tok-p-Indicator">]</span>
      <span class="tok-nt">settings</span><span class="tok-p">:</span>
        <span class="tok-nt">FOO</span><span class="tok-p">:</span> <span class="tok-s">&#39;2&#39;</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_yaml_aliases">YAML Aliases</h3>
<div class="paragraph">
<p>Even more flexibility can be achieved by using aliases in YAML, or in other
words re-using a scenario by reference, such as to run the same scenarios in
two different mediums. <code>&amp;</code> is used to define an anchor, while <code>*</code> is the alias
referencing the anchor:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">products</span><span class="tok-p">:</span>
  <span class="tok-nt">opensuse-15.1-DVD-Updates-x86_64</span><span class="tok-p">:</span>
    <span class="tok-nt">distri</span><span class="tok-p">:</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">opensuse</span>
    <span class="tok-nt">flavor</span><span class="tok-p">:</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">DVD-Updates</span>
    <span class="tok-nt">version</span><span class="tok-p">:</span> <span class="tok-s">&#39;15.1&#39;</span>
  <span class="tok-nt">opensuse-15.2-GNOME-Live-x86_64</span><span class="tok-p">:</span>
    <span class="tok-nt">distri</span><span class="tok-p">:</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">opensuse</span>
    <span class="tok-nt">flavor</span><span class="tok-p">:</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">GNOME-Live</span>
    <span class="tok-nt">version</span><span class="tok-p">:</span> <span class="tok-s">&#39;15.2&#39;</span>
<span class="tok-nt">scenarios</span><span class="tok-p">:</span>
  <span class="tok-nt">x86_64</span><span class="tok-p">:</span>
    <span class="tok-nt">opensuse-15.1-DVD-Updates-x86_64</span><span class="tok-p">:</span>
    <span class="tok-p tok-p-Indicator">-</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">textmode</span>
    <span class="tok-p tok-p-Indicator">-</span> <span class="tok-nt">gnome</span><span class="tok-p">:</span> <span class="tok-nl">&amp;gnome</span>
      <span class="tok-nt">machine</span><span class="tok-p">:</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">uefi</span>
      <span class="tok-nt">priority</span><span class="tok-p">:</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">70</span>
      <span class="tok-nt">settings</span><span class="tok-p">:</span>
        <span class="tok-nt">QEMUVGA</span><span class="tok-p">:</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">cirrus</span>
    <span class="tok-p tok-p-Indicator">-</span> <span class="tok-nt">gnome_staging</span><span class="tok-p">:</span> <span class="tok-nl">&amp;gnome_staging</span>
      <span class="tok-nt">testsuite</span><span class="tok-p">:</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">gnome</span>
      <span class="tok-nt">machine</span><span class="tok-p">:</span> <span class="tok-p tok-p-Indicator">[</span><span class="tok-nv">32bit</span><span class="tok-p tok-p-Indicator">,</span> <span class="tok-nv">64bit-staging</span><span class="tok-p tok-p-Indicator">]</span>
      <span class="tok-nt">settings</span><span class="tok-p">:</span>
        <span class="tok-nt">FOO</span><span class="tok-p">:</span> <span class="tok-s">&#39;2&#39;</span>
    <span class="tok-nt">opensuse-15.2-GNOME-Live-x86_64</span><span class="tok-p">:</span>
    <span class="tok-p tok-p-Indicator">-</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">textmode</span>
    <span class="tok-p tok-p-Indicator">-</span> <span class="tok-nt">gnome</span><span class="tok-p">:</span> <span class="tok-nv">*gnome</span>
    <span class="tok-p tok-p-Indicator">-</span> <span class="tok-nt">gnome_staging</span><span class="tok-p">:</span> <span class="tok-nv">*gnome_staging</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_yaml_merge_keys">YAML Merge Keys</h3>
<div class="paragraph">
<p>Also <a href="https://yaml.org/type/merge.html">YAML Merge Keys</a> are supported.
This way you can reuse previously defined anchors and add other values to it.
Values in the merged alias will be overridden.</p>
</div>
<div class="paragraph">
<p>You can even merge more than one alias.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">products</span><span class="tok-p">:</span>
  <span class="tok-nt">opensuse-15.1-DVD-Updates-x86_64</span><span class="tok-p">:</span>
    <span class="tok-nt">distri</span><span class="tok-p">:</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">opensuse</span>
    <span class="tok-nt">flavor</span><span class="tok-p">:</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">DVD-Updates</span>
    <span class="tok-nt">version</span><span class="tok-p">:</span> <span class="tok-s">&#39;15.1&#39;</span>
  <span class="tok-nt">opensuse-15.2-GNOME-Live-x86_64</span><span class="tok-p">:</span>
    <span class="tok-nt">distri</span><span class="tok-p">:</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">opensuse</span>
    <span class="tok-nt">flavor</span><span class="tok-p">:</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">GNOME-Live</span>
    <span class="tok-nt">version</span><span class="tok-p">:</span> <span class="tok-s">&#39;15.2&#39;</span>
<span class="tok-nt">scenarios</span><span class="tok-p">:</span>
  <span class="tok-nt">x86_64</span><span class="tok-p">:</span>
    <span class="tok-nt">opensuse-15.1-DVD-Updates-x86_64</span><span class="tok-p">:</span>
    <span class="tok-p tok-p-Indicator">-</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">textmode</span>
    <span class="tok-p tok-p-Indicator">-</span> <span class="tok-nt">gnome</span><span class="tok-p">:</span>
      <span class="tok-nt">machine</span><span class="tok-p">:</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">uefi</span>
      <span class="tok-nt">priority</span><span class="tok-p">:</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">70</span>
      <span class="tok-nt">settings</span><span class="tok-p">:</span> <span class="tok-nl">&amp;common1</span>
        <span class="tok-nt">QEMUVGA</span><span class="tok-p">:</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">cirrus</span>
        <span class="tok-nt">FOO</span><span class="tok-p">:</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">default foo</span>
    <span class="tok-p tok-p-Indicator">-</span> <span class="tok-nt">gnome</span><span class="tok-p">:</span>
      <span class="tok-nt">machine</span><span class="tok-p">:</span> <span class="tok-p tok-p-Indicator">[</span><span class="tok-nv">32bit</span><span class="tok-p tok-p-Indicator">,</span> <span class="tok-nv">64bit-staging</span><span class="tok-p tok-p-Indicator">]</span>
      <span class="tok-nt">priority</span><span class="tok-p">:</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">70</span>
      <span class="tok-nt">settings</span><span class="tok-p">:</span> <span class="tok-nl">&amp;common2</span>
        <span class="tok-nt">QEMUVGA</span><span class="tok-p">:</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">cirrus</span>
        <span class="tok-nt">FOO</span><span class="tok-p">:</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">default foo</span>
        <span class="tok-nt">BAR</span><span class="tok-p">:</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">default bar</span>
    <span class="tok-p tok-p-Indicator">-</span> <span class="tok-nt">gnome_staging</span><span class="tok-p">:</span>
      <span class="tok-nt">testsuite</span><span class="tok-p">:</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">gnome</span>
      <span class="tok-nt">machine</span><span class="tok-p">:</span> <span class="tok-p tok-p-Indicator">[</span><span class="tok-nv">32bit</span><span class="tok-p tok-p-Indicator">,</span> <span class="tok-nv">64bit-staging</span><span class="tok-p tok-p-Indicator">]</span>
      <span class="tok-nt">settings</span><span class="tok-p">:</span>
        <span class="tok-c1"># Merge</span>
        <span class="tok-nt">&lt;&lt;</span><span class="tok-p">:</span> <span class="tok-nv">*common1</span>
        <span class="tok-nt">FOO</span><span class="tok-p">:</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">foo</span> <span class="tok-c1"># overrides the value from the merge keys</span>
    <span class="tok-p tok-p-Indicator">-</span> <span class="tok-nt">gnome_staging</span><span class="tok-p">:</span>
      <span class="tok-nt">testsuite</span><span class="tok-p">:</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">gnome</span>
      <span class="tok-nt">machine</span><span class="tok-p">:</span> <span class="tok-p tok-p-Indicator">[</span><span class="tok-nv">32bit</span><span class="tok-p tok-p-Indicator">,</span> <span class="tok-nv">64bit-staging</span><span class="tok-p tok-p-Indicator">]</span>
      <span class="tok-nt">settings</span><span class="tok-p">:</span>
        <span class="tok-c1"># Merge</span>
        <span class="tok-nt">&lt;&lt;</span><span class="tok-p">:</span> <span class="tok-p tok-p-Indicator">[</span><span class="tok-nv">*common1</span><span class="tok-p tok-p-Indicator">,</span> <span class="tok-nv">*common2</span><span class="tok-p tok-p-Indicator">]</span> <span class="tok-c1"># *common1 overrides *common2</span>
        <span class="tok-nt">FOO</span><span class="tok-p">:</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">foo</span> <span class="tok-c1"># overrides the value from the merge keys</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_general_yaml_documentation">General YAML documentation</h3>
<div class="paragraph">
<p>The job templates are written in <a href="https://yaml.org/spec/1.2/spec.html">YAML
1.2</a>. In YAML, strings usually do not have to be quoted, except if it is a
special value that would be loaded as a Boolean, NULL or Number. The following
table shows all special values (See the documentation for the default <a href="https://yaml.org/spec/1.2/spec.html#id2804923">YAML 1.2 Core Schema</a> for more information).</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 80%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Special Values</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>bool</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>true | True | TRUE | false | False | FALSE</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>int (Base 8)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0o7</code>, <code>0o10</code>, <code>0o755</code></p>
<p class="tableblock">Regular Expression: <code>0o [0-7]+</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>int (Base 10)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>23</code>, <code>+42</code>, <code>0123</code>, <code>-314</code></p>
<p class="tableblock">Regular Expression: <code>[-\+]? [0-9]+</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>int (Base 16)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0xFF</code>, <code>0xa</code>, <code>0xc0ffee</code></p>
<p class="tableblock">Regular Expression: <code>0x [0-9a-fA-F]+</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>float (Number)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>3.14</code>, <code>+3.14</code>, <code>-3.14</code>, <code>3.3e+3</code>, <code>3.3e3</code>, <code>.14</code>, <code>001.23</code>, <code>.3E-1</code>, <code>3e3</code></p>
<p class="tableblock">Regular Expression: <code>[-\+]? ( \. [0-9]+ | [0-9]+ ( \. [0-9]* )? ) ( [eE] [-\+]? [0-9]+ )?</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>float (Infinity)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>.inf</code>, <code>+.inf</code>, <code>-.inf</code>, <code>.Inf</code> etc.</p>
<p class="tableblock">Regular Expression: <code>[-+]? \. ( inf | Inf | INF )</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>float (Not a number)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>.nan</code>, <code>.NaN</code>, <code>.NAN</code></p>
<p class="tableblock">Regular Expression: <code>\. ( nan | NaN |NAN )</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>null</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>null | Null | NULL | ~ | # empty</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>str</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">everything else</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Because we are using the Merge Keys feature, also the unquoted string <code>&lt;&lt;</code> is
special.
If you need the literal string <code>&lt;&lt;</code> (for example as a value in the job
settings), you have to quote it.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_use_of_the_rest_api">Use of the REST API</h2>
<div class="sectionbody">
<div class="paragraph">
<p>openQA includes a <em>client</em> script which - depending on the distribution - is
packaged independently to allow interfacing with an existing openQA instance
without needing to install openQA itself. Call <code>openqa-cli --help</code> for help.
The sub-commands provide further help, e.g. <code>openqa-cli api --help</code> contains
a lot of examples.</p>
</div>
<div class="paragraph">
<p>This section focuses on particular API use-cases. Checkout the
<a href="#client">openQA client</a> section for further information about
the client itself, how authentication works and how plain <code>curl</code> can be used.</p>
</div>
<div class="sect2">
<h3 id="_finding_tests">Finding tests</h3>
<div class="paragraph">
<p>The following example lists all jobs within the job group with the ID <code>1</code>
and the setting <code>BUILD=20210707</code> on <code>openqa.opensuse.org</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span>curl -s <span class="tok-s2">&quot;https://openqa.opensuse.org/api/v1/jobs?groupid=1&amp;build=20210707&quot;</span> <span class="tok-p">|</span> jq</code></pre>
</div>
</div>
<div class="paragraph">
<p>The tool <code>jq</code> is used for pretty-printing in this example but it is also useful
for additional filtering (see js&#8217;s
<a href="https://stedolan.github.io/jq/tutorial">tutorial</a>).</p>
</div>
<div class="paragraph">
<p>However, openQA&#8217;s API provides many more filters on its own. These can be used
by adding additional query parameters, e.g.:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>ids</code>/<code>state</code>/<code>result</code>: Return only jobs with matching ID/state/result.
Multiple IDs/states/results can be specified by repeating the parameter or
by passing comma-separated values.</p>
</li>
<li>
<p><code>distri</code>/<code>version</code>/<code>build</code>/<code>test</code>/<code>arch</code>/<code>machine</code>
/<code>worker_class</code>/<code>iso</code>/<code>hdd_1</code>: Return only jobs where the job settings match
the specified values like in the example above. Note that it is not possible
to filter by arbitrary job settings although this list might not be complete.</p>
</li>
<li>
<p><code>groupid</code>/<code>group</code>: Return only jobs within the job group with the
specified ID/name like in the example above. These parameters are mutually
exclusive, <code>groupid</code> has precedence.</p>
</li>
<li>
<p><code>latest=1</code>: De-duplicates, so that for the same <code>DISTRI</code>, <code>VERSION</code>, <code>BUILD</code>,
<code>TEST</code>, <code>FLAVOR</code>, <code>ARCH</code> and <code>MACHINE</code> only the latest job is returned.</p>
</li>
<li>
<p><code>limit</code>/<code>page</code>: Limit the number of returned jobs and allow pagination, e.g.
<code>page=2&amp;limit=10</code> would only show results 11-20.</p>
</li>
<li>
<p><code>modules</code>/<code>modules_result</code>: Return only jobs which have a test module with the
specified name/result.</p>
</li>
<li>
<p><code>before</code>/<code>after</code>: Return only jobs with a job ID less/greater than the
specified job ID.</p>
</li>
<li>
<p><code>scope=current</code>: Returns only jobs which have not been cloned yet.</p>
</li>
<li>
<p><code>scope=relevant</code>: Returns only jobs which have not been obsoleted yet and
which have not been cloned yet. Clones which are still pending do <strong>not</strong> count.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_remarks">Remarks</h4>
<div class="ulist">
<ul>
<li>
<p>All parameters can be combined with each other unless stated otherwise.</p>
</li>
<li>
<p>When specifying the same parameter multiple times, only the last occurrence
is taken into account.</p>
</li>
<li>
<p>All values are matched exactly, so e.g. <code>group=openSUSE+Leap+15</code> returns only
jobs within the group <code>openSUSE Leap 15</code> but not jobs from the group
<code>openSUSE Leap 15 ARM</code>. This applies to parameters for filtering job settings
as well.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_triggering_tests">Triggering tests</h3>
<div class="paragraph">
<p>Tests can be triggered over multiple ways, using <code>openqa-clone-job</code>,
<code>jobs post</code>, <code>isos post</code> as well as retriggering existing jobs or whole media
over the web UI.</p>
</div>
<div class="sect3">
<h4 id="_cloning_existing_jobs_openqa_clone_job">Cloning existing jobs - openqa-clone-job</h4>
<div class="paragraph">
<p>If one wants to recreate an existing job from any publicly available openQA
instance the script <code>openqa-clone-job</code> can be used to copy the necessary
settings and assets to another instance and schedule the test. For the test to
be executed it has to be ensured that matching resources can be found, for
example a worker with matching <code>WORKER_CLASS</code> must be registered. More details
on <code>openqa-clone-job</code> can be found in
<a href="#writingtests">Writing Tests</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_spawning_single_new_jobs_jobs_post">Spawning single new jobs - jobs post</h4>
<div class="paragraph">
<p>Single jobs can be spawned using the <code>jobs post</code> API route. All necessary
settings on a job must be supplied in the API request. The "openQA client" has
examples for this.</p>
</div>
</div>
<div class="sect3">
<h4 id="_spawning_multiple_jobs_based_on_templates_isos_post">Spawning multiple jobs based on templates - isos post</h4>
<div class="paragraph">
<p>The most common way of spawning jobs on production instances is using the
<code>isos post</code> API route. Based on previously defined settings for media, job
groups, machines and test suites jobs are triggered based on template
matching. The <a href="#gettingstarted">Getting Started</a> guide already
mentioned examples. Additionally to the necessary template matching parameters
more parameters can be specified which are forwarded to all triggered jobs.
There are also special parameters which only have an influence on the way the
triggering itself is done. These parameters all start with a leading
underscore but are set as request parameters in the same way as the other
parameters.</p>
</div>
<div class="hdlist">
<div class="title">The following scheduling parameters exist</div>
<table>
<tr>
<td class="hdlist1">
_OBSOLETE
</td>
<td class="hdlist2">
<p>Obsolete jobs in older builds with same DISTRI and VERSION
(The default behavior is not obsoleting). With this option jobs which are currently pending,
for example scheduled or running, are cancelled when a new medium is triggered.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
_DEPRIORITIZEBUILD
</td>
<td class="hdlist2">
<p>Setting this switch to '1' will deprioritize the unfinished jobs of old
builds, and it will obsolete the jobs once the configurable limit of priority is reached.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
_DEPRIORITIZE_LIMIT
</td>
<td class="hdlist2">
<p>The configurable limit of priority up to which jobs
should be deprioritized. Needs <code>_DEPRIORITIZEBUILD</code>. Default 100.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
_ONLY_OBSOLETE_SAME_BUILD
</td>
<td class="hdlist2">
<p>Only obsolete (or deprioritize) jobs for the same BUILD.
This is useful for cases where a new build appearing does not necessarily
mean existing jobs for earlier builds with the same DISTRI and VERSION are
no longer interesting, but you still want to be able to re-submit jobs for a
build and have existing jobs for the exact same build obsoleted. Needs <code>_OBSOLETE</code>.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
_SKIP_CHAINED_DEPS
</td>
<td class="hdlist2">
<p>Do not schedule parent test suites which are specified in <code>START_AFTER_TEST</code>
or <code>START_DIRECTLY_AFTER_TEST</code>.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
_GROUP
</td>
<td class="hdlist2">
<p>Job templates <strong>not</strong> matching the given group name are ignored. Does <strong>not</strong>
affect obsoletion behavior.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
_GROUP_ID
</td>
<td class="hdlist2">
<p>Same as <code>_GROUP</code> but allows to specify the group directly by ID.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
_PRIORITY
</td>
<td class="hdlist2">
<p>Sets the priority for the new jobs (which otherwise defaults to the priority
of the job template)</p>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Example for <code>_DEPRIORITIZEBUILD</code> and <code>_DEPRIORITIZE_LIMIT</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span>openqa-cli api -X POST isos <span class="tok-nv">ISO</span><span class="tok-o">=</span>my_iso.iso <span class="tok-nv">DISTRI</span><span class="tok-o">=</span>my_distri <span class="tok-nv">FLAVOR</span><span class="tok-o">=</span>sweet <span class="tok-se">\</span>
         <span class="tok-nv">ARCH</span><span class="tok-o">=</span>my_arch <span class="tok-nv">VERSION</span><span class="tok-o">=</span><span class="tok-m">42</span> <span class="tok-nv">BUILD</span><span class="tok-o">=</span><span class="tok-m">1234</span> <span class="tok-se">\</span>
         <span class="tok-nv">_DEPRIORITIZEBUILD</span><span class="tok-o">=</span><span class="tok-m">1</span> <span class="tok-nv">_DEPRIORITIZE_LIMIT</span><span class="tok-o">=</span><span class="tok-m">120</span> <span class="tok-se">\</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_remarks_2">Remarks</h4>
<div class="paragraph">
<p>When scheduling a single test (variable <code>TEST</code> is specified) attempts to
obsolete/deprioritize are prevented by default because this is likely not wanted.
Use <code>_FORCE_OBSOLETE</code> or <code>_FORCE_DEPRIORITIZEBUILD</code> to nevertheless
obsolete/deprioritize <strong>all</strong> jobs with matching <code>DISTRI</code>, <code>VERSION</code>, <code>FLAVOR</code> and <code>ARCH</code>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_job_template_yaml">Job template YAML</h3>
<div class="paragraph">
<p>Job groups can be queried via the experimental REST API:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>api/v1/experimental/job_templates_scheduling</pre>
</div>
</div>
<div class="paragraph">
<p>The GET request will get the YAML for one or multiple groups while a POST request
conversely updates the YAML for a particular group.</p>
</div>
<div class="paragraph">
<p>Two scripts using these routes can be used to import and export YAML templates:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span>openqa-dump-templates --json --group <span class="tok-nb">test</span> &gt; test.json</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span>openqa-load-templates test.json</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_asset_handling">Asset handling</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Multiple parameters exist to reference "assets" to be used by tests. "Assets" are essentially
content that is stored by the openQA web-UI and provided to the workers; when sending jobs to
os-autoinst on the workers, openQA adjusts the parameter values to refer to an absolute path
where the worker will be able to access the content. Things that are typically assets include the
ISOs and other images that are tested, for example.</p>
</div>
<div class="paragraph">
<p>Some assets can also be produced by a job, sent back to the web-UI, and used by a later job (see
explanation of 'storing' and 'publishing' assets, below). Assets can also be seen in the web-UI
and downloaded directly (though there is a configuration option to hide some or all asset types
from public view in the web-UI).</p>
</div>
<div class="paragraph">
<p>The parameters treated as assets are as follows. Where you see e.g. <code>ISO_n</code>, that means <code>ISO_1</code>,
<code>ISO_2</code> etc. will all be treated as assets.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>ISO</code> (type <code>iso</code>)</p>
</li>
<li>
<p><code>ISO_n</code> (type <code>iso</code>)</p>
</li>
<li>
<p><code>HDD_n</code> (type <code>hdd</code>)</p>
</li>
<li>
<p><code>UEFI_PFLASH_VARS</code> (type <code>hdd</code>) (in some cases, see below)</p>
</li>
<li>
<p><code>REPO_n</code> (type <code>repo</code>)</p>
</li>
<li>
<p><code>ASSET_n</code> (type <code>other</code>)</p>
</li>
<li>
<p><code>KERNEL</code> (type <code>other</code>)</p>
</li>
<li>
<p><code>INITRD</code> (type <code>other</code>)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The values of the above parameters are expected to be the name of a file - or, in the case of
<code>REPO_n</code>, a directory - that exists under the path <code>/var/lib/openqa/share/factory</code> on the openQA
web-UI. That path has subdirectories for each of the asset types, and the file or directory must
be in the correct subdirectory, so e.g. the file for an asset <code>HDD_1</code> must be under
<code>/var/lib/openqa/share/factory/hdd</code>. You may create a subdirectory called <code>fixed</code> for any asset
type and place assets there (e.g. in <code>/var/lib/openqa/share/factory/hdd/fixed</code> for <code>hdd</code>-type
assets): this exempts them from the automatic cleanup described under 'Asset cleanup' above.
Non-fixed assets are always subject to the cleanup.</p>
</div>
<div class="paragraph">
<p><code>UEFI_PFLASH_VARS</code> is a special case: whether it is treated as an asset depends on the value. If
the value looks like an absolute path (starts with <code>/</code>), it will not be treated as an asset (and
so the value should be an absolute path for a file which exists on the relevant worker system(s)).
Otherwise, it is treated as an <code>hdd</code>-type asset. This allows tests to use a stock base image
(like the ones provided by edk2) for a simple case, but also allows a job to upload its image on
completion - including any changes made to the UEFI variables during the execution of the job -
for use by a child job which needs to inherit those changes.</p>
</div>
<div class="paragraph">
<p>You can also use special suffixes to the basic parameter forms to access some special handling for
assets.</p>
</div>
<div class="hdlist">
<div class="title">The following suffixes exist:</div>
<table>
<tr>
<td class="hdlist1">
_URL
</td>
<td class="hdlist2">
<p>Before starting these jobs, try to download these assets into the relevant asset directory
of the openQA web-UI from trusted domains specified in <code>/etc/openqa/openqa.ini</code>. For e.g.,
<code>ISO_1_URL=http://trusted.com/foo.iso</code> would, if <code>trusted.com</code> is set as a trusted domain, cause
openQA to download the file <code>foo.iso</code> to <code>/var/lib/openqa/share/factory/iso</code> and set
<code>ISO_1=foo.iso</code>. If you set both <code>ISO_1</code> and <code>ISO_1_URL</code>, the file pointed to by <code>ISO_1_URL</code> will
be downloaded and renamed to the name set as <code>ISO_1</code>.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
_DECOMPRESS_URL
</td>
<td class="hdlist2">
<p>Specify a compressed asset to be downloaded that will be uncompressed by openQA.
For e.g. <code>ISO_1_DECOMPRESS_URL=http://host/foo2.iso.xz</code> will download the file <code>foo2.iso.xz</code>,
uncompress it to <code>foo2.iso</code>, store it in <code>/var/lib/openqa/share/factory/iso</code> and set
<code>ISO_1=foo2.iso</code>. Again, you can also set <code>ISO_1</code> to change the name the file will be downloaded
and uncompressed as.</p>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Assets may be shared between the web-UI and the workers by having them literally use a shared
filesystem (this used to be the only option), or by having the workers download them from the
server when needed and cache them locally. See 'Asset Caching' in the<a href="#Installing.asciidoc">Installing</a>
guide for more on this.</p>
</div>
<div class="paragraph">
<p><code>HDD_n</code> assets can be 'stored' or 'published' by a job, and <code>UEFI_PFLASH_VARS</code> assets can be
'published'. These both mean that if the job completes successfully, the resulting state of those
disk assets will be sent back to the web-UI and made available as an <code>hdd</code>-type asset. To 'store'
an asset, you can specify e.g. <code>STORE_HDD_1</code>. To 'publish' it, you can specify e.g.
<code>PUBLISH_HDD_1</code> or <code>PUBLISH_PFLASH_VARS</code>. If you specify <code>PUBLISH_HDD_1=updated.qcow2</code>, the
<code>HDD_1</code> disk image as it exists at the end of the test will be uploaded back to the web-UI and
stored under the name <code>updated.qcow2</code>; any other job can then specify <code>HDD_1=updated.qcow2</code> to use
this published image as its <code>HDD_1</code>. To force publishing assets even in case
of a failed job one can try the <code>FORCE_PUBLISH_HDD_</code> variable.</p>
</div>
<div class="paragraph">
<p>The difference between 'storing' and 'publishing' is that when 'storing' an asset, it will be
altered in some way (currently, by prepending the job ID to the filename) to associate it with
the particular job that produced it. That means that many jobs can 'store' an asset under "the
same name" without conflicting. Of course, that would seem to make it hard for other jobs to use
the 'stored' image - but for "chained" jobs, the reverse operation is done transparently. This
all means that a 'parent' job template can specify <code>STORE_HDD_1=somename.qcow2</code> and its 'child'
job template(s) can specify <code>HDD_1=somename.qcow2</code>, and everything will work, without multiple
runs of the same jobs overwriting the asset. For more on "chained" jobs, see  'Job dependencies'
in the <a href="#WritingTests.asciidoc">Writing Tests</a> guide.</p>
</div>
<div class="paragraph">
<p>When using this mechanism you will often also want to use the 'Variable expansion' mechanism
described in the <a href="#GettingStarted.asciidoc">Getting Started</a> guide.</p>
</div>
<div class="sect2">
<h3 id="_asset_cleanup">Asset cleanup</h3>
<div class="paragraph">
<p>For more information on assets, see <a href="#_asset_handling">Asset handling</a>
below.</p>
</div>
<div class="paragraph">
<p>Assets like ISO files consume a huge amount of disk space. Therefore openQA
removes assets automatically according to configurable limits.</p>
</div>
<div class="paragraph">
<p>This section provides an overall description of the cleanup strategy and
how to configure the limits. Cleanup-related parameter for the REST API can
be found in the <a href="#_asset_handling">Asset handling</a> section under
<a href="#_use_of_the_rest_api">Use of the REST API</a>.</p>
</div>
<div class="sect3">
<h4 id="_cleanup_strategy">Cleanup strategy</h4>
<div class="paragraph">
<p>openQA frequently checks whether assets need to be removed according to
the configured limits.</p>
</div>
<div class="paragraph">
<p>To find out whether an asset should be removed, openQA determines by which
groups the asset is used. If at least one job within a certain job group is
using an asset, the asset is considered to be used by that job group. If
that job group is within a parent job group, the asset is considered part
of that parent job group.</p>
</div>
<div class="paragraph">
<p>So an asset can belong to multiple job groups or parent job groups. The
assets table which is accessible via the admin menu shows these groups for
each asset and also the latest job.</p>
</div>
<div class="paragraph">
<p>While an asset might belong to multiple groups it is only <strong>accounted</strong>
to the group with the highest asset limit which has still enough room to
hold that asset. That basically mean that an asset is never counted twice.</p>
</div>
<div class="paragraph">
<p>If the size limit for assets of a group is exceeded, openQA will remove
assets which belong to that group:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Assets belonging to old jobs are preferred.</p>
</li>
<li>
<p>Assets belonging to jobs which are still scheduled or running are not
considered.</p>
</li>
<li>
<p>Assets which have been accounted to another group that has still space
left are not considered.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Assets which do <em>not</em> belong to any group are removed after a configurable
duration unless the files are still being updated. Keep in mind that this
behavior is also enabled on local instances and affects all cloned jobs
(unless cloned into a job group).</p>
</div>
<div class="paragraph">
<p>'Fixed' assets - those placed in the <code>fixed</code> subdirectory of the relevant
asset directory - are counted against the group size limit, but are never
cleaned up. This is intended for things like base disk images which must
always be available for a test to work.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_configure_limit_for_assets_within_job_groups">Configure limit for assets within job groups</h3>
<div class="paragraph">
<p>To configure the maximum size for the assets of a group, open 'Job groups'
in the operators menu and select a group. The size limit for assets can be
configured under 'Edit job group properties'. It also shows the size of
assets which belong to that group and not to any other group.</p>
</div>
<div class="paragraph">
<p>The default size limit for job groups can be adjusted in the
<code>default_group_limits</code> section of the openQA config file.</p>
</div>
</div>
<div class="sect2">
<h3 id="_configure_limit_for_groupless_assets">Configure limit for groupless assets</h3>
<div class="paragraph">
<p>Assets not belonging to jobs within a group are deleted automatically
after a certain number of days. That duration can be adjusted by setting
<code>untracked_assets_storage_duration</code> in the <code>misc_limits</code> section of the
openQA config to the desired number of days.</p>
</div>
<div class="paragraph">
<p>In less trivial cases where a common limit is not enough or certain assets
need more fine-grained control, patterns based on the filename can be used.
The patterns are interpreted as Perl regular expressions and if a pattern
matches the basename of an asset the specified duration in days will be used.
In simple cases the pattern is just a match on a word.</p>
</div>
<div class="paragraph">
<p>Consider the following examples to specify custom limits that would match
assets with the names <code>testrepo-latest</code> and <code>openSUSE-12.3-x86_64.iso</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ini"><span></span><span class="tok-k">[assets/storage_duration]</span>
<span class="tok-na">latest</span> <span class="tok-o">=</span> <span class="tok-s">30</span>
<span class="tok-na">openSUSE.+x86_64</span> <span class="tok-o">=</span> <span class="tok-s">10</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that modifications to the file will count against the limit, so if an
asset was updated within the timespan it will not be removed.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_cli_interface">CLI interface</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Beside the <code>daemon</code> argument to run the actual web service the openQA
startup script <code>/usr/share/openqa/script/openqa</code> supports further arguments.</p>
</div>
<div class="paragraph">
<p>For a full list of those commands, just invoke <code>/usr/share/openqa/script/openqa -h</code>.
This also works for sub-commands(e.g. <code>/usr/share/openqa/script/openqa minion -h</code>,
<code>/usr/share/openqa/script/openqa minion job -h</code>).</p>
</div>
<div class="paragraph">
<p>Note that <code>prefork</code> is only supported for the main web service but not for
other services like the live view handler.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_where_to_now_2">Where to now?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>For test developers it is recommended to continue with the
<a href="#writingtests">Test Developer Guide</a>.</p>
</div>
</div>
</div>
<h1 id="writingtests" class="sect0">openQA tests developer guide</h1>
<div class="sect1">
<h2 id="_introduction_4">Introduction</h2>
<div class="sectionbody">
<div class="paragraph">
<p>openQA is an automated test tool that makes it possible to test the whole
installation process of an operating system. It&#8217;s free software released
under the <a href="http://www.gnu.org/licenses/gpl-2.0.html">GPLv2 license</a>. The
source code and documentation are hosted in the
<a href="https://github.com/os-autoinst">os-autoinst organization on GitHub</a>.</p>
</div>
<div class="paragraph">
<p>This document provides the information needed to start developing new tests for
openQA or to improve the existing ones. It&#8217;s
assumed that the reader is already familiar with openQA and has already read the
Starter Guide, available at the
<a href="https://github.com/os-autoinst/openQA">official repository</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_basic">Basic</h2>
<div class="sectionbody">
<div id="basic" class="paragraph">
<p>This section explains the basic layout of openQA tests and the API available in tests.
openQA tests are written in the <strong>Perl</strong> programming language. Some basic but no
in-depth knowledge of Perl is needed. This document assumes that the reader
is already familiar with Perl.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_api">API</h2>
<div class="sectionbody">
<div id="api" class="paragraph">
<p><a href="https://github.com/os-autoinst/os-autoinst/blob/master/testapi.pm">os-autoinst</a> provides the API for the tests using the os-autoinst backend, you can
take a look to the published documentation at <a href="http://open.qa/api/testapi/" class="bare">http://open.qa/api/testapi/</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_how_to_write_tests">How to write tests</h2>
<div class="sectionbody">
<div class="paragraph">
<p>openQA tests need to implement at least the <strong>run</strong> subroutine to
contain the actual test code and the test needs to be loaded in the distribution&#8217;s
main.pm.</p>
</div>
<div class="paragraph">
<p>The <strong>test_flags</strong> subroutine specifies what should happen when test execution of the
current test module is finished depending on the result.
If we should skip execution of the following test modules if current one failed, or it
should be used to create a snapshot of the SUT to rollback to. The following flags
are supported:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>fatal</strong>: The whole test suite is aborted if the test module fails. The overall state
is set to <code>failed</code>.</p>
</li>
<li>
<p><strong>ignore_failure</strong>: If this module fails, it will not affect the overall result at all.</p>
</li>
<li>
<p><strong>milestone</strong>: After this test succeeds, update the 'lastgood' snapshot.</p>
</li>
<li>
<p><strong>no_rollback</strong>: Don&#8217;t roll back to the 'lastgood' snapshot if the test module fails.</p>
</li>
<li>
<p><strong>always_rollback</strong>: Roll back to the 'lastgood' snapshot even if test was successful.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>See the example below for how to enable a test flag.
Note that snapshots are only supported by the QEMU backend. When using other backends
<code>fatal</code> is therefore enabled by default. One can explicitly set it to <code>0</code> to disable
the behavior for all backends even though it is not possible to roll back.</p>
</div>
<div class="paragraph">
<p>There are several callbacks defined:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>post_fail_hook</strong> is called to upload log files or determine the state of
the machine</p>
</li>
<li>
<p><strong>pre_run_hook</strong> is called before the run function - mainly useful for a whole
group of tests</p>
</li>
<li>
<p><strong>post_run_hook</strong> is run after successful run function - mainly useful for a whole
group of tests</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The following example is a basic test that assumes some live image
that boots into the desktop when pressing enter at the boot loader:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="perl"><span></span><span class="tok-k">use</span> <span class="tok-nn">base</span> <span class="tok-s">&quot;basetest&quot;</span><span class="tok-p">;</span>
<span class="tok-k">use</span> <span class="tok-nn">strict</span><span class="tok-p">;</span>
<span class="tok-k">use</span> <span class="tok-nn">testapi</span><span class="tok-p">;</span>

<span class="tok-k">sub</span> <span class="tok-nf">run</span> <span class="tok-p">{</span>
    <span class="tok-c1"># wait for bootloader to appear</span>
    <span class="tok-c1"># with a timeout explicitly lower than the default because</span>
    <span class="tok-c1"># the bootloader screen will timeout itself</span>
    <span class="tok-n">assert_screen</span> <span class="tok-s">&quot;bootloader&quot;</span><span class="tok-p">,</span> <span class="tok-mi">15</span><span class="tok-p">;</span>

    <span class="tok-c1"># press enter to boot right away</span>
    <span class="tok-n">send_key</span> <span class="tok-s">&quot;ret&quot;</span><span class="tok-p">;</span>

    <span class="tok-c1"># wait for the desktop to appear</span>
    <span class="tok-n">assert_screen</span> <span class="tok-s">&quot;desktop&quot;</span><span class="tok-p">,</span> <span class="tok-mi">300</span><span class="tok-p">;</span>
<span class="tok-p">}</span>

<span class="tok-k">sub</span> <span class="tok-nf">test_flags</span> <span class="tok-p">{</span>
    <span class="tok-k">return</span> <span class="tok-p">{</span><span class="tok-n">fatal</span> <span class="tok-o">=&gt;</span> <span class="tok-mi">1</span><span class="tok-p">};</span>
<span class="tok-p">}</span>

<span class="tok-mi">1</span><span class="tok-p">;</span></code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_test_case_examples">Test Case Examples</h3>
<div id="testcase_examples" class="listingblock">
<div class="title">Example: Console test that installs software from remote repository via zypper command</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="perl"><span></span><span class="tok-k">sub</span> <span class="tok-nf">run</span><span class="tok-p">()</span> <span class="tok-p">{</span>
    <span class="tok-c1"># change to root</span>
    <span class="tok-n">become_root</span><span class="tok-p">;</span>

    <span class="tok-c1"># output zypper repos to the serial</span>
    <span class="tok-n">script_run</span> <span class="tok-s">&quot;zypper lr -d &gt; /dev/$serialdev&quot;</span><span class="tok-p">;</span>

    <span class="tok-c1"># install xdelta and check that the installation was successful</span>
    <span class="tok-n">assert_script_run</span> <span class="tok-s">&#39;zypper --gpg-auto-import-keys -n in xdelta&#39;</span><span class="tok-p">;</span>

    <span class="tok-c1"># additionally write a custom string to serial port for later checking</span>
    <span class="tok-n">script_run</span> <span class="tok-s">&quot;echo &#39;xdelta_installed&#39; &gt; /dev/$serialdev&quot;</span><span class="tok-p">;</span>

    <span class="tok-c1"># detecting whether &#39;xdelta_installed&#39; appears in the serial within 200 seconds</span>
    <span class="tok-nb">die</span> <span class="tok-s">&quot;we could not see expected output&quot;</span> <span class="tok-k">unless</span> <span class="tok-n">wait_serial</span> <span class="tok-s">&quot;xdelta_installed&quot;</span><span class="tok-p">,</span> <span class="tok-mi">200</span><span class="tok-p">;</span>

    <span class="tok-c1"># capture a screenshot and compare with needle &#39;test-zypper_in&#39;</span>
    <span class="tok-n">assert_screen</span> <span class="tok-s">&#39;test-zypper_in&#39;</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example: Typical X11 test testing kate</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="perl"><span></span><span class="tok-k">sub</span> <span class="tok-nf">run</span><span class="tok-p">()</span> <span class="tok-p">{</span>
    <span class="tok-c1"># make sure kate was installed</span>
    <span class="tok-c1"># if not ensure_installed will try to install it</span>
    <span class="tok-n">ensure_installed</span> <span class="tok-s">&#39;kate&#39;</span><span class="tok-p">;</span>

    <span class="tok-c1"># start kate</span>
    <span class="tok-n">x11_start_program</span> <span class="tok-s">&#39;kate&#39;</span><span class="tok-p">;</span>

    <span class="tok-c1"># check that kate execution succeeded</span>
    <span class="tok-n">assert_screen</span> <span class="tok-s">&#39;kate-welcome_window&#39;</span><span class="tok-p">;</span>

    <span class="tok-c1"># close kate&#39;s welcome window and wait for the window to disappear before</span>
    <span class="tok-c1"># continuing</span>
    <span class="tok-n">wait_screen_change</span> <span class="tok-p">{</span> <span class="tok-n">send_key</span> <span class="tok-s">&#39;alt-c&#39;</span> <span class="tok-p">};</span>

    <span class="tok-c1"># typing a string in the editor window of kate</span>
    <span class="tok-n">type_string</span> <span class="tok-s">&quot;If you can see this text kate is working.\n&quot;</span><span class="tok-p">;</span>

    <span class="tok-c1"># check the result</span>
    <span class="tok-n">assert_screen</span> <span class="tok-s">&#39;kate-text_shown&#39;</span><span class="tok-p">;</span>

    <span class="tok-c1"># quit kate</span>
    <span class="tok-n">send_key</span> <span class="tok-s">&#39;ctrl-q&#39;</span><span class="tok-p">;</span>

    <span class="tok-c1"># make sure kate was closed</span>
    <span class="tok-n">assert_screen</span> <span class="tok-s">&#39;desktop&#39;</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In addition to Perl, it is possible to write tests in Python. Although the
boilerplate is slightly different the function names are the same.</p>
</div>
<div class="listingblock">
<div class="title">Example: Test for the openQA web UI written in Python</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-kn">from</span> <span class="tok-nn">testapi</span> <span class="tok-kn">import</span> <span class="tok-o">*</span>


<span class="tok-k">def</span> <span class="tok-nf">run</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
    <span class="tok-n">assert_screen</span><span class="tok-p">(</span><span class="tok-s1">&#39;openqa-logged-in&#39;</span><span class="tok-p">)</span>
    <span class="tok-n">assert_and_click</span><span class="tok-p">(</span><span class="tok-s1">&#39;openqa-search&#39;</span><span class="tok-p">)</span>
    <span class="tok-n">type_string</span><span class="tok-p">(</span><span class="tok-s1">&#39;shutdown.pm&#39;</span><span class="tok-p">)</span>
    <span class="tok-n">send_key</span><span class="tok-p">(</span><span class="tok-s1">&#39;ret&#39;</span><span class="tok-p">)</span>
    <span class="tok-n">assert_screen</span><span class="tok-p">(</span><span class="tok-s1">&#39;openqa-search-results&#39;</span><span class="tok-p">)</span>


<span class="tok-k">def</span> <span class="tok-nf">switch_to_root_console</span><span class="tok-p">():</span>
    <span class="tok-n">send_key</span><span class="tok-p">(</span><span class="tok-s1">&#39;ctrl-alt-f3&#39;</span><span class="tok-p">)</span>


<span class="tok-k">def</span> <span class="tok-nf">post_fail_hook</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
    <span class="tok-n">switch_to_root_console</span><span class="tok-p">()</span>
    <span class="tok-n">assert_script_run</span><span class="tok-p">(</span><span class="tok-s1">&#39;openqa-cli api experimental/search q=shutdown.pm&#39;</span><span class="tok-p">)</span>


<span class="tok-k">def</span> <span class="tok-nf">test_flags</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
    <span class="tok-k">return</span> <span class="tok-p">{</span><span class="tok-s1">&#39;fatal&#39;</span><span class="tok-p">:</span> <span class="tok-mi">1</span><span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_variables">Variables</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Test case behavior can be controlled via variables. Some basic
variables like <code>DISTRI</code>, <code>VERSION</code>, <code>ARCH</code> are always set.
Others like <code>DESKTOP</code> are defined by the 'Test suites' in the openQA
web UI.
Check the existing tests at
<a href="https://github.com/os-autoinst/os-autoinst-distri-opensuse">os-autoinst-distri-opensuse
on GitHub</a> for examples.</p>
</div>
<div class="paragraph">
<p>Variables are accessible via the <strong>get_var</strong> and <strong>check_var</strong> functions.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_advanced_test_features">Advanced test features</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_changing_timeouts">Changing timeouts</h3>
<div class="paragraph">
<p>By default, tests are aborted after two hours by the worker. To change this
limit, set the test variable <code>MAX_JOB_TIME</code> to the desired number of seconds.</p>
</div>
<div class="paragraph">
<p>The download of assets, synchronization of tests and other setup tasks do <strong>not</strong>
count into <code>MAX_JOB_TIME</code>. However, the setup time is limited by default to one
hour. This can be changed by setting <code>MAX_SETUP_TIME</code>.</p>
</div>
<div class="paragraph">
<p>To save disk space, increasing <code>MAX_JOB_TIME</code> beyond the default will
automatically disable the video by adding <code>NOVIDEO=1</code> to the test settings. This
can be prevented by adding <code>NOVIDEO=0</code> explicitly.</p>
</div>
<div class="paragraph">
<p>The variable <code>TIMEOUT_SCALE</code> allows to scale <code>MAX_JOB_TIME</code>. This is supposed to
be set within the worker settings on slow worker hosts. It has no influence on
the video setting.</p>
</div>
</div>
<div class="sect2">
<h3 id="_capturing_kernel_exceptions_andor_any_other_exceptions_from_the_serial_console">Capturing kernel exceptions and/or any other exceptions from the serial console</h3>
<div class="paragraph">
<p>Soft and hard failures can be triggered on demand by regular expressions when they match the
serial output which is done after the test is executed. In case it does not make sense
to continue the test run even if the current test module does not have the fatal flag, use <code>fatal</code>
as serial failure type, so all subsequent test modules will not be executed if such failure
was detected.</p>
</div>
<div class="paragraph">
<p>To use this functionality the test developer needs to define the patterns to
look for in the serial output either in the main.pm or in the test itself.
Any pattern change done in a test it will be reflected in the next tests.</p>
</div>
<div class="paragraph">
<p>The patterns defined in <code>main.pm</code> will be valid for all the tests.</p>
</div>
<div class="paragraph">
<p>To simplify tests results review, if job fails with the same message, which is defined
for the pattern, as previous job, automatic comment carryover will work even if
test suites have failed due to different test modules.</p>
</div>
<div class="listingblock">
<div class="title">Example: Defining serial exception capture in the main.pm</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="perl"><span></span><span class="tok-nv">$</span><span class="tok-nn">testapi::</span><span class="tok-nv">distri</span><span class="tok-o">-&gt;</span><span class="tok-n">set_expected_serial_failures</span><span class="tok-p">([</span>
        <span class="tok-p">{</span><span class="tok-n">type</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&#39;soft&#39;</span><span class="tok-p">,</span> <span class="tok-n">message</span>  <span class="tok-o">=&gt;</span> <span class="tok-s">&#39;known issue&#39;</span><span class="tok-p">,</span>  <span class="tok-n">pattern</span> <span class="tok-o">=&gt;</span> <span class="tok-nb">quotemeta</span> <span class="tok-s">&#39;Error&#39;</span><span class="tok-p">},</span>
        <span class="tok-p">{</span><span class="tok-n">type</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&#39;hard&#39;</span><span class="tok-p">,</span> <span class="tok-n">message</span>  <span class="tok-o">=&gt;</span> <span class="tok-s">&#39;broken build&#39;</span><span class="tok-p">,</span> <span class="tok-n">pattern</span> <span class="tok-o">=&gt;</span> <span class="tok-sx">qr/exception/</span><span class="tok-p">},</span>
        <span class="tok-p">{</span><span class="tok-n">type</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&#39;fatal&#39;</span><span class="tok-p">,</span> <span class="tok-n">message</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&#39;critical issue build&#39;</span><span class="tok-p">,</span> <span class="tok-n">pattern</span> <span class="tok-o">=&gt;</span> <span class="tok-sx">qr/kernel oops/</span><span class="tok-p">},</span>
    <span class="tok-p">]</span>
<span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example: Defining serial exception capture in the test</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="perl"><span></span><span class="tok-k">sub</span> <span class="tok-nf">run</span> <span class="tok-p">{</span>
    <span class="tok-k">my</span> <span class="tok-p">(</span><span class="tok-nv">$self</span><span class="tok-p">)</span> <span class="tok-o">=</span> <span class="tok-nv">@_</span><span class="tok-p">;</span>
    <span class="tok-nv">$self</span><span class="tok-o">-&gt;</span><span class="tok-p">{</span><span class="tok-n">serial_failures</span><span class="tok-p">}</span> <span class="tok-o">=</span> <span class="tok-p">[</span>
        <span class="tok-p">{</span><span class="tok-n">type</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&#39;soft&#39;</span><span class="tok-p">,</span> <span class="tok-n">message</span>  <span class="tok-o">=&gt;</span> <span class="tok-s">&#39;known issue&#39;</span><span class="tok-p">,</span>  <span class="tok-n">pattern</span> <span class="tok-o">=&gt;</span> <span class="tok-nb">quotemeta</span> <span class="tok-s">&#39;Error&#39;</span><span class="tok-p">},</span>
        <span class="tok-p">{</span><span class="tok-n">type</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&#39;hard&#39;</span><span class="tok-p">,</span> <span class="tok-n">message</span>  <span class="tok-o">=&gt;</span> <span class="tok-s">&#39;broken build&#39;</span><span class="tok-p">,</span> <span class="tok-n">pattern</span> <span class="tok-o">=&gt;</span> <span class="tok-sx">qr/exception/</span><span class="tok-p">},</span>
        <span class="tok-p">{</span><span class="tok-n">type</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&#39;fatal&#39;</span><span class="tok-p">,</span> <span class="tok-n">message</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&#39;critical issue build&#39;</span><span class="tok-p">,</span> <span class="tok-n">pattern</span> <span class="tok-o">=&gt;</span> <span class="tok-sx">qr/kernel oops/</span><span class="tok-p">},</span>
    <span class="tok-p">];</span>
    <span class="tok-o">...</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example: Adding serial exception capture in the test</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="perl"><span></span><span class="tok-k">sub</span> <span class="tok-nf">run</span> <span class="tok-p">{</span>
    <span class="tok-k">my</span> <span class="tok-p">(</span><span class="tok-nv">$self</span><span class="tok-p">)</span> <span class="tok-o">=</span> <span class="tok-nv">@_</span><span class="tok-p">;</span>
    <span class="tok-nb">push</span> <span class="tok-nv">@$self</span><span class="tok-o">-&gt;</span><span class="tok-p">{</span><span class="tok-n">serial_failures</span><span class="tok-p">},</span> <span class="tok-p">{</span><span class="tok-n">type</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&#39;soft&#39;</span><span class="tok-p">,</span> <span class="tok-n">message</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&#39;known issue&#39;</span><span class="tok-p">,</span>  <span class="tok-n">pattern</span> <span class="tok-o">=&gt;</span> <span class="tok-nb">quotemeta</span> <span class="tok-s">&#39;Error&#39;</span><span class="tok-p">};</span>
    <span class="tok-o">...</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_assigning_jobs_to_workers">Assigning jobs to workers</h3>
<div class="paragraph">
<p>By default, any worker can get any job with the matching architecture.</p>
</div>
<div class="paragraph">
<p>This behavior can be changed by setting job variable WORKER_CLASS. Jobs
with this variable set (typically via machines or test suites configuration) are
assigned only to workers, which have the same variable in the configuration file.</p>
</div>
<div class="paragraph">
<p>For example, the following configuration ensures, that jobs with WORKER_CLASS=desktop
can be assigned <em>only</em> to worker instances 1 and 2.</p>
</div>
<div class="listingblock">
<div class="title">File: workers.ini</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="ini"><span></span><span class="tok-k">[1]</span>
<span class="tok-na">WORKER_CLASS</span> <span class="tok-o">=</span> <span class="tok-s">desktop</span>

<span class="tok-k">[2]</span>
<span class="tok-na">WORKER_CLASS</span> <span class="tok-o">=</span> <span class="tok-s">desktop</span>

<span class="tok-k">[3]</span>
<span class="tok-c1"># WORKER_CLASS is not set</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_writing_multi_machine_tests">Writing multi-machine tests</h3>
<div id="mm-tests" class="paragraph">
<p>Scenarios requiring more than one system under test (SUT), like High Availability testing, are covered as multi-machine tests (MM tests) in this section.</p>
</div>
<div class="paragraph">
<p>OpenQA approaches multi-machine testing by assigning dependencies between individual jobs. This means the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>everything needed for MM tests must be running as a test job</em> (or you are on your own), even support infrastructure (custom DHCP, NFS,
etc. if required), which in principle is not part of the actual testing, must have a defined test suite so a test job can be created</p>
</li>
<li>
<p>OpenQA scheduler makes sure <em>tests are started as a group</em> and in right order, <em>cancelled as a group</em> if some dependencies are violated and <em>cloned as
a group</em> if requested.</p>
</li>
<li>
<p>OpenQA <em>does not synchronize</em> individual steps of the tests.</p>
</li>
<li>
<p>OpenQA provides <em>locking server for basic synchronization</em> of tests (e.g. wait until services are ready for failover), but the <em>correct usage of locks is
test designer job</em> (beware deadlocks).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In short, writing multi-machine tests adds a few more layers of complexity:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>documenting the dependencies and order between individual tests</p>
</li>
<li>
<p>synchronization between individual tests</p>
</li>
<li>
<p>actual technical realization (i.e. <a href="#networking">custom networking</a>)</p>
</li>
</ol>
</div>
<div class="sect3">
<h4 id="_job_dependencies">Job dependencies</h4>
<div class="paragraph">
<p>There are different dependency <strong>types</strong> (see subsequent section). Additionally, dependencies can be machine-specific (see "Inter-machine dependencies" section).</p>
</div>
<div class="sect4">
<h5 id="_dependency_types">Dependency types</h5>
<div class="paragraph">
<p>There are 3 types of dependencies: <code>CHAINED</code>, <code>DIRECTLY_CHAINED</code> and <code>PARALLEL</code></p>
</div>
<div class="sect5">
<h6 id="_chained_dependencies">Chained dependencies</h6>
<div class="paragraph">
<p><code>CHAINED</code> and <code>DIRECTLY_CHAINED</code> describe when one test case depends on another and both are run sequentially, i.e. KDE test suite is run after and only after Installation test suite is successfully finished and cancelled if fail.</p>
</div>
<div class="paragraph">
<p>The difference between <code>CHAINED</code> and <code>DIRECTLY_CHAINED</code> dependencies is that <code>DIRECTLY_CHAINED</code> means the tests must run directly after another on the same worker slot.
This can be useful to test efficiently on bare metal SUTs and other self-provisioning environments.</p>
</div>
<div class="paragraph">
<p>To define a <code>CHAINED</code> dependency add the variable <code>START_AFTER_TEST</code> with the name(s) of test suite(s) after which the selected test suite is supposed to run.
Use comma separated list for multiple test suite dependency. E.g. <code>START_AFTER_TEST="kde,dhcp-server"</code></p>
</div>
<div class="paragraph">
<p>To define a <code>DIRECTLY_CHAINED</code> dependency add the variable <code>START_DIRECTLY_AFTER_TEST</code>. It works in the same way as for <code>CHAINED</code> dependencies. Mismatching worker classes between jobs to run in direct sequence on the same worker are considered an error.</p>
</div>
</div>
<div class="sect5">
<h6 id="_parallel_dependencies">Parallel dependencies</h6>
<div class="paragraph">
<p><code>PARALLEL</code> describes multi-machine tests. That are test suites scheduled to run at the same time and managed as a group. On top of that, <code>PARALLEL</code> also describes
test suite dependencies, where some test suites (children) run parallel with other test suites (parents) only when parents are running.</p>
</div>
<div class="paragraph">
<p>To define a <code>PARALLEL</code> dependency, use the <code>PARALLEL_WITH</code> variable with the name(s) of test suite(s) which acts as a parent suite(s) to selected test suite.
In other words, <code>PARALLEL_WITH</code> describes "I need this test suite to be running during my run". Use a comma separated list for multiple test suite dependency
(e.g. <code>PARALLEL_WITH="web-server,dhcp-server"</code>).
Keep in mind that the parent job <em>must be running until all children finish</em>. Otherwise the scheduler will cancel child jobs once parent is done.</p>
</div>
<div class="paragraph">
<p>Job dependencies are only resolved when using the iso controller to
create new jobs from job templates. Posting individual jobs manually
won&#8217;t work.</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_inter_machine_dependencies">Inter-machine dependencies</h5>
<div class="paragraph">
<p>Those dependencies make it possible to create job dependencies between tests which are supposed to run on different machines.</p>
</div>
<div class="paragraph">
<p>To use it, simply append the machine name for each dependent test suite with an <code>@</code> sign separated.
If a machine is not explicitly defined, the variable <code>MACHINE</code> of the current job is used for the dependent test suite.</p>
</div>
<div class="paragraph">
<p>Example 1:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>START_AFTER_TEST="kde@64bit-1G,dhcp-server@64bit-8G"</pre>
</div>
</div>
<div class="paragraph">
<p>Example 2:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>PARALLEL_WITH="web-server@ipmi-fly,dhcp-server@ipmi-bee,http-server"</pre>
</div>
</div>
<div class="paragraph">
<p>Then, in job templates, add test suite(s) and all of its dependent test suite(s). Keep in mind to place the machines which
have been explicitly defined in a variable for each dependent test suite.
Checkout the following example sections to get a better understanding.</p>
</div>
</div>
<div class="sect4">
<h5 id="_handling_of_related_jobs_on_failure_cancellation_restart">Handling of related jobs on failure / cancellation / restart</h5>
<div class="paragraph">
<p>openQA tries to handle things sensibly when jobs with dependencies either fail, or are manually cancelled or restarted:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>When a chained or parallel parent fails or is cancelled, all children will be cancelled.</p>
</li>
<li>
<p>When a parent is restarted, all children are also restarted recursively.</p>
</li>
<li>
<p>When a parallel child is restarted, the parent and siblings will also be restarted.</p>
</li>
<li>
<p>When a <strong>regularly</strong> chained child is restarted, the parent is not restarted. This will usually be fine, but be aware that if an asset uploaded by the chained parent has been cleaned up, the child may fail immediately. To deal with this case, just restart the parent to recreate the asset.</p>
</li>
<li>
<p>When a <strong>directly</strong> chained child is restarted, all directly chained parents are recursively restarted (but not directly chained siblings). Otherwise it would not be possible to guarantee that the jobs run directly after each other on the same worker.</p>
</li>
<li>
<p>When a parallel <strong>child</strong> fails or is cancelled, the parent and all other children are also cancelled. This behaviour is intended for closely-related clusters of jobs, e.g. high availability tests, where it&#8217;s sensible to assume the entire test is invalid if any of its components fails. A special variable can be used to change this behaviour. Setting a parallel parent job&#8217;s PARALLEL_CANCEL_WHOLE_CLUSTER to a false value, i.e. 0, changes this so that, if one of its children fails or is cancelled but the parent has other pending or active children, the parent and the other children will not be cancelled. This behaviour makes more sense if the parent is providing services to the various children but the children themselves are not closely related and a failure of one does not imply that the tests run by the other children and the parent are invalid.</p>
</li>
</ul>
</div>
<div class="sect5">
<h6 id="_further_notes_2">Further notes</h6>
<div class="ulist">
<ul>
<li>
<p>The API also allows to skip restarting parents via <code>skip_parents=1</code> and to skip restarting children via <code>skip_children=1</code>. It is also possible to skip restarting only passed and softfailed children via <code>skip_ok_result_children=1</code>.</p>
</li>
<li>
<p>Restarting multiple directly chained children individually is not possible because the parent would be restarted twice which is not possible. So one needs to restart the parent job instead. Use the mentioned <code>skip_ok_result_children=1</code> to restart only jobs which are not ok.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_examples">Examples</h5>
<div class="sect5">
<h6 id="_specify_machine_explicitly">Specify machine explicitly</h6>
<div class="paragraph">
<p>Assume there is a test suite <code>A</code> supposed to run on machine <code>64bit-8G</code>. Additionally, test suite <code>B</code> supposed to run on machine <code>64bit-1G</code>.
That means test suite <code>B</code> needs the variable <code>START_AFTER_TEST=A@64bit-8G</code>. This results in the following dependency:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>A@64bit-8G --&gt; B@64bit-1G</pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_implicitly_inherit_machines_from_parent">Implicitly inherit machines from parent</h6>
<div class="paragraph">
<p>Assume test suite <code>A</code> is supposed to run on the machines <code>64bit</code> and <code>ppc</code>. Additionally, test suite <code>B</code> is supposed to run on both of these
machines as well. This can be achieved by simply adding the variable <code>START_AFTER_TEST=A</code> to test suite <code>B</code> (omitting the machine at all).
openQA take the best matches. This results in the following dependencies:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>A@64bit --&gt; B@64bit
A@ppc --&gt; B@ppc</pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_conflicting_machines_prevent_inheritance_from_parent">Conflicting machines prevent inheritance from parent</h6>
<div class="paragraph">
<p>Assume test suite <code>A</code> is supposed to run on machine <code>64bit-8G</code>. Additionally, test suite <code>B</code> is supposed to run on machine <code>64bit-1G</code>.</p>
</div>
<div class="paragraph">
<p>Adding the variable <code>START_AFTER_TEST=A</code> to test suite <code>B</code> will <strong>not</strong> work. That means openQA will <strong>not</strong> create a job dependency and instead shows
an error message. So it is required to explicitly define the variable as <code>START_AFTER_TEST=A@64bit-8G</code> in that case.</p>
</div>
<div class="paragraph">
<p>Consider a different example: Assume test suite <code>A</code> is supposed to run on the machines <code>ppc</code>, <code>64bit</code> and <code>s390x</code>. Additionally, there are 3
testsuites <code>B</code> on <code>ppc-1G</code>, <code>C</code> on <code>ppc-2G</code> and <code>D</code> on <code>ppc64le</code>.</p>
</div>
<div class="paragraph">
<p>Adding the variable <code>PARALLEL_WITH=A@ppc</code> to the test suites <code>B</code>, <code>C</code> and <code>D</code> will result in the following dependencies:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>            A@ppc
              ^
           /  |  \
         /    |    \
B@ppc-1G  C@ppc-2G  D@ppc64le</pre>
</div>
</div>
<div class="paragraph">
<p>openQA will also show errors that test suite <code>A</code> is not necessary on the machines <code>64bit</code> and <code>s390x</code>.</p>
</div>
</div>
<div class="sect5">
<h6 id="_implicitly_creating_a_dependency_on_same_machine">Implicitly creating a dependency on same machine</h6>
<div class="paragraph">
<p>Assume the value of the variable <code>START_AFTER_TEST</code> or <code>PARALLEL_WITH</code> <strong>only</strong> contains a test suite name but no
machine (e.g. <code>START_AFTER_TEST=A,B</code> or <code>PARALLEL_WITH=A,B</code>).</p>
</div>
<div class="paragraph">
<p>In this case openQA will create job dependencies that are scheduled on the same machine if all test suites are placed on the same machine.</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_notes_regarding_directly_chained_dependencies">Notes regarding directly chained dependencies</h5>
<div class="paragraph">
<p>Having multiple jobs with <code>START_DIRECTLY_AFTER_TEST</code> pointing to the same parent job is possible, e.g.:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>   --&gt; B --&gt; C
 /
A
 \
   --&gt; D --&gt; E</pre>
</div>
</div>
<div class="paragraph">
<p>Of course only either <code>B</code> or <code>D</code> jobs can really be started <strong>directly</strong> after <code>A</code>. However, the use of <code>START_DIRECTLY_AFTER_TEST</code> still makes sure that no completely different job is executed in the middle and of course that all of these jobs are executed on the same worker.</p>
</div>
<div class="paragraph">
<p>The directly chained sub-trees are executed in alphabetical order. So the above tree would result in the following execution order: <code>A, B, C, D, E</code>.</p>
</div>
<div class="paragraph">
<p>If <code>A</code> fails, none of the other jobs are attempted to be executed. If <code>B</code> fails, <code>C</code> is not attempted to be executed but <code>D</code> and <code>E</code> are. The assumption is that the average error case does not leave the system in a completely broken state and possibly required cleanup is done in the post fail hook.</p>
</div>
<div class="paragraph">
<p>Directly chained dependencies and regularly chained dependencies can be mixed. This allows to create a dependency tree which contains multiple directly chained sub-trees. Be aware that these sub-trees might be executed on <strong>different</strong> workers and depending on the tree even be executed in parallel.</p>
</div>
</div>
<div class="sect4">
<h5 id="_worker_requirements">Worker requirements</h5>
<div class="paragraph">
<p><code>CHAINED</code> and <code>DIRECTLY_CHAINED</code> dependencies require only one worker. <code>PARALLEL</code> dependencies on the other hand require as many free workers as jobs are present in the
parallel cluster.</p>
</div>
<div class="sect5">
<h6 id="_examples_2">Examples</h6>
<div class="listingblock">
<div class="title">Listing 1. <code>CHAINED</code> - i.e. test basic functionality before going advanced - requires 1 worker</div>
<div class="content">
<pre>A --&gt; B --&gt; C

Define test suite A,
then define B with variable START_AFTER_TEST=A and then define C with START_AFTER_TEST=B

-or-

Define test suite A, B
and then define C with START_AFTER_TEST=A,B
In this case however the start order of A and B is not specified.
But C will start only after A and B are successfully done.</pre>
</div>
</div>
<div class="listingblock">
<div class="title">Listing 2. <code>PARALLEL</code> basic High-Availability</div>
<div class="content">
<pre>A
^
B

Define test suite A
and then define B with variable PARALLEL_WITH=A.
A in this case is parent test suite to B and must be running throughout B run.</pre>
</div>
</div>
<div class="listingblock">
<div class="title">Listing 3. <code>PARALLEL</code> with multiple parents - i.e. complex support requirements for one test - requires 4 workers</div>
<div class="content">
<pre>A B C
\ | /
  ^
  D

Define test suites A,B,C
and then define D with PARALLEL_WITH=A,B,C.
A,B,C run in parallel and are parent test suites for D and all must run until D finish.</pre>
</div>
</div>
<div class="listingblock">
<div class="title">Listing 4. <code>PARALLEL</code> with one parent - i.e. running independent tests against one server - requires at least 2 workers</div>
<div class="content">
<pre>   A
   ^
  /|\
 B C D

Define test suite A
and then define B,C,D with PARALLEL_WITH=A
A is parent test suite for B, C, D (all can run in parallel).
Children B, C, D can run and finish anytime, but A must run until all B, C, D finishes.</pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_test_synchronization_and_locking_api">Test synchronization and locking API</h3>
<div class="paragraph">
<p>OpenQA provides a locking API. To use it in your test files import the <code>lockapi</code> package (<em>use lockapi;</em>). It provides the following functions: <code>mutex_create</code>, <code>mutex_lock</code>, <code>mutex_unlock</code>, <code>mutex_wait</code></p>
</div>
<div class="paragraph">
<p>Each of these functions takes the name of the mutex lock as first parameter. The name must not contain the "-" character. Mutex locks are associated with the caller&#8217;s job.</p>
</div>
<div class="paragraph">
<p><code>mutex_lock</code> tries to lock the mutex for the caller&#8217;s job. The <code>mutex_lock</code> call blocks if the mutex does not exist or has been locked by a different job.</p>
</div>
<div class="paragraph">
<p><code>mutex_unlock</code> tries to unlock the mutex. If the mutex is locked by a different job, <code>mutex_unlock</code> call blocks until the lock becomes available. If the mutex does not exist the call returns immediately without doing anything.</p>
</div>
<div class="paragraph">
<p><code>mutex_wait</code> is a combination of <code>mutex_lock</code> and <code>mutex_unlock</code>. It displays more information about mutex state (time spent waiting, location of the lock). Use it if you need to wait for a specific action from single place (e.g. that Apache is running on the master node).</p>
</div>
<div class="paragraph">
<p><code>mutex_create</code> creates a new mutex which is initially unlocked. If the mutex already exists the call returns immediately without doing anything.</p>
</div>
<div class="paragraph">
<p>Mutexes are addressed by <em>their name</em>. Each cluster of parallel jobs (defined via <code>PARALLEL_WITH</code> dependencies) has its own namespace. That means concurrently running jobs in different parallel job clusters use distinct mutexes (even if the same names are used).</p>
</div>
<div class="paragraph">
<p>The <code>mmapi</code> package provides <code>wait_for_children</code> which the parent can use to wait for the children to complete.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="perl"><span></span><span class="tok-k">use</span> <span class="tok-nn">lockapi</span><span class="tok-p">;</span>
<span class="tok-k">use</span> <span class="tok-nn">mmapi</span><span class="tok-p">;</span>

<span class="tok-c1"># On parent job</span>
<span class="tok-k">sub</span> <span class="tok-nf">run</span> <span class="tok-p">{</span>
    <span class="tok-c1"># ftp service started automatically on boot</span>
    <span class="tok-n">assert_screen</span> <span class="tok-s">&#39;login&#39;</span><span class="tok-p">,</span> <span class="tok-mi">300</span><span class="tok-p">;</span>

    <span class="tok-c1"># unlock by creating the lock</span>
    <span class="tok-n">mutex_create</span> <span class="tok-s">&#39;ftp_service_ready&#39;</span><span class="tok-p">;</span>

    <span class="tok-c1"># wait until all children finish</span>
    <span class="tok-n">wait_for_children</span><span class="tok-p">;</span>
<span class="tok-p">}</span>

<span class="tok-c1"># On child we wait for ftp server to be ready</span>
<span class="tok-k">sub</span> <span class="tok-nf">run</span> <span class="tok-p">{</span>
    <span class="tok-c1"># wait until ftp service is ready</span>
    <span class="tok-c1"># performs mutex lock &amp; unlock internally</span>
    <span class="tok-n">mutex_wait</span> <span class="tok-s">&#39;ftp_service_ready&#39;</span><span class="tok-p">;</span>

    <span class="tok-c1"># connect to ftp and start downloading</span>
    <span class="tok-n">script_run</span> <span class="tok-s">&#39;ftp parent.job.ip&#39;</span><span class="tok-p">;</span>
    <span class="tok-n">script_run</span> <span class="tok-s">&#39;get random_file&#39;</span><span class="tok-p">;</span>
<span class="tok-p">}</span>

<span class="tok-c1"># Mutexes can be used also for garanting exclusive access to resource</span>
<span class="tok-c1"># Example on child when only one job should access ftp at time</span>
<span class="tok-k">sub</span> <span class="tok-nf">run</span> <span class="tok-p">{</span>
    <span class="tok-c1"># wait until ftp service is ready</span>
    <span class="tok-n">mutex_lock</span> <span class="tok-s">&#39;ftp_service_ready&#39;</span><span class="tok-p">;</span>

    <span class="tok-c1"># Perform operation with exclusive access</span>
    <span class="tok-n">script_run</span> <span class="tok-s">&#39;ftp parent.job.ip&#39;</span><span class="tok-p">;</span>
    <span class="tok-n">script_run</span> <span class="tok-s">&#39;put only_i_am_here&#39;</span><span class="tok-p">;</span>
    <span class="tok-n">script_run</span> <span class="tok-s">&#39;bye&#39;</span><span class="tok-p">;</span>

    <span class="tok-c1"># Allow other jobs to connect afterwards</span>
    <span class="tok-n">mutex_unlock</span> <span class="tok-s">&#39;ftp_service_ready&#39;</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Sometimes it is useful to wait for a certain action from the child or sibling job rather than the parent.
In this case the child or sibling will create a mutex and any cluster job can lock/unlock it.</p>
</div>
<div class="paragraph">
<p>The child can however die at any time. To prevent parent deadlock in this situation,
it is required to pass the mutex owner&#8217;s job ID as a second parameter to <code>mutex_lock</code> and <code>mutex_wait</code>.
The mutex owner is the job that creates the mutex.
If a child job with a given ID has already finished, <code>mutex_lock</code> calls die.
The job ID is also required when unlocking such a mutex.</p>
</div>
<div class="exampleblock">
<div class="title">Example of mmapi: Parent JobWait until the child reaches given point</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="perl"><span></span><span class="tok-k">use</span> <span class="tok-nn">lockapi</span><span class="tok-p">;</span>
<span class="tok-k">use</span> <span class="tok-nn">mmapi</span><span class="tok-p">;</span>

<span class="tok-k">sub</span> <span class="tok-nf">run</span> <span class="tok-p">{</span>
    <span class="tok-k">my</span> <span class="tok-nv">$children</span> <span class="tok-o">=</span> <span class="tok-n">get_children</span><span class="tok-p">();</span>

    <span class="tok-c1"># let&#39;s suppose there is only one child</span>
    <span class="tok-k">my</span> <span class="tok-nv">$child_id</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-nb">keys</span> <span class="tok-nv">%$children</span><span class="tok-p">)[</span><span class="tok-mi">0</span><span class="tok-p">];</span>

    <span class="tok-c1"># this blocks until the lock is available and then does nothing</span>
    <span class="tok-n">mutex_wait</span><span class="tok-p">(</span><span class="tok-s">&#39;child_reached_given_point&#39;</span><span class="tok-p">,</span> <span class="tok-nv">$child_id</span><span class="tok-p">);</span>

    <span class="tok-c1"># continue with the test</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Mutexes are a way to wait for specific events from a single job.
When we need multiple jobs to reach a certain state we need to use barriers.</p>
</div>
<div class="paragraph">
<p>To create a barrier call <code>barrier_create</code> with the parameters name and count.
The name serves as an ID (same as with mutexes). The count parameter specifies the
number of jobs needed to call <code>barrier_wait</code> to unlock barrier.</p>
</div>
<div class="paragraph">
<p>There is an optional <code>barrier_wait</code> parameter called <code>check_dead_job</code>.
When used it will kill all jobs waiting in <code>barrier_wait</code> if one of the cluster jobs
dies. It prevents waiting for states that will never be reached (and eventually dies
on job timeout). It should be set only on one of the <code>barrier_wait</code> calls.</p>
</div>
<div class="paragraph">
<p>An example would be one master and three worker jobs and you want to do initial setup
in the three worker jobs before starting main actions. In such a case you might use
<code>check_dead_job</code> to avoid useless actions when one of the worker jobs dies.</p>
</div>
<div class="exampleblock">
<div class="title">Example of barriers: Check for dead jobs while waiting for barrier</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="perl"><span></span><span class="tok-k">use</span> <span class="tok-nn">lockapi</span><span class="tok-p">;</span>

<span class="tok-c1"># In main.pm</span>
<span class="tok-n">barrier_create</span><span class="tok-p">(</span><span class="tok-s">&#39;NODES_CONFIGURED&#39;</span><span class="tok-p">,</span> <span class="tok-mi">4</span><span class="tok-p">);</span>

<span class="tok-c1"># On master job</span>
<span class="tok-k">sub</span> <span class="tok-nf">run</span> <span class="tok-p">{</span>
    <span class="tok-n">assert_screen</span> <span class="tok-s">&#39;login&#39;</span><span class="tok-p">,</span> <span class="tok-mi">300</span><span class="tok-p">;</span>

    <span class="tok-c1"># Master is ready, waiting while workers are configured (check_dead_job is optional)</span>
    <span class="tok-n">barrier_wait</span> <span class="tok-p">{</span><span class="tok-n">name</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;NODES_CONFIGURED&quot;</span><span class="tok-p">,</span> <span class="tok-n">check_dead_job</span> <span class="tok-o">=&gt;</span> <span class="tok-mi">1</span><span class="tok-p">};</span>

    <span class="tok-c1"># When 4 jobs called barrier_wait they are all unblocked</span>
    <span class="tok-n">script_run</span> <span class="tok-s">&#39;create_cluster&#39;</span><span class="tok-p">;</span>
    <span class="tok-n">script_run</span> <span class="tok-s">&#39;test_cluster&#39;</span><span class="tok-p">;</span>

    <span class="tok-c1"># Notify all nodes that we are finished</span>
    <span class="tok-n">mutex_create</span> <span class="tok-s">&#39;CLUSTER_CREATED&#39;</span><span class="tok-p">;</span>
    <span class="tok-n">wait_for_children</span><span class="tok-p">;</span>
<span class="tok-p">}</span>

<span class="tok-c1"># On 3 worker jobs</span>
<span class="tok-k">sub</span> <span class="tok-nf">run</span> <span class="tok-p">{</span>
    <span class="tok-n">assert_screen</span> <span class="tok-s">&#39;login&#39;</span><span class="tok-p">,</span> <span class="tok-mi">300</span><span class="tok-p">;</span>

    <span class="tok-c1"># do initial worker setup</span>
    <span class="tok-n">script_run</span> <span class="tok-s">&#39;zypper in HA&#39;</span><span class="tok-p">;</span>
    <span class="tok-n">script_run</span> <span class="tok-s">&#39;echo IP &gt; /etc/HA/node_setup&#39;</span><span class="tok-p">;</span>

    <span class="tok-c1"># Join the group of jobs waiting for each other</span>
    <span class="tok-n">barrier_wait</span> <span class="tok-s">&#39;NODES_CONFIGURED&#39;</span><span class="tok-p">;</span>

    <span class="tok-c1"># Don&#39;t finish until cluster is created &amp; tested</span>
    <span class="tok-n">mutex_wait</span> <span class="tok-s">&#39;CLUSTER_CREATED&#39;</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Getting information about parents and children</p>
</div>
<div class="exampleblock">
<div class="title">Example of mmapi: Getting info about parents / children</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="perl"><span></span><span class="tok-k">use</span> <span class="tok-nn">base</span> <span class="tok-s">&quot;basetest&quot;</span><span class="tok-p">;</span>
<span class="tok-k">use</span> <span class="tok-nn">strict</span><span class="tok-p">;</span>
<span class="tok-k">use</span> <span class="tok-nn">testapi</span><span class="tok-p">;</span>
<span class="tok-k">use</span> <span class="tok-nn">mmapi</span><span class="tok-p">;</span>

<span class="tok-k">sub</span> <span class="tok-nf">run</span> <span class="tok-p">{</span>
    <span class="tok-c1"># returns a hash ref containing (id =&gt; state) for all children</span>
    <span class="tok-k">my</span> <span class="tok-nv">$children</span> <span class="tok-o">=</span> <span class="tok-n">get_children</span><span class="tok-p">();</span>

    <span class="tok-k">for</span> <span class="tok-k">my</span> <span class="tok-nv">$job_id</span> <span class="tok-p">(</span><span class="tok-nb">keys</span> <span class="tok-nv">%$children</span><span class="tok-p">)</span> <span class="tok-p">{</span>
      <span class="tok-k">print</span> <span class="tok-s">&quot;$job_id is cancelled\n&quot;</span> <span class="tok-k">if</span> <span class="tok-nv">$children</span><span class="tok-o">-&gt;</span><span class="tok-p">{</span><span class="tok-nv">$job_id</span><span class="tok-p">}</span> <span class="tok-ow">eq</span> <span class="tok-s">&#39;cancelled&#39;</span><span class="tok-p">;</span>
    <span class="tok-p">}</span>

    <span class="tok-c1"># returns an array with parent ids, all parents are in running state (see Job dependencies above)</span>
    <span class="tok-k">my</span> <span class="tok-nv">$parents</span> <span class="tok-o">=</span> <span class="tok-n">get_parents</span><span class="tok-p">();</span>

    <span class="tok-c1"># let&#39;s suppose there is only one parent</span>
    <span class="tok-k">my</span> <span class="tok-nv">$parent_id</span> <span class="tok-o">=</span> <span class="tok-nv">$parents</span><span class="tok-o">-&gt;</span><span class="tok-p">[</span><span class="tok-mi">0</span><span class="tok-p">];</span>

    <span class="tok-c1"># any job id can be queried for details with get_job_info()</span>
    <span class="tok-c1"># it returns a hash ref containing these keys:</span>
    <span class="tok-c1">#   name priority state result worker_id</span>
    <span class="tok-c1">#   t_started t_finished test</span>
    <span class="tok-c1">#   group_id group settings</span>
    <span class="tok-k">my</span> <span class="tok-nv">$parent_info</span> <span class="tok-o">=</span> <span class="tok-n">get_job_info</span><span class="tok-p">(</span><span class="tok-nv">$parent_id</span><span class="tok-p">);</span>

    <span class="tok-c1"># it is possible to query variables set by openqa frontend,</span>
    <span class="tok-c1"># this does not work for variables set by backend or by the job at runtime</span>
    <span class="tok-k">my</span> <span class="tok-nv">$parent_name</span> <span class="tok-o">=</span> <span class="tok-nv">$parent_info</span><span class="tok-o">-&gt;</span><span class="tok-p">{</span><span class="tok-n">settings</span><span class="tok-p">}</span><span class="tok-o">-&gt;</span><span class="tok-p">{</span><span class="tok-n">NAME</span><span class="tok-p">}</span>
    <span class="tok-k">my</span> <span class="tok-nv">$parent_desktop</span> <span class="tok-o">=</span> <span class="tok-nv">$parent_info</span><span class="tok-o">-&gt;</span><span class="tok-p">{</span><span class="tok-n">settings</span><span class="tok-p">}</span><span class="tok-o">-&gt;</span><span class="tok-p">{</span><span class="tok-n">DESKTOP</span><span class="tok-p">}</span>
    <span class="tok-c1"># !!! this does not work, VNC is set by backend !!!</span>
    <span class="tok-c1"># my $parent_vnc = $parent_info-&gt;{settings}-&gt;{VNC}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_support_server_based_tests">Support Server based tests</h3>
<div class="paragraph">
<p>The idea is to have a dedicated "helper server" to allow advanced network based testing.</p>
</div>
<div class="paragraph">
<p>Support server takes advantage of the basic parallel setup as described in the previous section, with the support server being the parent test 'A' and the test needing it being the child test 'B'. This ensures that the test 'B' always have the support server available.</p>
</div>
<div class="sect3">
<h4 id="_preparing_the_supportserver">Preparing the supportserver</h4>
<div class="paragraph">
<p>The support server image is created by calling a special test, based on the autoyast test:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span>/usr/share/openqa/script/client <span class="tok-nb">jobs</span> post <span class="tok-nv">DISTRI</span><span class="tok-o">=</span>opensuse <span class="tok-nv">VERSION</span><span class="tok-o">=</span><span class="tok-m">13</span>.2 <span class="tok-se">\</span>
    <span class="tok-nv">ISO</span><span class="tok-o">=</span>openSUSE-13.2-DVD-x86_64.iso  <span class="tok-nv">ARCH</span><span class="tok-o">=</span>x86_64 <span class="tok-nv">FLAVOR</span><span class="tok-o">=</span>Server-DVD <span class="tok-se">\</span>
    <span class="tok-nv">TEST</span><span class="tok-o">=</span>supportserver_generator <span class="tok-nv">MACHINE</span><span class="tok-o">=</span>64bit <span class="tok-nv">DESKTOP</span><span class="tok-o">=</span>textmode  <span class="tok-nv">INSTALLONLY</span><span class="tok-o">=</span><span class="tok-m">1</span> <span class="tok-se">\</span>
    <span class="tok-nv">AUTOYAST</span><span class="tok-o">=</span>supportserver/autoyast_supportserver.xml <span class="tok-nv">SUPPORT_SERVER_GENERATOR</span><span class="tok-o">=</span><span class="tok-m">1</span> <span class="tok-se">\</span>
    <span class="tok-nv">PUBLISH_HDD_1</span><span class="tok-o">=</span>supportserver.qcow2</code></pre>
</div>
</div>
<div class="paragraph">
<p>This produces QEMU image 'supportserver.qcow2' that contains the supportserver. The 'autoyast_supportserver.xml'
should define correct user and password, as well as packages and the common configuration.</p>
</div>
<div class="paragraph">
<p>More specific role the supportserver should take is then selected when the server is run in the actual test scenario.</p>
</div>
</div>
<div class="sect3">
<h4 id="_using_the_supportserver">Using the supportserver</h4>
<div class="paragraph">
<p>In the Test suites, the supportserver is defined by setting:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ini"><span></span><span class="tok-na">HDD_1</span><span class="tok-o">=</span><span class="tok-s">supportserver.qcow2</span>
<span class="tok-na">SUPPORT_SERVER</span><span class="tok-o">=</span><span class="tok-s">1</span>
<span class="tok-na">SUPPORT_SERVER_ROLES</span><span class="tok-o">=</span><span class="tok-s">pxe,qemuproxy</span>
<span class="tok-na">WORKER_CLASS</span><span class="tok-o">=</span><span class="tok-s">server,qemu_autoyast_tap_64</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>where the <code>SUPPORT_SERVER_ROLES</code> defines the specific role (see code in 'tests/support_server/setup.pm' for available roles and their definition), and
 <code>HDD_1</code> variable must be the name of the supportserver image as defined via <code>PUBLISH_HDD_1</code> variable during supportserver generation. If the support
server is based on older SUSE versions (opensuse 11.x, SLE11SP4..) it may also be needed to add <code>HDDMODEL=virtio-blk</code>. In case of QEMU backend, one can
also use <code>BOOTFROM=c</code>, for faster boot directly from the <code>HDD_1</code> image.</p>
</div>
<div class="paragraph">
<p>Then for the 'child' test using this supportserver, the following additional variable must be set:
<code>PARALLEL_WITH=supportserver-pxe-tftp</code>
where 'supportserver-pxe-tftp' is the name given to the supportserver in the test suites screen.
Once the tests are defined, they can be added to openQA in the usual way:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span>/usr/share/openqa/script/client isos post <span class="tok-nv">DISTRI</span><span class="tok-o">=</span>opensuse <span class="tok-nv">VERSION</span><span class="tok-o">=</span><span class="tok-m">13</span>.2 <span class="tok-se">\</span>
        <span class="tok-nv">ISO</span><span class="tok-o">=</span>openSUSE-13.2-DVD-x86_64.iso <span class="tok-nv">ARCH</span><span class="tok-o">=</span>x86_64 <span class="tok-nv">FLAVOR</span><span class="tok-o">=</span>Server-DVD</code></pre>
</div>
</div>
<div class="paragraph">
<p>where the <code>DISTRI</code>, <code>VERSION</code>, <code>FLAVOR</code> and <code>ARCH</code> correspond to the job group containing the tests.
Note that the networking is provided by tap devices, so both jobs should run on machines defined by (apart from others) having <code>NICTYPE=tap</code>, <code>WORKER_CLASS=qemu_autoyast_tap_64</code>.</p>
</div>
<div class="exampleblock">
<div class="title">Example of Support Server: a simple tftp test</div>
<div class="content">
<div class="paragraph">
<p>Let&#8217;s assume that we want to test tftp client operation. For this, we setup the supportserver as a tftp server:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ini"><span></span><span class="tok-na">HDD_1</span><span class="tok-o">=</span><span class="tok-s">supportserver.qcow2</span>
<span class="tok-na">SUPPORT_SERVER</span><span class="tok-o">=</span><span class="tok-s">1</span>
<span class="tok-na">SUPPORT_SERVER_ROLES</span><span class="tok-o">=</span><span class="tok-s">dhcp,tftp</span>
<span class="tok-na">WORKER_CLASS</span><span class="tok-o">=</span><span class="tok-s">server,qemu_autoyast_tap_64</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>With a test-suites name <code>supportserver-opensuse-tftp</code>.</p>
</div>
<div class="paragraph">
<p>The actual test 'child' job, will then have to set <code>PARALLEL_WITH=supportserver-opensuse-tftp</code>, and also other variables according to the test requirements. For convenience, we have also started a dhcp server on the supportserver, but even without it, network could be set up manually by assigning a free ip address (e.g. 10.0.2.15) on the system of the test job.</p>
</div>
<div class="exampleblock">
<div class="title">Example of Support Server: The code in the *.pm module doing the actual tftp test could then look something like the example below</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="perl"><span></span><span class="tok-k">use</span> <span class="tok-nn">strict</span><span class="tok-p">;</span>
<span class="tok-k">use</span> <span class="tok-nn">base</span> <span class="tok-s">&#39;basetest&#39;</span><span class="tok-p">;</span>
<span class="tok-k">use</span> <span class="tok-nn">testapi</span><span class="tok-p">;</span>

<span class="tok-k">sub</span> <span class="tok-nf">run</span> <span class="tok-p">{</span>
  <span class="tok-k">my</span> <span class="tok-nv">$script</span><span class="tok-o">=</span><span class="tok-s">&quot;set -e -x\n&quot;</span><span class="tok-p">;</span>
  <span class="tok-nv">$script</span><span class="tok-o">.=</span><span class="tok-s">&quot;echo test &gt;test.txt\n&quot;</span><span class="tok-p">;</span>
  <span class="tok-nv">$script</span><span class="tok-o">.=</span><span class="tok-s">&quot;time tftp &quot;</span><span class="tok-o">.</span><span class="tok-nv">$server_ip</span><span class="tok-o">.</span><span class="tok-s">&quot; -c put test.txt test2.txt\n&quot;</span><span class="tok-p">;</span>
  <span class="tok-nv">$script</span><span class="tok-o">.=</span><span class="tok-s">&quot;time tftp &quot;</span><span class="tok-o">.</span><span class="tok-nv">$server_ip</span><span class="tok-o">.</span><span class="tok-s">&quot; -c get test2.txt\n&quot;</span><span class="tok-p">;</span>
  <span class="tok-nv">$script</span><span class="tok-o">.=</span><span class="tok-s">&quot;diff -u test.txt test2.txt\n&quot;</span><span class="tok-p">;</span>
  <span class="tok-n">script_output</span><span class="tok-p">(</span><span class="tok-nv">$script</span><span class="tok-p">);</span>

<span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>assuming of course, that the tested machine was already set up with necessary infrastructure for tftp, e.g. network was set up, tftp rpm installed and tftp service started, etc. All of this could be conveniently achieved using the autoyast installation, as shown in the next section.</p>
</div>
<div class="exampleblock">
<div class="title">Example of Support Server: autoyast based tftp test</div>
<div class="content">
<div class="paragraph">
<p>Here we will use autoyast to setup the system of the test job and the os-autoinst autoyast testing infrastructure. For supportserver, this means using proxy to access QEMU provided data, for downloading autoyast profile and tftp verify script:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ini"><span></span><span class="tok-na">HDD_1</span><span class="tok-o">=</span><span class="tok-s">supportserver.qcow2</span>
<span class="tok-na">SUPPORT_SERVER</span><span class="tok-o">=</span><span class="tok-s">1</span>
<span class="tok-na">SUPPORT_SERVER_ROLES</span><span class="tok-o">=</span><span class="tok-s">pxe,qemuproxy</span>
<span class="tok-na">WORKER_CLASS</span><span class="tok-o">=</span><span class="tok-s">server,qemu_autoyast_tap_64</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The actual test 'child' job, will then be defined as :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ini"><span></span><span class="tok-na">AUTOYAST</span><span class="tok-o">=</span><span class="tok-s">autoyast_opensuse/opensuse_autoyast_tftp.xml</span>
<span class="tok-na">AUTOYAST_VERIFY</span><span class="tok-o">=</span><span class="tok-s">autoyast_opensuse/opensuse_autoyast_tftp.sh</span>
<span class="tok-na">DESKTOP</span><span class="tok-o">=</span><span class="tok-s">textmode</span>
<span class="tok-na">INSTALLONLY</span><span class="tok-o">=</span><span class="tok-s">1</span>
<span class="tok-na">PARALLEL_WITH</span><span class="tok-o">=</span><span class="tok-s">supportserver-opensuse-tftp</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>again assuming the support server&#8217;s name being <code>supportserver-opensuse-tftp</code>. Note that the <code>pxe</code> role already contains <code>tftp</code> and <code>dhcp</code> server role, since they are needed for the pxe boot to work.</p>
</div>
<div class="exampleblock">
<div class="title">Example of Support Server: The tftp test defined in the <code>autoyast_opensuse/opensuse_autoyast_tftp.sh</code> file could be something like:</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span><span class="tok-nb">set</span> -e -x
<span class="tok-nb">echo</span> <span class="tok-nb">test</span> &gt;test.txt
<span class="tok-nb">time</span> tftp <span class="tok-c1">#SERVER_URL# -c put test.txt test2.txt</span>
<span class="tok-nb">time</span> tftp <span class="tok-c1">#SERVER_URL# -c get test2.txt</span>
diff -u test.txt test2.txt <span class="tok-o">&amp;&amp;</span> <span class="tok-nb">echo</span> <span class="tok-s2">&quot;AUTOYAST OK&quot;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>and the rest is done automatically, using already prepared test modules in <code>tests/autoyast</code> subdirectory.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_using_text_consoles_and_the_serial_terminal">Using text consoles and the serial terminal</h3>
<div class="paragraph">
<p>Typically the OS you are testing will boot into a graphical shell e.g. The
Gnome desktop environment. This is fine if you wish to test a program with a
GUI, but in many situations you will need to enter commands into a textual
shell (e.g Bash), TTY, text terminal, command prompt, TUI etc.</p>
</div>
<div class="paragraph">
<p>OpenQA has two basic methods for interacting with a text shell. The first uses
the same input and output methods as when interacting with a GUI, plus a
serial port for getting raw text output from the SUT. This is primarily
implemented with VNC and so I will referrer to it as the VNC text console.</p>
</div>
<div class="paragraph">
<p>The serial port device which is used with the VNC text console is the default
virtual serial port device in QEMU (i.e. the device configured with the
<code>-serial</code> command line option). I will refer to this as the "default serial
port". OpenQA currently only uses this serial port for one way communication
from the SUT to the host.</p>
</div>
<div class="paragraph">
<p>The second method uses another serial port for both input and output. The SUT
attaches a TTY to the serial port which os-autoinst logs into. All
communication is therefore text based, similar to if you SSH&#8217;d into a remote
machine. This is called the serial terminal console (or the virtio console,
see implementation section for details).</p>
</div>
<div class="paragraph">
<p>The VNC text console is very slow and expensive relative to the serial
terminal console, but allows you to continue using <code>assert_screen</code> and is more
widely supported. Below is an example of how to use the VNC text console.</p>
</div>
<div class="paragraph">
<div class="title">To access a text based console or TTY, you can do something like the</div>
<p>following.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="perl"><span></span><span class="tok-k">use</span> <span class="tok-mf">5.018</span><span class="tok-p">;</span>
<span class="tok-k">use</span> <span class="tok-nn">warnings</span><span class="tok-p">;</span>
<span class="tok-k">use</span> <span class="tok-nn">base</span> <span class="tok-s">&#39;opensusebasetest&#39;</span><span class="tok-p">;</span>
<span class="tok-k">use</span> <span class="tok-nn">testapi</span><span class="tok-p">;</span>
<span class="tok-k">use</span> <span class="tok-nn">utils</span><span class="tok-p">;</span>

<span class="tok-k">sub</span> <span class="tok-nf">run</span> <span class="tok-p">{</span>
    <span class="tok-n">wait_boot</span><span class="tok-p">;</span>  <span class="tok-c1"># Utility function defined by the SUSE distribution</span>
    <span class="tok-n">select_console</span> <span class="tok-s">&#39;root-console&#39;</span><span class="tok-p">;</span>
<span class="tok-p">}</span>

<span class="tok-mi">1</span><span class="tok-p">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This will select a text TTY and login as the root user (if necessary). Now
that we are on a text console it is possible to run scripts and observe their
output either as raw text or on the video feed.</p>
</div>
<div class="paragraph">
<p>Note that <code>root-console</code> is defined by the distribution, so on different
distributions or operating systems this can vary. There are also many utility
functions that wrap <code>select_console</code>, so check your distribution&#8217;s utility
library before using it directly.</p>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Running a script: Using the <code>assert_script_run</code> and <code>script_output</code> commands</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="perl"><span></span><span class="tok-n">assert_script_run</span><span class="tok-p">(</span><span class="tok-s">&#39;cd /proc&#39;</span><span class="tok-p">);</span>
<span class="tok-k">my</span> <span class="tok-nv">$cpuinfo</span> <span class="tok-o">=</span> <span class="tok-n">script_output</span><span class="tok-p">(</span><span class="tok-s">&#39;cat cpuinfo&#39;</span><span class="tok-p">);</span>
<span class="tok-k">if</span><span class="tok-p">(</span><span class="tok-nv">$cpuinfo</span> <span class="tok-o">=~</span> <span class="tok-sr">m/avx2/</span><span class="tok-p">)</span> <span class="tok-p">{</span>
    <span class="tok-c1"># Do something which needs avx2</span>
<span class="tok-p">}</span>
<span class="tok-k">else</span> <span class="tok-p">{</span>
    <span class="tok-c1"># Do some workaround</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This returns the contents of the SUT&#8217;s /proc/cpuinfo file to the test script
and then searches it for the term 'avx2' using a regex.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>The <code>script_run</code> and <code>script_output</code> are high level commands which use
<code>type_string</code> and <code>wait_serial</code> underneath. Sometimes you may wish to use
lower level commands which give you more control, but be warned that it may
also make your code less portable.</p>
</div>
<div class="paragraph">
<p>The command <code>wait_serial</code> watches the SUT&#8217;s serial port for text output and
matches it against a regex. <code>type_string</code> sends a string to the SUT like it
was typed in by the user over VNC.</p>
</div>
<div class="sect3">
<h4 id="_using_a_serial_terminal">Using a serial terminal</h4>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
You need a QEMU version &gt;= 2.6.1 and to set the
<code>VIRTIO_CONSOLE</code> variable to 1 to use this with the QEMU backend
(it is enabled by default for
<a href="https://github.com/os-autoinst/os-autoinst-distri-opensuse">os-autoinst-distri-opensuse</a>
tests). The svirt backend uses the <code>SERIAL_CONSOLE</code> variable, but only on s390x
machines it has been confirmed to be working (failing on Hyper-V, VMware and
XEN, see <a href="https://progress.opensuse.org/issues/55985">poo#55985</a>).
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Usually OpenQA controls the system under test using VNC. This allows the use
of both graphical and text based consoles. Key presses are sent individually
as VNC commands and output is returned in the form of screen images and text
output from the SUT&#8217;s default serial port.</p>
</div>
<div class="paragraph">
<p>Sending key presses over VNC is very slow, so for tests which send a lot of
text commands it is much faster to use a serial port for both sending shell
commands and received program output.</p>
</div>
<div class="paragraph">
<p>Communicating entirely using text also means that you no longer have to worry
about your needles being invalidated due to a font change or similar. It is
also much cheaper to transfer text and test it against regular expressions
than encode images from a VNC feed and test them against sample images
(needles).</p>
</div>
<div class="paragraph">
<p>On the other hand you can no longer use <code>assert_screen</code> or take a screen shot
because the text is never rendered as an image. A lot of programs will also
send ANSI escape sequences which will appear as raw text to the test script
instead of being interpreted by a terminal emulator which then renders the
text.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="perl"><span></span><span class="tok-n">select_console</span><span class="tok-p">(</span><span class="tok-s">&#39;root-virtio-terminal&#39;</span><span class="tok-p">);</span>  <span class="tok-c1"># Selects a virtio based serial terminal</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The above code will cause <code>type_string</code> and <code>wait_serial</code> to write and read
from a virtio serial port. A distribution specific call back will be made
which allows os-autoinst to log into a serial terminal session running on the
SUT. Once <code>select_console</code> returns you should be logged into a TTY as root.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
for <a href="https://github.com/os-autoinst/os-autoinst-distri-opensuse">os-autoinst-distri-opensuse</a>
tests instead of using <code>select_console('root-virtio-terminal')</code> directly is
the preferred way to use wrapper <code>select_serial_terminal()</code>, which handles all
backends:
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="perl"><span></span><span class="tok-c1"># Selects a virtio based serial terminal if available or fallback to the best suitable console</span>
<span class="tok-c1"># for the current backend.</span>
<span class="tok-n">select_serial_terminal</span><span class="tok-p">();</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If you are struggling to visualise what is happening, imagine SSH-ing into a
remote machine as root, you can then type in commands and read the results as
if you were sat at that computer. What we are doing is much simpler than using
an SSH connection (it is more like using GNU <code>screen</code> with a serial port), but
the end result looks quite similar.</p>
</div>
<div class="paragraph">
<p>As mentioned above, changing input and output to a serial terminal has the
effect of changing where <code>wait_serial</code> reads output from. On a QEMU VM
<code>wait_serial</code> usually reads from the default serial port which is also where
the kernel log is usually output to.</p>
</div>
<div class="paragraph">
<p>When switching to a virtio based serial terminal, <code>wait_serial</code> will then read
from a virtio serial port instead. However the default serial port still
exists and can receive output. Some utility library functions are hard coded
to redirect output to the default serial port and expect that <code>wait_serial</code>
will be able to read it. Usually it is not too difficult to fix the utility
function, you just need to remove some redirection from the relevant shell
command.</p>
</div>
<div class="paragraph">
<p>Another common problem is that some library or utility function tries to take
a screen shot. The hard part is finding what takes the screen shot, but then
it is just a simple case of checking <code>is_serial_terminal</code> and not taking the
screen shot if we are on a serial terminal console.</p>
</div>
<div class="paragraph">
<p>Distributions usually wrap <code>select_console</code>, so instead of using it directly,
you can use something like the following which is from the OpenSUSE test
suite.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="perl"><span></span><span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-n">select_serial_terminal</span><span class="tok-p">())</span> <span class="tok-p">{</span>
        <span class="tok-c1"># Do something which only works, or is necessary, on a serial terminal</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This selects the virtio based serial terminal console if possible. If it is
available then it returns true. It is also possible to check if the current
console is a serial terminal by calling <code>is_serial_terminal</code>.</p>
</div>
<div class="paragraph">
<p>Once you have selected a serial terminal, the video feed will disappear from
the live view, however at the bottom of the live screen there is a separate
text feed. After the test has finished you can view the serial log(s) in the
assets tab. You will probably have two serial logs; <code>serial0.txt</code> which is
written from the default serial port and <code>serial_terminal.txt</code>.</p>
</div>
<div class="paragraph">
<p>Now that you are on a serial terminal console everything will start to go a
lot faster. So much faster in fact that race conditions become a big
issue. Generally these can be avoided by using the higher level functions such
as <code>script_run</code> and <code>script_output</code>.</p>
</div>
<div class="paragraph">
<p>It is rarely necessary to use the lower level functions, however it helps to
recognise problems caused by race conditions at the lower level, so please
read the following section regardless.</p>
</div>
<div class="paragraph">
<p>So if you do need to use <code>type_string</code> and <code>wait_serial</code> directly then try to
use the following pattern:</p>
</div>
<div class="paragraph">
<p>1) Wait for the terminal prompt to appear.
2) Send your command
3) Wait for your command text to be echoed by the shell (if applicable)
4) Send enter
5) Wait for your command output (if applicable)</p>
</div>
<div class="paragraph">
<p>To illustrate this is a snippet from the LTP test runner which uses the lower
level commands to achieve a little bit more control. I have numbered the lines
which correspond to the steps above.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="perl"><span></span><span class="tok-k">my</span> <span class="tok-nv">$fin_msg</span>    <span class="tok-o">=</span> <span class="tok-s">&quot;### TEST $test-&gt;{name} COMPLETE &gt;&gt;&gt; &quot;</span><span class="tok-p">;</span>
<span class="tok-k">my</span> <span class="tok-nv">$cmd_text</span>   <span class="tok-o">=</span> <span class="tok-sx">qq($test-&gt;{command}; echo &quot;$fin_msg\$?&quot;)</span><span class="tok-p">;</span>
<span class="tok-k">my</span> <span class="tok-nv">$klog_stamp</span> <span class="tok-o">=</span> <span class="tok-s">&quot;echo &#39;OpenQA::run_ltp.pm: Starting $test-&gt;{name}&#39; &gt; /dev/$serialdev&quot;</span><span class="tok-p">;</span>

<span class="tok-c1"># More variables and other stuff</span>

<span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-n">is_serial_terminal</span><span class="tok-p">)</span> <span class="tok-p">{</span>
        <span class="tok-n">script_run</span><span class="tok-p">(</span><span class="tok-nv">$klog_stamp</span><span class="tok-p">);</span>
        <span class="tok-n">wait_serial</span><span class="tok-p">(</span><span class="tok-n">serial_term_prompt</span><span class="tok-p">(),</span> <span class="tok-nb">undef</span><span class="tok-p">,</span> <span class="tok-mi">0</span><span class="tok-p">,</span> <span class="tok-n">no_regex</span> <span class="tok-o">=&gt;</span> <span class="tok-mi">1</span><span class="tok-p">);</span> <span class="tok-c1">#Step 1</span>
        <span class="tok-n">type_string</span><span class="tok-p">(</span><span class="tok-nv">$cmd_text</span><span class="tok-p">);</span>		  	    	     	    <span class="tok-c1">#Step 2</span>
        <span class="tok-n">wait_serial</span><span class="tok-p">(</span><span class="tok-nv">$cmd_text</span><span class="tok-p">,</span> <span class="tok-nb">undef</span><span class="tok-p">,</span> <span class="tok-mi">0</span><span class="tok-p">,</span> <span class="tok-n">no_regex</span> <span class="tok-o">=&gt;</span> <span class="tok-mi">1</span><span class="tok-p">);</span>	    <span class="tok-c1">#Step 3</span>
        <span class="tok-n">type_string</span><span class="tok-p">(</span><span class="tok-s">&quot;\n&quot;</span><span class="tok-p">);</span>     	      	 	     		    <span class="tok-c1">#Step 4</span>
<span class="tok-p">}</span> <span class="tok-k">else</span> <span class="tok-p">{</span>
        <span class="tok-c1"># None serial terminal console code (e.g. the VNC console)</span>
<span class="tok-p">}</span>
<span class="tok-k">my</span> <span class="tok-nv">$test_log</span> <span class="tok-o">=</span> <span class="tok-n">wait_serial</span><span class="tok-p">(</span><span class="tok-sx">qr/$fin_msg\d+/</span><span class="tok-p">,</span> <span class="tok-nv">$timeout</span><span class="tok-p">,</span> <span class="tok-mi">0</span><span class="tok-p">,</span> <span class="tok-n">record_output</span> <span class="tok-o">=&gt;</span> <span class="tok-mi">1</span><span class="tok-p">);</span> <span class="tok-c1">#Step 5</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The first <code>wait_serial</code> (Step 1) ensures that the shell prompt has
appeared. If we do not wait for the shell prompt then it is possible that we
can send input to whatever command was run before. In this case that command
would be 'echo' which is used by <code>script_run</code> to print a 'finished' message.</p>
</div>
<div class="paragraph">
<p>It is possible that echo was able to print the finish message, but was then
suspended by the OS before it could exit. In which case the test script is
able to race ahead and start sending input to echo which was intended for the
shell. Waiting for the shell prompt stops this from happening.</p>
</div>
<div class="paragraph">
<p>INFO: It appears that echo does not read STDIN in this case, and so the input
will stay inside STDIN&#8217;s buffer and be read by the shell (Bash). Unfortunately
this results in the input being displayed twice: once by the terminal&#8217;s echo
(explained later) and once by Bash. Depending on your configuration the
behavior could be completely different</p>
</div>
<div class="paragraph">
<p>The function <code>serial_term_prompt</code> is a distribution specific function which
returns the characters previously set as the shell prompt (e.g. export PS1="#
", see the bash(1) or dash(1) man pages). If you are adapting a new
distribution to use the serial terminal console, then we recommend setting a
simple shell prompt and keeping track of it with utility functions.</p>
</div>
<div class="paragraph">
<p>The <code>no_regex</code> argument tells wait_serial to use simple string matching
instead of regular expressions, see the implementation section for more
details. The other arguments are the timeout (<code>undef</code> means we use the
default) and a boolean which inverts the result of <code>wait_serial</code>. These are
explained in the <code>os-autoinst/testapi.pm</code> documentation.</p>
</div>
<div class="paragraph">
<p>Then the test script enters our command with <code>type_string</code> (Step 2) and waits
for the command&#8217;s text to be echoed back by the system under test. Terminals
usually echo back the characters sent to them so that the user can see what
they have typed.</p>
</div>
<div class="paragraph">
<p>However this can be disabled (see the stty(1) man page) or possibly even
unimplemented on your terminal. So this step may not be applicable, but it
provides some error checking so you should think carefully before disabling
echo deliberately.</p>
</div>
<div class="paragraph">
<p>We then consume the echo text (Step 3) before sending enter, to both check
that the correct text was received and also to separate it from the command
output. It also ensures that the text has been fully processed before sending
the newline character which will cause the shell to change state.</p>
</div>
<div class="paragraph">
<p>It is worth reminding oneself that we are sending and receiving data
extremely quickly on an interface usually limited by human typing speed. So
any string which results in a significant state change should be treated as a
potential source of race conditions.</p>
</div>
<div class="paragraph">
<p>Finally we send the newline character and wait for our custom finish
message. <code>record_output</code> is set to ensure all the output from the SUT is
saved (see the next section for more info).</p>
</div>
<div class="paragraph">
<p>What we do <strong>not</strong> do at this point, is wait for the shell prompt to appear.
That would consume the prompt character breaking the next call to
<code>script_run</code>.</p>
</div>
<div class="paragraph">
<p>We choose to wait for the prompt just before sending a command, rather than
after it, so that Step 5 can be deferred to a later time. In theory this
allows the test script to perform some other work while the SUT is busy.</p>
</div>
</div>
<div class="sect3">
<h4 id="_sending_new_lines_and_continuation_characters">Sending new lines and continuation characters</h4>
<div class="paragraph">
<p>The following command will timeout: <code>script_run("echo \"1\n2\"")</code>. The reason
being <code>script_run</code> will call <code>wait_serial("echo \"1\n2\"")</code> to check that the
command was entered successfully and echoed back (see above for explanation of
serial terminal echo, note the echo shell command has not been executed
yet). However the shell will translate the newline characters into a newline
character plus '&gt;', so we will get something similar to the following output.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="shell"><span></span><span class="tok-nb">echo</span> <span class="tok-s2">&quot;1</span>
<span class="tok-s2">&gt; 2&quot;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The '&gt;' is unexpected and will cause the match to fail. One way to fix this is
simply to do <code>echo -e \"1\\n2\"</code>. In this case Perl will not replace \n with a
newline character, instead it will be passed to echo which will do the
substitution instead (note the '-e' switch for echo).</p>
</div>
<div class="paragraph">
<p>In general you should be aware that, Perl, the guest kernel and the shell may
transform whatever character sequence you enter. Transformations can be
spotted by comparing the input string with what <code>wait_serial</code> actually finds.</p>
</div>
</div>
<div class="sect3">
<h4 id="_sending_signals_ctrl_c_and_ctrl_d">Sending signals - ctrl-c and ctrl-d</h4>
<div class="paragraph">
<p>On a VNC based console you simply use <code>send_key</code> like follows.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="perl"><span></span><span class="tok-n">send_key</span><span class="tok-p">(</span><span class="tok-s">&#39;ctrl-c&#39;</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This usually (see termios(3)) has the effect of sending SIGINT to whatever
command is running. Most commands terminate upon receiving this signal (see
signal(7)).</p>
</div>
<div class="paragraph">
<p>On a serial terminal console the <code>send_key</code> command is not implemented (see
implementation section). So instead the following can be done to achieve the
same effect.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="perl"><span></span><span class="tok-n">type_string</span><span class="tok-p">(</span><span class="tok-s">&#39;&#39;</span><span class="tok-p">,</span> <span class="tok-n">terminate_with</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&#39;ETX&#39;</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The ETX ASCII code means End of Text and usually results in SIGINT being
raised. In fact pressing <code>ctrl-c</code> may just be translated into ETX, so you
might consider this a more direct method. Also you can use 'EOT' to do the
same thing as pressing <code>ctrl-d</code>.</p>
</div>
<div class="paragraph">
<p>You also have the option of using Perl&#8217;s control character escape sequences in
the first argument to <code>type_string</code>. So you can also send ETX with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="perl"><span></span><span class="tok-n">type_string</span><span class="tok-p">(</span><span class="tok-s">&quot;\cC&quot;</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>terminate_with</code> parameter just exists to display intention. It is also
possible to send any character using the hex code like '\x0f' which may have
the effect of pressing the magic SysRq key if you are lucky.</p>
</div>
</div>
<div class="sect3">
<h4 id="_the_virtio_serial_terminal_implementation">The virtio serial terminal implementation</h4>
<div class="paragraph">
<p>The os-autoinst package supports several types of 'consoles' of which the
virtio serial terminal is one. The majority of code for this console is
located in consoles/virtio_terminal.pm and consoles/serial_screen.pm (used also
by the svirt serial console). However there is also related code in
backends/qemu.pm and distribution.pm.</p>
</div>
<div class="paragraph">
<p>You may find it useful to read the documentation in virtio_terminal.pm and
serial_screen.pm if you need to perform some special action on a terminal such
as triggering a signal or simulating the SysRq key. There are also some
console specific arguments to <code>wait_serial</code> and <code>type_string</code> such as
<code>record_output</code>.</p>
</div>
<div class="paragraph">
<p>The virtio 'screen' essentially reads data from a socket created by QEMU into
a ring buffer and scans it after every read with a regular expression. The
ring buffer is large enough to hold anything you are likely to want to match
against, but not too large as to cause performance issues. Usually the
contents of this ring buffer, up to the end of the match, are returned by
<code>wait_serial</code>. This means earlier output will be overwritten once the ring
buffer&#8217;s length is exceeded. However you can pass <code>record_output</code> which saves
the output to a separate unlimited buffer and returns that instead.</p>
</div>
<div class="paragraph">
<p>Like <code>record_output</code>, the <code>no_regex</code> argument is a console specific argument
supported by the serial terminal console. It may or may not have some
performance benefits, but more importantly it allows you to easily match
arbitrary strings which may contain regex escape sequences. To be clear,
<code>no_regex</code> hints that <code>wait_serial</code> should just treat its input as a plain
string and use the Perl library function <code>index</code> to search for a match in the
ring buffer.</p>
</div>
<div class="paragraph">
<p>The <code>send_key</code> function is not implemented for the serial terminal console
because the OpenQA console implementation would need to map key actions like
<code>ctrl-c</code> to a character and then send that character. This may mislead some
people into thinking they are actually sending <code>ctrl-c</code> to the SUT and also
requires OpenQA to choose what character <code>ctrl-c</code> represents which varies
across terminal configurations.</p>
</div>
<div class="paragraph">
<p>Very little of the code (perhaps none) is specific to a virtio based serial
terminal and can be reused with a physical serial port, SSH socket, IPMI or
some other text based interface. It is called the virtio console because the
current implementation just uses a virtio serial device in QEMU (and it could
easily be converted to an emulated port), but it otherwise has nothing to do
with the virtio standard and so you should avoid using the name 'virtio
console' unless specifically referring to the QEMU virtio implementation.</p>
</div>
<div class="paragraph">
<p>As mentioned previously, ANSI escape sequences can be a pain. So we try to
avoid them by informing the shell that it is running on a 'dumb' terminal (see
the SUSE distribution&#8217;s serial terminal utility library). However some
programs ignore this, but piping there output into <code>tee</code> is usually enough to
stop them outputting non-printable characters.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_test_development_tricks">Test Development tricks</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_trigger_new_tests_by_modifying_settings_from_existing_test_runs">Trigger new tests by modifying settings from existing test runs</h3>
<div class="paragraph">
<p>To trigger new tests with custom settings the command line client
<code>openqa-cli</code> can be used. To trigger new tests relying on all settings from
existing tests runs but modifying specific settings the <code>openqa-clone-job</code>
script can be used. Within the openQA repository the script is located at
<code>/usr/share/openqa/script/</code>.  This tool can be used to create a new job that
adds, removes or changes settings.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span>openqa-clone-job --from localhost --host localhost <span class="tok-m">42</span> <span class="tok-nv">FOO</span><span class="tok-o">=</span>bar <span class="tok-nv">BAZ</span><span class="tok-o">=</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If you do not want a cloned job to start up in the same job group as the job
you cloned from, e.g. to not pollute build results, the job group can be
overwritten, too, using the special variable <code>_GROUP</code>. Add the quoted group
name, e.g.:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span>openqa-clone-job --from localhost <span class="tok-m">42</span> <span class="tok-nv">_GROUP</span><span class="tok-o">=</span><span class="tok-s2">&quot;openSUSE Tumbleweed&quot;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The special group value <code>0</code> means that the group connection will be separated
and the job will not appear as a job in any job group, e.g.:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span>openqa-clone-job --from localhost <span class="tok-m">42</span> <span class="tok-nv">_GROUP</span><span class="tok-o">=</span><span class="tok-m">0</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_backend_variables_for_faster_test_execution">Backend variables for faster test execution</h3>
<div class="paragraph">
<p>The <code>os-autoinst</code> backend offers multiple test variables which are helpful for
test development. For example:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Set <code>_EXIT_AFTER_SCHEDULE=1</code> if you only want to evaluate the test schedule
before the test modules are executed</p>
</li>
<li>
<p>Use <code>_SKIP_POST_FAIL_HOOKS=1</code> to prevent lengthy post_fail_hook execution in
case of expected and known test fails, for examples when you need to create
needles anyway</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_using_snapshots_to_speed_up_development_of_tests">Using snapshots to speed up development of tests</h3>
<div id="snapshots" class="paragraph">
<p>For lower turn-around times during test development based on virtual machines
the QEMU backend provides a feature that allows a job to start from a snapshot
which can help in this situation.</p>
</div>
<div class="paragraph">
<p>Depending on the use case, there are two options to help:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Create and <strong>preserve</strong> snapshots for <strong>every test</strong> module run (<code>MAKETESTSNAPSHOTS</code>)</p>
<div class="ulist">
<ul>
<li>
<p>Offers more flexibility as the test can be resumed almost at any point.
However disk space requirements are high (expect more than 30GB for one
job).</p>
</li>
<li>
<p>This mode is useful for fixing non-fatal issues in tests and debugging SUT
as more than just the snapshot of the last failed module is saved.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Create a snapshot <strong>after every successful</strong> test module while <strong>always
overwriting</strong> the existing snapshot to preserve only the latest (<code>TESTDEBUG</code>)</p>
<div class="ulist">
<ul>
<li>
<p>Allows to skip just before the start of the first failed test module,
which can be limiting, but preserves disk space in comparison to
<code>MAKETESTSNAPSHOTS</code>.</p>
</li>
<li>
<p>This mode is useful for iterative test development</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>In both modes there is no need to modify tests (i.e. adding <code>milestone</code> test
flag as the behaviour is implied). In the later mode every test module is
also considered <code>fatal</code>. This means the job is aborted after the first failed
test module.</p>
</div>
<div class="sect3">
<h4 id="snapshots-for-each-module">Enable snapshots for each module</h4>
<div class="ulist">
<ul>
<li>
<p>Run the worker with <code>--no-cleanup</code> parameter. This will preserve the hard
disks after test runs. If the worker(s) are being started via the systemd unit,
then this can achieved by using the <code>openqa-worker-no-cleanup@.service</code> unit
instead of <code>openqa-worker@.service</code>.</p>
</li>
<li>
<p>Set <code>MAKETESTSNAPSHOTS=1</code> on a job. This will make openQA save a
snapshot for every test module run. One way to do that is by cloning an
existing job and adding the setting:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span>openqa-clone-job --from https://openqa.opensuse.org  --host localhost <span class="tok-m">24</span> <span class="tok-nv">MAKETESTSNAPSHOTS</span><span class="tok-o">=</span><span class="tok-m">1</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Create a job again, this time setting the <code>SKIPTO</code> variable to the snapshot</p>
</li>
<li>
<p>you need. Again, <code>openqa-clone-job</code> comes handy here:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span>openqa-clone-job --from https://openqa.opensuse.org  --host localhost <span class="tok-m">24</span> <span class="tok-nv">SKIPTO</span><span class="tok-o">=</span>consoletest-yast2_i</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Use qemu-img snapshot -l something.img to find out what snapshots are in the image. Snapshots are named
<code>"test module category"-"test module name"</code> (e.g. <code>installation-start_install</code>).</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_storing_only_the_last_successful_snapshot">Storing only the last successful snapshot</h4>
<div class="ulist">
<ul>
<li>
<p>Run the worker with <code>--no-cleanup parameter</code>. This will preserve the hard disks after test runs.</p>
</li>
<li>
<p>Set <code>TESTDEBUG=1</code> on a job. This will make openQA save a snapshot after each
successful test module run. Snapshots are overwritten. The snapshot is named <code>lastgood</code> in all cases.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span>openqa-clone-job --from https://openqa.opensuse.org  --host localhost <span class="tok-m">24</span> <span class="tok-nv">TESTDEBUG</span><span class="tok-o">=</span><span class="tok-m">1</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Create a job again, this time setting the <code>SKIPTO</code> variable to the snapshot
which failed on previous run. Make sure the new job will also have
<code>TESTDEBUG=1</code> set. This can be ensured by the use of the clone_job script on
the clone source job or specifying the variable explicitly:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span>openqa-clone-job --from https://openqa.opensuse.org  --host localhost <span class="tok-m">24</span> <span class="tok-nv">TESTDEBUG</span><span class="tok-o">=</span><span class="tok-m">1</span> <span class="tok-nv">SKIPTO</span><span class="tok-o">=</span>consoletest-yast2_i</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_defining_a_custom_test_schedule_or_custom_test_modules">Defining a custom test schedule or custom test modules</h3>
<div class="paragraph">
<p>Normally the test schedule, that is which test modules should be executed and
which order, is prescribed by the <code>main.pm</code> file within the test distribution.
Additionally it is possible to exclude certain test modules from execution
using the os-autoinst test variables <code>INCLUDE_MODULES</code> and <code>EXCLUDE_MODULES</code> as
well as define a custom schedule using the test variable <code>SCHEDULE</code>.
Also test modules can be defined and overridden on-the-fly using a
downloadable asset.</p>
</div>
<div class="sect3">
<h4 id="_exclude_modules">EXCLUDE_MODULES</h4>
<div class="paragraph">
<p>If a job has the following schedule:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>boot/boot_to_desktop</p>
</li>
<li>
<p>console/systemd_testsuite</p>
</li>
<li>
<p>console/docker</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The module console/docker can be excluded with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>openqa-clone-job --from https://openqa.opensuse.org --host https://openqa.opensuse.org 24 EXCLUDE_MODULES=docker</pre>
</div>
</div>
<div class="paragraph">
<p>The schedule would be:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>boot/boot_to_desktop</p>
</li>
<li>
<p>console/systemd_testsuite</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Excluding modules that are not scheduled does not raise an error.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_include_modules">INCLUDE_MODULES</h4>
<div class="paragraph">
<p>If a job has the following schedule:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>boot/boot_to_desktop</p>
</li>
<li>
<p>console/systemd_testsuite</p>
</li>
<li>
<p>console/docker</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The module console/docker can be excluded with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>openqa-clone-job --from https://openqa.opensuse.org --host https://openqa.opensuse.org 24 INCLUDE_MODULES=boot_to_desktop,systemd_testsuite</pre>
</div>
</div>
<div class="paragraph">
<p>The schedule would be:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>boot/boot_to_desktop</p>
</li>
<li>
<p>console/systemd_testsuite</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Including modules that are not scheduled does not raise an error, but they are not scheduled.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_schedule">SCHEDULE</h4>
<div class="paragraph">
<p>Additionally it is possible to define a custom schedule using the test variable <code>SCHEDULE</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>openqa-clone-job --from https://openqa.opensuse.org --host https://openqa.opensuse.org 24 SCHEDULE=tests/boot/boot_to_desktop,tests/console/consoletest_setup</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Any existing test module within <strong>CASEDIR</strong> can be scheduled.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_schedule_asset_nr_url">SCHEDULE + ASSET_&lt;NR&gt;_URL</h4>
<div class="paragraph">
<p>Test modules can be defined and overridden on-the-fly using a
downloadable asset (combining <strong>ASSET_&lt;NR&gt;_URL</strong> and <strong>SCHEDULE</strong>).</p>
</div>
<div class="paragraph">
<p>For example one can schedule a job on a production instance with a custom
schedule consisting of two modules from the provided test distribution plus
one test module which is defined dynamically and downloaded as an asset from
an external trusted download domain:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>openqa-clone-job --from https://openqa.opensuse.org --host https://openqa.opensuse.org 24 SCHEDULE=tests/boot/boot_to_desktop,tests/console/consoletest_setup,foo,bar ASSET_1_URL=https://example.org/my/test/bar.pm  ASSET_2_URL=https://example.org/my/test/foo.pm</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
The asset number doesn&#8217;t affect the schedule order.<br>
The test modules foo.pm and bar.pm will be downloaded into the root of the pool directory where tests and assets are used by isotovideo. For this reason, to schedule them, no path is needed.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>A valid test module format looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>use base 'consoletest';
use strict;
use testapi;

sub run {
    select_console 'root-console';
    assert_script_run 'foo';
}

sub post_run_hook {}
1;</pre>
</div>
</div>
<div class="paragraph">
<p>For example this can be used in bug investigations or trying out new test
modules which are hard to test locally.
<a href="https://github.com/os-autoinst/os-autoinst/blob/master/doc/backend_vars.asciidoc" class="bare">https://github.com/os-autoinst/os-autoinst/blob/master/doc/backend_vars.asciidoc</a>
describes the <code>SCHEDULE</code> parameter in details as well as the others. The
section "Asset handling" in the <a href="#usersguide">Users Guide</a>
describes how downloadable assets can be specified. It is important to note
that the specified asset is only downloaded once. New versions must be
supplied as new, unambiguous download target file names.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_triggering_tests_based_on_an_any_remote_git_refspec_or_open_github_pull_request">Triggering tests based on an any remote git refspec or open github pull request</h3>
<div class="paragraph">
<p>openQA also supports to trigger tests using test code from an open pull
request on github or any branch or git refspec. That means that code changes
that are not yet available on a production instance of openQA can be tested
safely to ensure the code changes work as expected before merging the code
intro a production repository and branch. This works by setting the
<code>CASEDIR</code> parameter of os-autoinst to a valid Git repository path including
an optional branch/refspec specifier. It is also possible to set <code>NEEDLES_DIR</code>
to a valid Git repository path to use custom needles.
See
<a href="https://github.com/os-autoinst/os-autoinst/blob/master/doc/backend_vars.asciidoc" class="bare">https://github.com/os-autoinst/os-autoinst/blob/master/doc/backend_vars.asciidoc</a>
for details.</p>
</div>
<div class="paragraph">
<p>A helper script <code>openqa-clone-custom-git-refspec</code> is available for
convenience that supports some combinations.</p>
</div>
<div class="paragraph">
<p>To clone one job within a remote instance based on an open github pull request
the following syntax can be used:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>openqa-clone-custom-git-refspec $GITHUB_PR_URL $OPENQA_TEST_URL</pre>
</div>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>openqa-clone-custom-git-refspec https://github.com/os-autoinst/os-autoinst-distri-opensuse/pull/6649 https://openqa.opensuse.org/tests/839191</pre>
</div>
</div>
<div class="paragraph">
<p>Keep in mind that if <code>PRODUCTDIR</code> is overwritten it might not relate to the
state of the specified git refspec. The above method can still be used in this
case in the common case that the test schedule does not need to be changed or in
case a custom schedule is defined by <code>SCHEDULE</code>.</p>
</div>
<div class="paragraph">
<p>Note that customizing <code>CASEDIR</code> does <strong>not</strong> mean needles will be loaded from
there, even if the repository specified as <code>CASEDIR</code> contains needles. To load
needles from that repository, it needs to be specified as <code>NEEDLES_DIR</code> as well.</p>
</div>
</div>
</div>
</div>
<h1 id="installing_harness" class="sect0">openQA test harness result processing</h1>
<div class="sect1">
<h2 id="_introduction_5">Introduction</h2>
<div class="sectionbody">
<div class="paragraph">
<p>From time to time, a test developer might want to use openQA to execute a test
suite from a different test harness than openQA, but still use openQA to setup test
scenarios and prepare the environment for a test suite run; for this case openQA has
the ability to process logs from external harnesses, and display the results integrated
within the job results of the webUI.</p>
</div>
<div class="paragraph">
<p>One could say that a Test Harness is supported if its output is compatible with
the available {parser-format}, such as LTP, and also xUnit or JUnit, but this can
be easily extended to include more formats, such as RSpec or TAP.</p>
</div>
<div class="paragraph">
<p>The requirements to use this functionality, are quite simple:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The test harness must produce a compatible format with supported {parser-format}.</p>
</li>
<li>
<p>The test results can be uploaded via <code>testapi::parse_extra_log</code> within an openQA tests.</p>
</li>
<li>
<p>The test results can also be uploaded via web <a href="#webapi-endpoint">Web Api endpoint</a>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>openQA will store these results in its own internal format for easier presentation,
but still will allow the original file to be downloaded.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_usage">Usage</h2>
<div class="sectionbody">
<div class="paragraph">
<p>If a test developer wishes to use the functional interface, after finishing the
execution of the the testing too, calling <code>testapi::parse_extra_log</code> with the
location to a the file generated.</p>
</div>
<div class="sect2">
<h3 id="_openqa_test_distribution">openQA test distribution</h3>
<div class="paragraph">
<p>From within a common openQA test distribution, a developer can use <code>parse_extra_log</code>
to upload a text file that contains a supported test output:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="perl"><span></span><span class="tok-n">script_run</span><span class="tok-p">(</span><span class="tok-s">&#39;prove --verbose --formatter=TAP::Formatter::JUnit t/28-logging.t &gt; junit-logging.xml&#39;</span><span class="tok-p">);</span>
<span class="tok-n">parse_extra_log</span><span class="tok-p">(</span><span class="tok-s">&#39;XUnit&#39;</span><span class="tok-p">,</span><span class="tok-s">&#39;junit-logging.xml&#39;</span><span class="tok-p">);</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="parser-formats">Available parser formats</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Current parser formats:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>OpenQA::Parser::Format::TAP,</p>
</li>
<li>
<p>OpenQA::Parser::Format::JUnit</p>
</li>
<li>
<p>OpenQA::Parser::Format::LTP</p>
</li>
<li>
<p>OpenQA::Parser::Format::XUnit,</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_extending_the_parser">Extending the parser</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_oop_interface">OOP Interface</h3>
<div class="paragraph">
<p>The parser is a base class that acts as a serializer/deserializer for the elements
inside of it, it allows to be extended so new formats can be easily added.</p>
</div>
<div class="paragraph">
<p>The base class is exposing 4 Mojo::Collections available, according to what openQA
would require to map the results correctly, 1 extra collection is provided for
arbitrary data that can be exposed. The collections represents respectively:
test results, test definition and test output.</p>
</div>
</div>
<div class="sect2">
<h3 id="_structured_data">Structured data</h3>
<div class="paragraph">
<p>In structured data mode, elements of the collections are objects. They can be
of any type, even though subclassing or objects of type of <code>OpenQA::Parser::Result</code>
are preferred.</p>
</div>
<div class="paragraph">
<p>One thing to keep in mind, is that in case deeply nested objects need to be parsed
like hash of hashes, array of hashes, they would need to subclass <code>OpenQA::Parser::Result</code>
or <code>OpenQA::Parser::Results</code> respectively.</p>
</div>
<div class="paragraph">
<p>As an example, JUnit format can be parsed this way:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="perl"><span></span><span class="tok-k">use</span> <span class="tok-nn">OpenQA::Parser::Format::JUnit</span><span class="tok-p">;</span>

<span class="tok-k">my</span> <span class="tok-nv">$parser_result</span> <span class="tok-o">=</span> <span class="tok-nn">OpenQA::Parser::Format::JUnit</span><span class="tok-o">-&gt;</span><span class="tok-k">new</span><span class="tok-o">-&gt;</span><span class="tok-n">load</span><span class="tok-p">(</span><span class="tok-s">&quot;file.xml&quot;</span><span class="tok-p">);</span>

<span class="tok-c1"># Now we can access to parsed tests as seen by openQA:</span>

<span class="tok-nv">$parser_result</span><span class="tok-o">-&gt;</span><span class="tok-nn">tests</span><span class="tok-o">-&gt;</span><span class="tok-nb">each</span><span class="tok-p">(</span><span class="tok-k">sub</span> <span class="tok-p">{</span>

   <span class="tok-k">my</span> <span class="tok-nv">$test</span> <span class="tok-o">=</span> <span class="tok-nb">shift</span><span class="tok-p">;</span>
   <span class="tok-k">print</span> <span class="tok-s">&quot;Test name: &quot;</span><span class="tok-o">.</span><span class="tok-nv">$test</span><span class="tok-o">-&gt;</span><span class="tok-n">name</span><span class="tok-p">;</span>

<span class="tok-p">});</span>

<span class="tok-k">my</span> <span class="tok-nv">@all</span> <span class="tok-o">=</span> <span class="tok-nv">$parser_result</span><span class="tok-o">-&gt;</span><span class="tok-nn">tests</span><span class="tok-o">-&gt;</span><span class="tok-nb">each</span><span class="tok-p">;</span>
<span class="tok-k">my</span> <span class="tok-nv">@tests</span> <span class="tok-o">=</span> <span class="tok-nv">$parser</span><span class="tok-o">-&gt;</span><span class="tok-nn">tests</span><span class="tok-o">-&gt;</span><span class="tok-n">search</span><span class="tok-p">(</span><span class="tok-n">name</span> <span class="tok-o">=&gt;</span> <span class="tok-sx">qr/1_running_upstream_tests/</span><span class="tok-p">);</span>
<span class="tok-k">my</span> <span class="tok-nv">$first</span> <span class="tok-o">=</span> <span class="tok-nv">$parser</span><span class="tok-o">-&gt;</span><span class="tok-nn">tests</span><span class="tok-o">-&gt;</span><span class="tok-n">search</span><span class="tok-p">(</span><span class="tok-n">name</span> <span class="tok-o">=&gt;</span> <span class="tok-sx">qr/1_running_upstream_tests/</span><span class="tok-p">)</span><span class="tok-o">-&gt;</span><span class="tok-n">first</span><span class="tok-p">();</span>

<span class="tok-k">my</span> <span class="tok-nv">$binary_data</span> <span class="tok-o">=</span> <span class="tok-nv">$parser</span><span class="tok-o">-&gt;</span><span class="tok-n">serialize</span><span class="tok-p">();</span>

<span class="tok-c1"># Now, we can also store $binary_data and retrieve it later.</span>

<span class="tok-k">my</span> <span class="tok-nv">$new_parser_from_binary</span> <span class="tok-o">=</span> <span class="tok-nn">OpenQA::Parser::Format::JUnit</span><span class="tok-o">-&gt;</span><span class="tok-k">new</span><span class="tok-o">-&gt;</span><span class="tok-n">deserialize</span><span class="tok-p">(</span><span class="tok-nv">$binary_data</span><span class="tok-p">);</span>

<span class="tok-c1"># thus this works as expected:</span>
<span class="tok-nv">$new_parser_from_binary</span><span class="tok-o">-&gt;</span><span class="tok-nn">tests</span><span class="tok-o">-&gt;</span><span class="tok-nb">each</span><span class="tok-p">(</span> <span class="tok-k">sub</span> <span class="tok-p">{</span>

   <span class="tok-k">my</span> <span class="tok-nv">$test</span> <span class="tok-o">=</span> <span class="tok-nb">shift</span><span class="tok-p">;</span>
   <span class="tok-k">print</span> <span class="tok-s">&quot;Test name: &quot;</span><span class="tok-o">.</span><span class="tok-nv">$test</span><span class="tok-o">-&gt;</span><span class="tok-n">name</span><span class="tok-p">;</span>

<span class="tok-p">});</span>

<span class="tok-c1"># We can also serialize all to JSON</span>

<span class="tok-k">my</span> <span class="tok-nv">$json_serialization</span> <span class="tok-o">=</span> <span class="tok-nv">$parser</span><span class="tok-o">-&gt;</span><span class="tok-n">to_json</span><span class="tok-p">;</span>

<span class="tok-c1"># save it and access it later</span>

<span class="tok-k">my</span> <span class="tok-nv">$from_json</span> <span class="tok-o">=</span> <span class="tok-nn">OpenQA::Parser::Format::JUnit</span><span class="tok-o">-&gt;</span><span class="tok-n">from_json</span><span class="tok-p">(</span><span class="tok-nv">$json_serialization</span><span class="tok-p">);</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_openqa_internal_test_result_storage">openQA internal test result storage</h3>
<div class="paragraph">
<p>It is important to know that openQA&#8217;s internal mapping for test results works operating almost
entirely on the filesystem, leaving only the test modules to be registered into the database, this
leads to the following relation: A test module&#8217;s name is used to create a file with details
(details-$testmodule.json), that will contain a reference to step details, which is a collection of
references to files, using a field "text" as tie in, and expecting a filename.</p>
</div>
</div>
</div>
</div>
<h1 id="client" class="sect0">openQA client</h1>
<div class="openblock partintro">
<div class="content">
<div class="paragraph">
<p>There are two ways to interact with openQA as a user. The web UI and the REST
API. In this guide we will focus on the latter. You&#8217;ve probably already seen a
few examples of its use with <code>openqa-cli</code> earlier in the documentation.</p>
</div>
<div class="paragraph">
<p>Here we will start again from the very beginning to give you a more complete
overview of its capabilities. To get started all you need is an openQA instance
with a few jobs and <code>curl</code>. Just replace <code>openqa.example.com</code> in the examples
below with the hostname of your openQA instance.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span>curl http://openqa.example.com/api/v1/jobs/overview</code></pre>
</div>
</div>
<div class="paragraph">
<p>That one-liner will show you the latest jobs from the overview in JSON format.
You could also append various query parameters to filter the jobs further.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span>curl http://openqa.example.com/api/v1/jobs/overview?result<span class="tok-o">=</span>failed</code></pre>
</div>
</div>
<div class="paragraph">
<p>But using <code>curl</code> directly can also get a bit clunky when the data you need to
submit is more complex, you want to store host and authentication information
in config files, or just get the returned JSON pretty printed.</p>
</div>
<div class="paragraph">
<p>For those cases openQA also contains a dedicated client to help you with that.
It is called <code>openqa-cli</code> and can usually be installed with an <code>openQA-client</code>
package (the name will vary depending on your Linux distribution).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span>openqa-cli api --host http://openqa.example.com jobs/overview <span class="tok-nv">result</span><span class="tok-o">=</span>failed</code></pre>
</div>
</div>
<div class="paragraph">
<p>Our example above is quickly translated. The <code>api</code> subcommand of <code>openqa-cli</code>
allows you to perform arbitrary HTTP requests against the REST API. The path
will automatically get the correct version prefix applied (such as <code>/api/v1</code>),
and query parameters can be passed along as <code>key=value</code> pairs.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_help">Help</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The <code>api</code> subcommand is not the only one available and more will be added over
time. To get a complete list of all currently available subcommands you can use
the <code>--help</code> option.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span>openqa-cli --help</code></pre>
</div>
</div>
<div class="paragraph">
<p>And each subcommand also contains descriptions for all its available options, as
well as many common usage examples.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span>openqa-cli api --help</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_authentication">Authentication</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Not all REST endpoints are public, many will return a <code>403 Forbidden</code> error if
you try to access them without proper credentials. The credentials (or API keys)
are managed in the web UI, to which you will need operator access.</p>
</div>
<div class="paragraph">
<p>Once you have acquired a valid key and secret you can store them in a config
file or use them ad-hoc from the command line. There are two config files
<code>openqa-cli</code> will try, the global <code>/etc/openqa/client.conf</code>, and your personal
<code>~/.config/openqa/client.conf</code>. The format is the same for both.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ini"><span></span><span class="tok-k">[openqa.example.com]</span>
<span class="tok-na">key</span> <span class="tok-o">=</span> <span class="tok-s">1234567890ABCDEF</span>
<span class="tok-na">secret</span> <span class="tok-o">=</span> <span class="tok-s">ABCDEF1234567890</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>For ad-hoc use all <code>openqa-cli</code> subcommands use the <code>--apikey</code> and <code>--apisecret</code>
options. Which will override whatever the config files may contain.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span>openqa-cli api --host http://openqa.example.com --apikey 1234567890ABCDEF <span class="tok-se">\</span>
    --apisecret ABCDEF1234567890 -X POST jobs/2/comments <span class="tok-nv">text</span><span class="tok-o">=</span>hello</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_personal_access_token">Personal access token</h3>
<div class="paragraph">
<p>The authentication mechanism used by <code>openqa-cli</code> was specifically designed to
allow secure access to the REST API even via unencrypted HTTP connections. But
when your openQA server has been deployed with HTTPS (and for HTTP connections
originating from localhost) you can also use plain old Basic authentication
with a personal access token. That allows for almost any HTTP client to be used
with openQA.</p>
</div>
<div class="paragraph">
<p>This access token is made up of your username, and the same key/secret combo
the <code>openqa-cli</code> authentication mechanism uses. All you have to do is combine
them as <code>USERNAME:KEY:SECRET</code> and you can use <code>curl</code> to access operator and
admin REST endpoints (depending on user privileges of course).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span>curl -u arthur:1234567890ABCDEF:ABCDEF1234567890 -X DELETE <span class="tok-se">\</span>
    https://openqa.example.com/api/v1/assets/1</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_features">Features</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Many of the <code>openqa-cli api</code> features are designed to be similar to other
commonly used tools like <code>curl</code>. It helps a lot if you are already familiar with
the <a href="https://en.wikipedia.org/wiki/Hypertext_Transfer_Protocol">HTTP protocol</a> and
<a href="https://en.wikipedia.org/wiki/JSON">JSON</a>. Both will be referenced extensively.</p>
</div>
<div class="sect2">
<h3 id="_http_methods">HTTP Methods</h3>
<div class="paragraph">
<p>The <code>--method</code> option (or <code>-X</code> for short) allows you to change the HTTP request
method from <code>GET</code> to something else. In the openQA API you will most commonly
encounter <code>POST</code>, <code>PUT</code> and <code>DELETE</code>. For example to start testing a new ISO
image you would use <code>POST</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span>openqa-cli api --host http://openqa.example.com -X POST isos <span class="tok-se">\</span>
    <span class="tok-nv">ISO</span><span class="tok-o">=</span>openSUSE-Factory-NET-x86_64-Build0053-Media.iso <span class="tok-nv">DISTRI</span><span class="tok-o">=</span>opensuse <span class="tok-se">\</span>
    <span class="tok-nv">VERSION</span><span class="tok-o">=</span>Factory <span class="tok-nv">FLAVOR</span><span class="tok-o">=</span>NET <span class="tok-nv">ARCH</span><span class="tok-o">=</span>x86_64 <span class="tok-nv">BUILD</span><span class="tok-o">=</span><span class="tok-m">0053</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_http_headers">HTTP Headers</h3>
<div class="paragraph">
<p>With the <code>--header</code> option (or <code>-a</code> for short) you can add one or more custom
HTTP headers to your request. This feature is currently not used much, but can
be handy if for example the REST endpoint you are using supports content
negotiation.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span>openqa-cli api --host http://openqa.example.com -a <span class="tok-s1">&#39;Accept: application/json&#39;</span> <span class="tok-se">\</span>
    jobs/overview</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_http_body">HTTP Body</h3>
<div class="paragraph">
<p>To change the HTTP request body there are multiple options available. The
simplest being <code>--data</code> (or <code>-d</code> for short), which allows you to use a plain
string as request body. This can be useful for example to change the group id of
a job.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span>openqa-cli api --host http://openqa.example.com -X PUT jobs/1 <span class="tok-se">\</span>
    --data <span class="tok-s1">&#39;{&quot;group_id&quot;:2}&#39;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>With the <code>--data-file</code> option (or <code>-D</code> for short) you can also use a file
instead.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span>openqa-cli api --host http://openqa.example.com -X PUT jobs/1 <span class="tok-se">\</span>
    --data-file ./test.json</code></pre>
</div>
</div>
<div class="paragraph">
<p>Or just pipe the data to <code>openqa-cli</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span><span class="tok-nb">echo</span> <span class="tok-s1">&#39;{&quot;group_id&quot;:2}&#39;</span> <span class="tok-p">|</span> openqa-cli api --host http://openqa.example.com -X PUT <span class="tok-se">\</span>
    jobs/1</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_forms">Forms</h3>
<div class="paragraph">
<p>Most data you pass to the openQA API will be key/value form parameters. Either
in the query string, or encoded as <code>application/x-www-form-urlencoded</code> HTTP
request body. But you don&#8217;t have to worry about this too much, because
<code>openqa-cli api</code> knows when to use which format automatically, you just provide
the key/value pairs.</p>
</div>
<div class="paragraph">
<p>Form parameters are most commonly passed as additional arguments after the path.
For example to post a comment to a job.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span>openqa-cli api --host http://openqa.example.com -X POST jobs/2/comments <span class="tok-nv">text</span><span class="tok-o">=</span>abc</code></pre>
</div>
</div>
<div class="paragraph">
<p>This value can also be quoted to include whitespace characters.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span>openqa-cli api --host http://openqa.example.com -X POST jobs/2/comments <span class="tok-se">\</span>
    <span class="tok-nv">text</span><span class="tok-o">=</span><span class="tok-s2">&quot;Hello openQA!&quot;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And you can use interpolation to include files.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span>openqa-cli api --host http://openqa.example.com -X POST jobs/2/comments <span class="tok-se">\</span>
    <span class="tok-nv">text</span><span class="tok-o">=</span><span class="tok-s2">&quot;</span><span class="tok-k">$(</span>cat ./comment.markdown<span class="tok-k">)</span><span class="tok-s2">&quot;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Alternatively you can also use the <code>--form</code> option (or <code>-f</code> for short) to
provide all form parameters in JSON format. Here you would reuse the HTTP body
options, such as <code>--data</code> and <code>--data-file</code>, to pass the JSON document to be
turned into form parameters.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span>openqa-cli api --host http://openqa.example.com --form --data <span class="tok-s1">&#39;{&quot;text&quot;:&quot;abc&quot;}&#39;</span> <span class="tok-se">\</span>
    -X POST jobs/2/comments</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_json">JSON</h3>
<div class="paragraph">
<p>The primary data exchange format in the openQA API is JSON. And you will even
see error messages in JSON format most of the time.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="json"><span></span><span class="tok-p">{</span><span class="tok-nt">&quot;error&quot;</span><span class="tok-p">:</span><span class="tok-s2">&quot;no api key&quot;</span><span class="tok-p">,</span><span class="tok-nt">&quot;error_status&quot;</span><span class="tok-p">:</span><span class="tok-mi">403</span><span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>By default the returned JSON is often compressed, for better performance, and
can be hard to read if the response gets larger. But if you add the <code>--pretty</code>
option (or <code>-p</code> for short), <code>openqa-cli</code> can reformat it for you.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span>openqa-cli api --host http://openqa.example.com --pretty jobs/overview</code></pre>
</div>
</div>
<div class="paragraph">
<p>The JSON will be re-encoded with newlines and indentation for much better
readability.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="json"><span></span><span class="tok-p">{</span>
   <span class="tok-nt">&quot;error&quot;</span> <span class="tok-p">:</span> <span class="tok-s2">&quot;no api key&quot;</span><span class="tok-p">,</span>
   <span class="tok-nt">&quot;error_status&quot;</span> <span class="tok-p">:</span> <span class="tok-mi">403</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>--json</code> option (or <code>-j</code> for short) can be used to set a
<code>Content-Type: application/json</code> request header. Whenever you need to upload a
JSON document.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span>openqa-cli api --host http://openqa.example.com -X PUT jobs/1 --json <span class="tok-se">\</span>
    --data <span class="tok-s1">&#39;{&quot;group_id&quot;:2}&#39;</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_unicode">Unicode</h3>
<div class="paragraph">
<p>Just use a UTF-8 locale for your terminal and Unicode will pretty much just
work.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span>openqa-cli api --host http://openqa.example.com -X POST jobs/2/comments <span class="tok-se">\</span>
    <span class="tok-nv">text</span><span class="tok-o">=</span><span class="tok-s2">&quot;I ♥ Unicode&quot;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>JSON documents are always expected to be UTF-8 encoded.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span>openqa-cli api --host http://openqa.example.com --form <span class="tok-se">\</span>
    --data <span class="tok-s1">&#39;{&quot;text&quot;:&quot;I ♥ Unicode&quot;}&#39;</span> -X POST jobobs/407/comments <span class="tok-se">\</span>
    -X POST jobs/2/comments</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_host_shortcuts">Host shortcuts</h3>
<div class="paragraph">
<p>Aside from the <code>--host</code> option, there are also a few shortcuts available. If you
leave out the <code>--host</code> option completely, the default value will be
<code><a href="http://localhost" class="bare">http://localhost</a></code>, which is very convenient for debugging purposes.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span>openqa-cli api jobs/overview</code></pre>
</div>
</div>
<div class="paragraph">
<p>And organisations that contribute to openQA and are invested in the project can
also get their very own personalised shortcuts. Currently we have <code>--osd</code> for
<code><a href="http://openqa.suse.de" class="bare">http://openqa.suse.de</a></code>, and <code>--o3</code> for <code>openqa.opensuse.org</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span>openqa-cli api --o3 jobs/overview</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_debugging">Debugging</h3>
<div class="paragraph">
<p>Often times just seeing the HTTP response body might not be enough to debug a
problem. With the <code>--verbose</code> option (or <code>-v</code> for short) you can also get
additional information printed.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span>openqa-cli api --host http://openqa.example.com --verbose -X POST <span class="tok-se">\</span>
    jobs/407/comments <span class="tok-nv">text</span><span class="tok-o">=</span><span class="tok-s2">&quot;Hello openQA!&quot;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This includes the HTTP response status line, as well as headers.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>HTTP/1.1 403 Forbidden
Content-Type: application/json;charset=UTF-8
Strict-Transport-Security: max-age=31536000; includeSubDomains
Server: Mojolicious (Perl)
Content-Length: 41
Date: Wed, 29 Apr 2020 12:03:11 GMT

{"error":"no api key","error_status":403}</pre>
</div>
</div>
<div class="paragraph">
<p>And if that is not enough, you can experiment with the <code>MOJO_CLIENT_DEBUG</code>
environment variable.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span><span class="tok-nv">MOJO_CLIENT_DEBUG</span><span class="tok-o">=</span><span class="tok-m">1</span> openqa-cli api --host http://openqa.example.com -X POST <span class="tok-se">\</span>
    jobs/407/comments <span class="tok-nv">text</span><span class="tok-o">=</span><span class="tok-s2">&quot;Hello openQA!&quot;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>It will activate a debug feature in the Mojolicious framework, which openQA uses
internally, and show everything that is being sent or received.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>POST /api/v1/jobs/407/comments HTTP/1.1
Content-Length: 20
User-Agent: Mojolicious (Perl)
Content-Type: application/x-www-form-urlencoded
Host: openqa.example.com
X-API-Microtime: 1588153057
X-API-Hash: 8a73f6c37920921d52a8b5352ab417d923ee979e
Accept-Encoding: gzip
X-API-Key: AAEAC3E147A1EEE0
Accept: application/json

text=Hello+openQA%21</pre>
</div>
</div>
<div class="paragraph">
<p>Just be aware that this is a feature the openQA team does not control, and the
exact output as well as how it escapes control characters will change a bit over
time.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_archive_mode">Archive mode</h2>
<div class="sectionbody">
<div class="paragraph">
<p>With the <code>archive</code> subcommand of <code>openqa-cli</code> you can download all the assets
and test results of a job for archiving or debugging purposes.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>openqa-cli archive --host http://openqa.example.com 408 /tmp/openqa_job_408</pre>
</div>
</div>
<div class="paragraph">
<p>Thumbnails are not included by default, but can be added with the
<code>--with-thumbnails</code> option (or <code>-t</code> for short).</p>
</div>
<div class="listingblock">
<div class="content">
<pre>openqa-cli archive --host http://openqa.example.com --with-thumbnails \
    408 ~/openqa_job_408</pre>
</div>
</div>
</div>
</div>
<h1 id="pitfalls" class="sect0">openQA pitfalls</h1>
<div class="sect1">
<h2 id="_needle_editing">Needle editing</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>If a new needle is created based on a failed test, the new needle
will not be listed in old tests. However, when opening the needle
editor, a warning about the new needle will be shown and it can be
selected as base.</p>
</li>
<li>
<p>If an existing needle is updated with a new image or different
areas, the old test will display the new needle which might be
confusing.</p>
</li>
<li>
<p>If a needle is deleted, old tests may display an error when viewing
them in the web UI.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_403_messages_when_using_scripts">403 messages when using scripts</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>If you come across messages displaying <code>ERROR: 403 - Forbidden</code>, make
sure that the correct API key is present in client.conf file.</p>
</li>
<li>
<p>If you are using a hostname other than <code>localhost</code>, pass <strong>--host foo</strong> to the script.</p>
</li>
<li>
<p>If you are using fake authentication method, and the message says also "api key expired"
you can simply logout and log in again in the webUI and the expiration will be automatically
updated</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_mixed_production_and_development_environment">Mixed production and development environment</h2>
<div class="sectionbody">
<div class="paragraph">
<p>There are few things to take into account when running a development version and
a packaged version of openqa:</p>
</div>
<div class="paragraph">
<p>If the setup for the development scenario involves sharing <code>/var/lib/openqa</code>,
it would be wise to have a shared group <em>openqa</em>, that will have write and execute
permissions over said directory, so that <em>geekotest</em> user and the normal development
user can share the environment without problems.</p>
</div>
<div class="paragraph">
<p>This approach will lead to a problem when the openqa package is updated, since the
directory permissions will be changed again, nothing a <code>chmod -R g+rwx /var/lib/openqa/</code>
and <code>chgrp -R openqa /var/lib/openqa</code> can not fix.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_performance_impact">Performance impact</h2>
<div class="sectionbody">
<div class="paragraph">
<p>openQA workers can cause high I/O load, especially when creating VM snapshots.
The impact therefore gets more severe when <code>MAKETESTSNAPSHOTS</code> is enabled.
should not impact the stability of openQA jobs but can increase job execution
time. If you run jobs on a machine where responsiveness of other services
matter, for example your desktop machine, consider patching the
IOSchedulingPriority of a workers service file as described in the
<a href="https://www.freedesktop.org/software/systemd/man/systemd.exec.html#IOSchedulingPriority=">systemd
documentation</a>, for example set <code>IOSchedulingPriority=7</code> for the lowest
priority. If not available then you can try to execute the worker processes
with <code>ionice</code> to reduce the risk of your system becoming significantly
impacted by snapshot creation. Loading VM snapshots can also have an impact on
SUT behavior as the execution of the first step after loading a snapshot might
be delayed. This can lead to problems if the executed tests do not foresee an
appropriate timeout margin.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="db-migration">DB migration from SQlite to postgreSQL</h2>
<div class="sectionbody">
<div class="paragraph">
<p>As a first step to start using postgreSQL, please, configure postgreSQL database
according to the
<a href="#setup-postgresql">postgreSQL setup guide</a></p>
</div>
<div class="paragraph">
<p>To migrate api keys run following commands:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Export data from the SQlite db:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code><span></span>sqlite3 db.sqlite -csv -separator &#39;,&#39; &#39;select * from api_keys;&#39; &gt; apikeys.csv</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note: SQlite database file is located in <code>/var/lib/openqa/db</code> by default.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Import data to the postgreSQL</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code><span></span># openqa is the postgreSQL database name and apikeys.csv is api keys export file
psql -U postgres -d openqa -c &quot;copy api_keys from &#39;apikeys.csv&#39; with (format csv);&quot;</code></pre>
</div>
</div>
<div class="paragraph">
<p>In case you need to migrate job groups, test suites, use dump_templates and
load_templates scripts accordingly.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="debugdevelmode">Steps to debug developer mode setup</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This is basically a checklist to go through in case the developer mode is broken in your setup:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Be sure to have everything up to date. That includes relevant packages on the
machine hosting the web UI and on the worker.</p>
</li>
<li>
<p>Check whether the web browser can reach the livehandler daemon. Go to a running test and open
the live view. Then open the JavaScript console of the web browser. If it contains messages
like <code>Received message via ws proxy: &#8230;&#8203;</code> the livehandler daemon can be reached. Otherwise,
try the following sub-steps:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>The installation guide has been updated to cover the developer mode. In case you installed
your instance before the developer mode has been introduced, make sure that the Apache module
<code>rewrite</code> is enabled (via <code>a2enmod rewrite</code>). Also be sure the vhost configuration looks
like the one found in the openQA Git repository (especially the part for the reverse proxies).</p>
</li>
<li>
<p>Check whether <code>openqa-livehandler.service</code> is running. It is supposed to be run on
the same machine as the web UI and should actually be started automatically as a dependency of
<code>openqa-webui.service</code>.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Check whether the livehandler can reach the os-autoinst command server. Go to a running test
and open the live view. Then open the JavaScript console of the web browser. If it contains messages
like <code>Received message via ws proxy: {&#8230;&#8203;,"type":"info","what":"cmdsrvmsg"}</code> the os-autoinst command
server can be reached. Otherwise there should be at least a message like
<code>Received message via ws proxy: {"what":"connecting to os-autoinst command server at ws:\/\/hostname:20053\/xhB84lUuPlMfhDEF\/ws",&#8230;&#8203;}</code>
which contains the URL the livehandler is attempting to query. In this case
try the following sub-steps:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>If the hostname is wrong, add <code>WORKER_HOSTNAME = correcthostname</code> to <code>workers.ini</code>. The worker
should then tell the web UI that it is reachable via <code>correcthostname</code> resulting in a correct URL
for the os-autoinst command server.</p>
</li>
<li>
<p>It might also be the case that the firewall is blocking the HTTP/websocket connection on the required
port. The required port is <code>QEMUPORT</code> plus 1.
By default, <code>QEMUPORT</code> is set to <code>$worker_instance_number * 10 + 20002</code> by the worker. So to cover
worker slots from 1 to 10 one would by default require the ports 20013, 20023, … and 20103.</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
</div>
</div>
<h1 id="networking" class="sect0">Networking in OpenQA</h1>
<div class="openblock partintro">
<div class="content">
<div class="paragraph">
<p>For tests using the QEMU backend the networking type used is controlled by the
<code>NICTYPE</code> variable. If unset or empty <code>NICTYPE</code> defaults to <code>user</code>, i.e.
<a href="#_qemu_user_networking">QEMU User Networking</a> which requires no further configuration.</p>
</div>
<div class="paragraph">
<p>For more advanced setups or tests that require multiple jobs to be in the same
networking the <a href="#TAP based network">TAP</a> or <a href="#_vde_based_network">VDE</a> based
modes can be used.</p>
</div>
<div class="paragraph">
<p>Other backends can be treated just the same as bare-metal setups. Tests can be
triggered in parallel same as for QEMU based ones and synchronization
primitives can be used. For the physical network according separation needs to
be ensured externally where needed as means for machines to be able to access
each other.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_qemu_user_networking">QEMU User Networking</h2>
<div class="sectionbody">
<div class="paragraph">
<p>With QEMU <a href="http://wiki.qemu.org/Documentation/Networking#User_Networking_.28SLIRP.29">user networking</a> each jobs gets its own isolated network with
TCP and UDP routed to the outside. DHCP is provided by QEMU. The MAC address of
the machine can be controlled with the <code>NICMAC</code> variable. If not set, it is
<code>52:54:00:12:34:56</code>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_tap_based_network">TAP Based Network</h2>
<div class="sectionbody">
<div class="paragraph">
<p>os-autoinst can connect QEMU to TAP devices of the host system to
leverage advanced network setups provided by the host by setting <code>NICTYPE=tap</code>.</p>
</div>
<div class="paragraph">
<p>The TAP device to use can be configured with the <code>TAPDEV</code> variable. If not
defined, it is automatically set to "tap" + ($worker_instance - 1), i.e.
worker1 uses tap0, worker 2 uses tap1 and so on.</p>
</div>
<div class="paragraph">
<p>For multiple networks per job (see <code>NETWORKS</code> variable), the following numbering
scheme is used:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span>worker1: tap0 tap64 tap128 ...
worker2: tap1 tap65 tap129 ...
worker3: tap2 tap66 tap130 ...
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>The MAC address of each virtual NIC is controlled by the <code>NICMAC</code> variable or
automatically computed from <code>$worker_id</code> if not set.</p>
</div>
<div class="paragraph">
<p>In TAP mode the system administrator is expected to configure the network,
required internet access, etc. on the host as described in the next section.</p>
</div>
<div class="sect2">
<h3 id="_multi_machine_tests_setup">Multi Machine Tests Setup</h3>
<div class="paragraph">
<p>The section provides one of the ways for setting up the openQA environment to
run tests that require network connection between several machines (e.g.
client&#8201;&#8212;&#8201;server tests).</p>
</div>
<div class="paragraph">
<p>The example of the configuration is applicable for openSUSE and will use <em>Open
vSwitch</em> for virtual switch, <em>firewalld</em> (or <em>SuSEfirewall2</em> for older
versions) for NAT and <em>wicked</em> as network manager. Keep in mind that a
firewall is not strictly necessary for operation. The operation without
firewall is not covered in all necessary details in this documentation.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Another way to setup the environment with <em>iptables</em> and <em>firewalld</em> is described
on the <a href="https://fedoraproject.org/wiki/OpenQA_advanced_network_guide">Fedora wiki</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><strong>Set Up Open vSwitch</strong></p>
</div>
<div class="paragraph">
<p>Compared to VDE setup, Open vSwitch is slightly more complicated to configure,
but provides a more robust and scalable network.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Install and Run Open vSwitch:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span>zypper <span class="tok-k">in</span> openvswitch
systemctl <span class="tok-nb">enable</span> --now openvswitch</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Install and configure <em>os-autoinst-openvswitch.service</em>:</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<em>os-autoinst-openvswitch.service</em> is a support service that sets the
vlan number of Open vSwitch ports based on <code>NICVLAN</code> variable - this separates
the groups of tests from each other. The <code>NICVLAN</code> variable is dynamically
assigned by the OpenQA scheduler. Install, start and enable the service:
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span>zypper <span class="tok-k">in</span> os-autoinst-openvswitch
systemctl <span class="tok-nb">enable</span> --now os-autoinst-openvswitch</code></pre>
</div>
</div>
<div class="paragraph">
<p>The service <em>os-autoinst-openvswitch.service</em> uses <em>br0</em> bridge by default.
As it might be used by KVM already it is suggested to configure <em>br1</em> instead:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span><span class="tok-c1"># /etc/sysconfig/os-autoinst-openvswitch</span>
<span class="tok-nv">OS_AUTOINST_USE_BRIDGE</span><span class="tok-o">=</span>br1</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Create the virtual bridge <em>br1</em>:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>ovs-vsctl add-br br1</pre>
</div>
</div>
<div class="paragraph">
<p><strong>Configure Virtual Interfaces</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Add a tap interface for every multi-machine worker instance:</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Create as many interfaces as needed for a test. The instructions are
provided for three interfaces <em>tap0</em>, <em>tap1</em>, <em>tap2</em> to be used by <em>worker@1</em>,
<em>worker@2</em>, <em>worker@3</em> worker instances. The TAP interfaces have to be owned
by the <em>_openqa-worker</em> user for the openQA worker instances to be able to
access them.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To create tap interfaces automatically on startup, add appropriate configuration files to the
<code>/etc/sysconfig/network/</code> directory. Files have to be named as <code>ifcfg-tap&lt;N&gt;</code>, replacing <code>&lt;N&gt;</code>
with the number for the interface, such as <code>0</code>, <code>1</code>, <code>2</code> (e.g. <code>ifcfg-tap0</code>,
<code>ifcfg-tap1</code>):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span><span class="tok-c1"># /etc/sysconfig/network/ifcfg-tap0</span>
<span class="tok-nv">BOOTPROTO</span><span class="tok-o">=</span><span class="tok-s1">&#39;none&#39;</span>
<span class="tok-nv">IPADDR</span><span class="tok-o">=</span><span class="tok-s1">&#39;&#39;</span>
<span class="tok-nv">NETMASK</span><span class="tok-o">=</span><span class="tok-s1">&#39;&#39;</span>
<span class="tok-nv">PREFIXLEN</span><span class="tok-o">=</span><span class="tok-s1">&#39;&#39;</span>
<span class="tok-nv">STARTMODE</span><span class="tok-o">=</span><span class="tok-s1">&#39;auto&#39;</span>
<span class="tok-nv">TUNNEL</span><span class="tok-o">=</span><span class="tok-s1">&#39;tap&#39;</span>
<span class="tok-nv">TUNNEL_SET_GROUP</span><span class="tok-o">=</span><span class="tok-s1">&#39;nogroup&#39;</span>
<span class="tok-nv">TUNNEL_SET_OWNER</span><span class="tok-o">=</span><span class="tok-s1">&#39;_openqa-worker&#39;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Symlinks can be used to reference the same configuration file for each tap
interface.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Add the bridge config with all tap devices that should be connected to it.
The file has to be located in the <code>/etc/sysconfig/network/</code> directory. File
name is <code>ifcfg-br&lt;N&gt;</code>, where <code>&lt;N&gt;</code> is the id of the bridge (e.g. <code>1</code>):</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span><span class="tok-c1"># /etc/sysconfig/network/ifcfg-br1</span>
<span class="tok-nv">BOOTPROTO</span><span class="tok-o">=</span><span class="tok-s1">&#39;static&#39;</span>
<span class="tok-nv">IPADDR</span><span class="tok-o">=</span><span class="tok-s1">&#39;10.0.2.2/15&#39;</span>
<span class="tok-nv">STARTMODE</span><span class="tok-o">=</span><span class="tok-s1">&#39;auto&#39;</span>
<span class="tok-nv">OVS_BRIDGE</span><span class="tok-o">=</span><span class="tok-s1">&#39;yes&#39;</span>
<span class="tok-nv">OVS_BRIDGE_PORT_DEVICE_1</span><span class="tok-o">=</span><span class="tok-s1">&#39;tap0&#39;</span>
<span class="tok-nv">OVS_BRIDGE_PORT_DEVICE_2</span><span class="tok-o">=</span><span class="tok-s1">&#39;tap1&#39;</span>
<span class="tok-nv">OVS_BRIDGE_PORT_DEVICE_3</span><span class="tok-o">=</span><span class="tok-s1">&#39;tap2&#39;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Configure NAT with firewalld</strong></p>
</div>
<div class="paragraph">
<p>To configure NAT with firewalld assign the bridge interface to the internal zone
and the interface with access to the network to the external zone:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span>firewall-cmd --zone<span class="tok-o">=</span>external --add-interface<span class="tok-o">=</span>eth0
firewall-cmd --zone<span class="tok-o">=</span>internal --add-interface<span class="tok-o">=</span>br1</code></pre>
</div>
</div>
<div class="paragraph">
<p>To enable the virtual machines used by openQA to fully access the external
network masquerading needs to be enabled on all involved zones:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span>firewall-cmd --zone<span class="tok-o">=</span>external --add-masquerade
firewall-cmd --zone<span class="tok-o">=</span>internal --add-masquerade</code></pre>
</div>
</div>
<div class="paragraph">
<p>IP forwarding is enabled automatically if masquerading is enabled:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span>grep <span class="tok-m">1</span> /proc/sys/net/ipv4/ip_forward
<span class="tok-m">1</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In case the interface is in a trusted network it is possible to accept
connections by default by changing the zone target:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span>firewall-cmd --zone<span class="tok-o">=</span>external --set-target<span class="tok-o">=</span>ACCEPT</code></pre>
</div>
</div>
<div class="paragraph">
<p>Alternatively, you can assign the interface to the <code>trusted</code> zone. Make sure
to enable masquerading for the <code>trusted</code> zone as well in this case.</p>
</div>
<div class="paragraph">
<p>If you are happy with the changes make them persistent:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span>firewall-cmd --runtime-to-permanent</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you do not currently have the firewalld service running, you can instead
use the <code>firewall-offline-cmd</code> command for the configuration. In this case
start the firewall and enable the service to run on system startup:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span>systemctl <span class="tok-nb">enable</span> --now firewalld</code></pre>
</div>
</div>
<div class="paragraph">
<p>Also, the <code>firewall-config</code> GUI tool for firewalld can be used for configuration.</p>
</div>
<div class="paragraph">
<p><strong>For older versions of openSUSE/SLE: Configure NAT with SuSEfirewall2</strong></p>
</div>
<div class="paragraph">
<p>The IP 10.0.2.2 can be also served as a gateway to access the outside network.
For this, NAT between <em>br1</em> and <em>eth0</em> must be configured with SuSEfirewall2
or iptables:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span><span class="tok-c1"># /etc/sysconfig/SuSEfirewall2</span>
<span class="tok-nv">FW_DEV_INT</span><span class="tok-o">=</span><span class="tok-s2">&quot;br1&quot;</span>
<span class="tok-nv">FW_ROUTE</span><span class="tok-o">=</span><span class="tok-s2">&quot;yes&quot;</span>
<span class="tok-nv">FW_MASQUERADE</span><span class="tok-o">=</span><span class="tok-s2">&quot;yes&quot;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Start SuSEfirewall2 and enable the service to start on system startup:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span>systemctl <span class="tok-nb">enable</span> --now SuSEfirewall2</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Configure OpenQA Worker Instances</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Allow worker intstances to run multi-machine jobs:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span><span class="tok-c1"># /etc/openqa/workers.ini</span>
<span class="tok-o">[</span>global<span class="tok-o">]</span>
<span class="tok-nv">WORKER_CLASS</span> <span class="tok-o">=</span> qemu_x86_64,tap</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
The number of tap devices should correspond to the number of the running
worker instances. For example, if you have set up 3 tap devices, the same
number of worker instances should be configured.
</td>
</tr>
</table>
</div>
<div class="ulist">
<ul>
<li>
<p>Enable worker instances to be started on system boot:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span>systemctl <span class="tok-nb">enable</span> openqa-worker@1
systemctl <span class="tok-nb">enable</span> openqa-worker@2
systemctl <span class="tok-nb">enable</span> openqa-worker@3</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Grant CAP_NET_ADMIN Capabilities to QEMU</strong></p>
</div>
<div class="paragraph">
<p>In order to let QEMU create TAP devices on demand it is required to set
CAP_NET_ADMIN capability on QEMU binary file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span>zypper <span class="tok-k">in</span> libcap-progs
setcap <span class="tok-nv">CAP_NET_ADMIN</span><span class="tok-o">=</span>ep /usr/bin/qemu-system-x86_64</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Configure network interfaces</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Check the configuration for the <em>eth0</em> interface:</p>
</li>
</ul>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
Ensure, that <em>eth0</em> interface is configured in
<code>/etc/sysconfig/network/ifcfg-eth0</code>. Otherwise, wicked will not be able to
bring up the interface on start and the host will loose network connection:
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span><span class="tok-c1"># /etc/sysconfig/network/ifcfg-eth0</span>
<span class="tok-nv">BOOTPROTO</span><span class="tok-o">=</span><span class="tok-s1">&#39;dhcp&#39;</span>
<span class="tok-nv">BROADCAST</span><span class="tok-o">=</span><span class="tok-s1">&#39;&#39;</span>
<span class="tok-nv">ETHTOOL_OPTIONS</span><span class="tok-o">=</span><span class="tok-s1">&#39;&#39;</span>
<span class="tok-nv">IPADDR</span><span class="tok-o">=</span><span class="tok-s1">&#39;&#39;</span>
<span class="tok-nv">MTU</span><span class="tok-o">=</span><span class="tok-s1">&#39;&#39;</span>
<span class="tok-nv">NAME</span><span class="tok-o">=</span><span class="tok-s1">&#39;&#39;</span>
<span class="tok-nv">NETMASK</span><span class="tok-o">=</span><span class="tok-s1">&#39;&#39;</span>
<span class="tok-nv">REMOTE_IPADDR</span><span class="tok-o">=</span><span class="tok-s1">&#39;&#39;</span>
<span class="tok-nv">STARTMODE</span><span class="tok-o">=</span><span class="tok-s1">&#39;auto&#39;</span>
<span class="tok-nv">DHCLIENT_SET_DEFAULT_ROUTE</span><span class="tok-o">=</span><span class="tok-s1">&#39;yes&#39;</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Pros of wicked over NetworkManager:</p>
<div class="ulist">
<ul>
<li>
<p>Proper IPv6 support</p>
</li>
<li>
<p>openvswitch/vlan/bonding/bridge support - wicked can manage your advanced configuration transparently without the need of extra tools</p>
</li>
<li>
<p>Backwards compatible with ifup scripts</p>
</li>
</ul>
</div>
</li>
<li>
<p>Check the network service currently being used:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span>systemctl show -p Id network.service</code></pre>
</div>
</div>
<div class="paragraph">
<p>If the result is different from <code>Id=wicked.service</code> (e.g.
<code>NetworkManager.service</code>), stop the network service:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span>systemctl disable --now network.service</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Then switch to wicked and start the service:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span>systemctl <span class="tok-nb">enable</span> --force wicked
systemctl start wicked</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Bring up the <em>br1</em> interface:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span>wicked ifup br1</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Reboot</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
It is also possible to switch the network configuration using YaST.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_debugging_open_vswitch_configuration">Debugging Open vSwitch Configuration</h3>
<div class="paragraph">
<p>Boot sequence with wicked (version 0.6.23 and newer):</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>openvswitch (as above)</p>
</li>
<li>
<p>wicked - creates the bridge <code>br1</code> and tap devices, adds tap devices to the bridge,</p>
</li>
<li>
<p>SuSEfirewall</p>
</li>
<li>
<p>os-autoinst-openvswitch - installs openflow rules, handles vlan assignment</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The configuration and operation can be checked with the following commands:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span>ovs-vsctl show <span class="tok-c1"># shows the bridge br1, the tap devices are assigned to it</span>
ovs-ofctl dump-flows br1 <span class="tok-c1"># shows the rules installed by os-autoinst-openvswitch in table=0</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>When everything is ok and the machines are able to communicate, the ovs-vsctl
should show something like the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span>Bridge <span class="tok-s2">&quot;br0&quot;</span>
    Port <span class="tok-s2">&quot;br0&quot;</span>
        Interface <span class="tok-s2">&quot;br0&quot;</span>
            type: internal
    Port <span class="tok-s2">&quot;tap0&quot;</span>
        Interface <span class="tok-s2">&quot;tap0&quot;</span>
    Port <span class="tok-s2">&quot;tap1&quot;</span>
        tag: <span class="tok-m">1</span>
        Interface <span class="tok-s2">&quot;tap1&quot;</span>
    Port <span class="tok-s2">&quot;tap2&quot;</span>
        tag: <span class="tok-m">1</span>
        Interface <span class="tok-s2">&quot;tap2&quot;</span>
  ovs_version: <span class="tok-s2">&quot;2.11.1&quot;</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Notice the tag numbers are assigned to tap1 and tap2. They should have
the same number.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
If the balance of the tap devices is wrong in the workers.ini the tag
cannot be assigned and the communication will be broken.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Check the flow of packets over the network:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>packets from tapX to br1 create additional rules in table=1</p>
</li>
<li>
<p>packets from br1 to tapX increase packet counts in table=1</p>
</li>
<li>
<p>empty output indicates a problem with os-autoinst-openvswitch service</p>
</li>
<li>
<p>zero packet count or missing rules in table=1 indicate problem with tap devices</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span>iptables -L -v</code></pre>
</div>
</div>
<div class="paragraph">
<p>As long as the SUT has access to external network, there should be a non-zero
packet count in the forward chain between the br1 and external interface.</p>
</div>
</div>
<div class="sect2">
<h3 id="_gre_tunnels">GRE Tunnels</h3>
<div class="paragraph">
<p>By default all multi-machine workers have to be on single physical machine.
You can join multiple physical machines and its ovs bridges together by a GRE
tunnel.</p>
</div>
<div class="paragraph">
<p>If the workers with TAP capability are spread across multiple hosts, the
network must be connected. See Open vSwitch
<a href="http://openvswitch.org/support/config-cookbooks/port-tunneling/">documentation</a>
for details.</p>
</div>
<div class="paragraph">
<p>Create a gre_tunnel_preup script (change the <code>remote_ip</code> value correspondingly
on both hosts):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span><span class="tok-c1"># /etc/wicked/scripts/gre_tunnel_preup.sh</span>
<span class="tok-c1">#!/bin/sh</span>
<span class="tok-nv">action</span><span class="tok-o">=</span><span class="tok-s2">&quot;</span><span class="tok-nv">$1</span><span class="tok-s2">&quot;</span>
<span class="tok-nv">bridge</span><span class="tok-o">=</span><span class="tok-s2">&quot;</span><span class="tok-nv">$2</span><span class="tok-s2">&quot;</span>
ovs-vsctl <span class="tok-nb">set</span> bridge <span class="tok-nv">$bridge</span> <span class="tok-nv">stp_enable</span><span class="tok-o">=</span><span class="tok-nb">true</span>
ovs-vsctl --may-exist add-port <span class="tok-nv">$bridge</span> gre1 -- <span class="tok-nb">set</span> interface gre1 <span class="tok-nv">type</span><span class="tok-o">=</span>gre options:remote_ip<span class="tok-o">=</span>&lt;IP address of other host&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>And call it by PRE_UP_SCRIPT="wicked:gre_tunnel_preup.sh" entry:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span><span class="tok-c1"># /etc/sysconfig/network/ifcfg-br1</span>
&lt;..&gt;
<span class="tok-nv">PRE_UP_SCRIPT</span><span class="tok-o">=</span><span class="tok-s2">&quot;wicked:gre_tunnel_preup.sh&quot;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Allow GRE in firewall:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span><span class="tok-c1"># /etc/sysconfig/SuSEfirewall2</span>
<span class="tok-nv">FW_SERVICES_EXT_IP</span><span class="tok-o">=</span><span class="tok-s2">&quot;GRE&quot;</span>
<span class="tok-nv">FW_SERVICES_EXT_TCP</span><span class="tok-o">=</span><span class="tok-s2">&quot;1723&quot;</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
When using GRE tunnels keep in mind that virtual machines inside the ovs
bridges have to use MTU=1458 for their physical interfaces (eth0, eth1). If
you are using support_server/setup.pm the MTU will be set automatically to
that value on support_server itself and it does MTU advertisement for DHCP
clients as well.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_vde_based_network">VDE Based Network</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Virtual Distributed Ethernet provides a software switch that runs in
user space. It allows to connect several QEMU instances without
affecting the system&#8217;s network configuration.</p>
</div>
<div class="paragraph">
<p>The openQA workers need a vde_switch instance running. The workers
reconfigure the switch as needed by the job.</p>
</div>
<div class="sect2">
<h3 id="_basic_single_machine_tests">Basic, Single Machine Tests</h3>
<div class="paragraph">
<p>To start with a basic configuration like QEMU user mode networking,
create a machine with the following settings:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>VDE_SOCKETDIR=/run/openqa</code></p>
</li>
<li>
<p><code>NICTYPE=vde</code></p>
</li>
<li>
<p><code>NICVLAN=0</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Start the switch and user mode networking:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span>systemctl <span class="tok-nb">enable</span> --now openqa-vde_switch
systemctl <span class="tok-nb">enable</span> --now openqa-slirpvde</code></pre>
</div>
</div>
<div class="paragraph">
<p>With this setting all jobs on the same host would be in the same network and
share the same SLIRP instance.</p>
</div>
</div>
</div>
</div>
<h1 id="contributing" class="sect0">openQA developer guide</h1>
<div class="sect1">
<h2 id="_introduction_6">Introduction</h2>
<div class="sectionbody">
<div class="paragraph">
<p>openQA is an automated test tool that makes it possible to test the whole
installation process of an operating system. It&#8217;s free software released
under the <a href="http://www.gnu.org/licenses/gpl-2.0.html">GPLv2 license</a>. The
source code and documentation are hosted in the
<a href="https://github.com/os-autoinst">os-autoinst organization on GitHub</a>.</p>
</div>
<div class="paragraph">
<p>This document provides the information needed to start contributing to the
openQA development improving the tool, fixing bugs and implementing new
features. For information about writing or improving openQA tests, refer to the
Tests Developer Guide. In both documents it&#8217;s assumed that the reader is already
familiar with openQA and has already read the Starter Guide. All those documents
are available at the
<a href="https://github.com/os-autoinst/openQA">official repository</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_development_guidelines">Development guidelines</h2>
<div class="sectionbody">
<div id="guidelines" class="paragraph">
<p>As mentioned, the central point of development is the
<a href="https://github.com/os-autoinst">os-autoinst organization on GitHub</a> where several
repositories can be found.</p>
</div>
<div class="sect2">
<h3 id="repo-urls">Repository URLs</h3>
<div class="ulist">
<ul>
<li>
<p>os-autoinst: <a href="https://github.com/os-autoinst/os-autoinst" class="bare">https://github.com/os-autoinst/os-autoinst</a></p>
<div class="ulist">
<ul>
<li>
<p>the "backend" (thing that executes tests and starts/controls the SUT e.g. using QEMU)</p>
</li>
</ul>
</div>
</li>
<li>
<p>openQA: <a href="https://github.com/os-autoinst/openQA" class="bare">https://github.com/os-autoinst/openQA</a></p>
<div class="ulist">
<ul>
<li>
<p>mainly the web UI and accompanying daemons like the scheduler</p>
</li>
<li>
<p>the worker (thing that starts the backend and uploads results to the web UI)</p>
</li>
<li>
<p>documentation</p>
</li>
<li>
<p>miscellaneous support scripts</p>
</li>
</ul>
</div>
</li>
<li>
<p>test distribution: e.g. <a href="https://github.com/os-autoinst/os-autoinst-distri-opensuse" class="bare">https://github.com/os-autoinst/os-autoinst-distri-opensuse</a> for openSUSE</p>
<div class="ulist">
<ul>
<li>
<p>the actual tests, in case of <code>os-autoinst-distri-opensuse</code> conducted on <a href="http://openqa.opensuse.org" class="bare">http://openqa.opensuse.org</a></p>
</li>
</ul>
</div>
</li>
<li>
<p>needles: e.g. <a href="https://github.com/os-autoinst/os-autoinst-needles-opensuse" class="bare">https://github.com/os-autoinst/os-autoinst-needles-opensuse</a> for openSUSE</p>
<div class="ulist">
<ul>
<li>
<p>reference images if not already included in the test distribution</p>
</li>
</ul>
</div>
</li>
<li>
<p>empty example test distribution: <a href="https://github.com/os-autoinst/os-autoinst-distri-example" class="bare">https://github.com/os-autoinst/os-autoinst-distri-example</a></p>
<div class="ulist">
<ul>
<li>
<p>meant to be used to start writing tests (and creating the corresponding needles) from scratch for a new operating system</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>As in most projects hosted on GitHub, pull request are always welcome and
are the right way to contribute improvements and fixes.</p>
</div>
</div>
<div class="sect2">
<h3 id="_rules_for_commits">Rules for commits</h3>
<div id="rules_for_commits" class="ulist">
<ul>
<li>
<p>Every commit is checked in <a href="https://circleci.com/dashboard">CI</a> as soon as
you create a pull request, but you <strong>should</strong> run the tidy scripts locally, i.e.
before every commit call:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span>make tidy</code></pre>
</div>
</div>
<div class="paragraph">
<p>to ensure your Perl and JavaScript code changes are consistent with the style
rules.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>All tests are passed. This is ensured by a CI system. You can also run local
tests in your development environment to verify everything works as
expected, see <a href="#testing">Conducting tests</a>)</p>
</li>
<li>
<p>For git commit messages use the rules stated on
<a href="http://chris.beams.io/posts/git-commit/">How to Write a Git Commit Message</a> as
a reference</p>
</li>
<li>
<p>Every pull request is reviewed in a peer review to give feedback on possible
implications and how we can help each other to improve</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If this is too much hassle for you feel free to provide incomplete pull
requests for consideration or create an issue with a code change proposal.</p>
</div>
</div>
<div class="sect2">
<h3 id="_code_style_suggestions">Code style suggestions</h3>
<div id="code_style_suggestions" class="ulist">
<ul>
<li>
<p>In Perl files:</p>
<div class="ulist">
<ul>
<li>
<p>Sort the use statements in this order from top to bottom:</p>
<div class="ulist">
<ul>
<li>
<p><code>strict</code>, <code>warnings</code> or other modules that provide static checks</p>
</li>
<li>
<p>All external modules and from "lib" folder</p>
</li>
<li>
<p><code>use FindBin; use lib "$FindBin::Bin/lib";</code> or similar to resolve internal modules</p>
</li>
<li>
<p>Internal test modules which provide early checks before other modules</p>
</li>
<li>
<p>Other internal test modules</p>
</li>
</ul>
</div>
</li>
<li>
<p>When using <a href="https://perldoc.perl.org/perlsub#Signatures">signatures</a> try to follow these rules:</p>
<div class="ulist">
<ul>
<li>
<p>Activate the feature with modules we already use if possible, e.g. <code>use Mojo::Base 'Something', -signatures;</code></p>
</li>
<li>
<p>Use positional parameters whenever possible, e.g. <code>sub foo ($first, $second) {</code></p>
</li>
<li>
<p>Use default values when appropriate, e.g. <code>sub foo ($first, $second = 'some value') {</code></p>
</li>
<li>
<p>Use slurpy parameters when appropriate (hash and array), e.g. <code>sub foo ($first, @more) {</code></p>
</li>
<li>
<p>Use nameless parameters when appropriate (very uncommon), e.g. <code>sub foo ($first, $, $third) {</code></p>
</li>
<li>
<p>Do <strong>not</strong> get too creative with computational default values, e.g. <code>sub foo ($first, $second = rand($first)) {</code></p>
</li>
<li>
<p>Do <strong>not</strong> combine sub attributes with signatures (requires Perl 5.28+), e.g. <code>sub foo :lvalue ($first) {</code></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_getting_involved_into_development">Getting involved into development</h2>
<div class="sectionbody">
<div id="getting_involved" class="paragraph">
<p>Developers willing to get really involved into the development of openQA or
people interested in following the always-changing roadmap should take a look
at the <a href="https://progress.opensuse.org/projects/openqav3">openQAv3 project</a> in
openSUSE&#8217;s project management tool. This Redmine instance is used to coordinate
the main development effort organizing the existing issues (bugs and desired
features) into 'target versions'.</p>
</div>
<div class="paragraph">
<p><a href="https://progress.opensuse.org/versions/490">Future improvements</a> groups
features that are in the developers' and users' wish list but that have little
chances to be addressed in the short term, normally because they are out of
the current scope of the development. Developers looking for a place to start
contributing are encouraged to simply go to that list and assign any open
issue to themselves.</p>
</div>
<div class="paragraph">
<p>openQA and os-autoinst repositories also include test suites aimed at preventing
bugs and regressions in the software. <a href="https://codecov.io/">codecov</a> is
configured in the repositories to encourage contributors to raise the tests
coverage with every commit and pull request. New features and bug fixes are
expected to be backed with the corresponding tests.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_technologies">Technologies</h2>
<div class="sectionbody">
<div id="technologies" class="paragraph">
<p>Everything in openQA, from <code>os-autoinst</code> to the web frontend and from the tests
to the support scripts is written in Perl. So having some basic knowledge
about that language is really desirable in order to understand and develop
openQA. Of course, in addition to bare Perl, several libraries and additional
tools are required. The easiest way to install all needed dependencies is
using the available os-autoinst and openQA packages, as described in the
Installation Guide.</p>
</div>
<div class="paragraph">
<p>In the case of os-autoinst, only a few <a href="http://www.cpan.org/">CPAN</a> modules are
required. Basically <code>Carp::Always</code>, <code>Data::Dump</code>. <code>JSON</code> and <code>YAML</code>. On the other
hand, several external tools are needed including
<a href="http://wiki.qemu.org/Main_Page">QEMU</a>,
<a href="https://code.google.com/p/tesseract-ocr/">Tesseract</a> and
<a href="http://optipng.sourceforge.net/">OptiPNG</a>. Last but not least, the
<a href="http://opencv.org/">OpenCV</a> library is the core of the openQA image matching
mechanism, so it must be available on the system.</p>
</div>
<div class="paragraph">
<p>The openQA package is built on top of Mojolicious, an excellent Perl framework
for web development that will be extremely familiar to developers coming from
other modern web frameworks like Sinatra and that have nice and comprehensive
documentation available at its <a href="http://mojolicio.us">home page</a>.</p>
</div>
<div class="paragraph">
<p>In addition to Mojolicious and its dependencies, several other CPAN modules are
required by the openQA package. See
<a href="#dependencies">Dependencies</a> below.</p>
</div>
<div class="paragraph">
<p>openQA relies on PostgreSQL to store the information. It used to support SQLite,
but that is no longer possible.</p>
</div>
<div class="paragraph">
<p>As stated in the previous section, every feature implemented in both packages
should be backed by proper tests.
<a href="http://perldoc.perl.org/Test/Most.html">Test::Most</a> is used to implement those
tests. As usual, tests are located under the <code>/t/</code> directory. In the openQA
package, one of the tests consists of a call to
<a href="http://perltidy.sourceforge.net/">Perltidy</a> to ensure that the contributed code
follows the most common Perl style conventions.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_folder_structure">Folder structure</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Meaning and purpose of the most important folders within openQA are:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">public</dt>
<dd>
<p>Static assets published to users over the web UI or API</p>
</dd>
<dt class="hdlist1">t</dt>
<dd>
<p>Self-tests of openQA</p>
</dd>
<dt class="hdlist1">assets</dt>
<dd>
<p>3rd party JavaScript and CSS files</p>
</dd>
<dt class="hdlist1">docs</dt>
<dd>
<p>Documentation, including this document</p>
</dd>
<dt class="hdlist1">etc</dt>
<dd>
<p>Configuration files including template branding specializations</p>
</dd>
<dt class="hdlist1">lib</dt>
<dd>
<p>Main perl module library folder</p>
</dd>
<dt class="hdlist1">script</dt>
<dd>
<p>Main applications and startup files</p>
</dd>
<dt class="hdlist1">.circleci</dt>
<dd>
<p>circleCI definitions</p>
</dd>
<dt class="hdlist1">dbicdh</dt>
<dd>
<p>Database schema startup and migration files</p>
</dd>
<dt class="hdlist1">container</dt>
<dd>
<p>Container definitions</p>
</dd>
<dt class="hdlist1">profiles</dt>
<dd>
<p>Apparmor profiles</p>
</dd>
<dt class="hdlist1">systemd</dt>
<dd>
<p>systemd service definitions</p>
</dd>
<dt class="hdlist1">templates</dt>
<dd>
<p>HTML templates delivered by web UI</p>
</dd>
<dt class="hdlist1">tools</dt>
<dd>
<p>Development tools</p>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect1">
<h2 id="development-setup">Development setup</h2>
<div class="sectionbody">
<div class="paragraph">
<p>For developing openQA and os-autoinst itself it makes sense to checkout the
<a href="#repo-urls">Git repositories</a> and either execute
existing tests or start the daemons manually.</p>
</div>
<div class="sect2">
<h3 id="testing">Conducting tests</h3>
<div class="paragraph">
<p>To execute all existing checks and tests simply call:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span>make <span class="tok-nb">test</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>for style checks, unit and integration tests.</p>
</div>
<div class="paragraph">
<p>To execute single tests call <code>make</code> with the selected tests in the <code>TESTS</code>
variable specified as a white-space separated list, for example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span>make <span class="tok-nb">test</span> <span class="tok-nv">TESTS</span><span class="tok-o">=</span>t/config.t</code></pre>
</div>
</div>
<div class="paragraph">
<p>or</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span>make <span class="tok-nb">test</span> <span class="tok-nv">TESTS</span><span class="tok-o">=</span><span class="tok-s2">&quot;t/foo.t t/bar.t&quot;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To run only unit tests without other tests (perltidy or database tests):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span>make test-unit-and-integration <span class="tok-nv">TESTS</span><span class="tok-o">=</span>t/foo.t</code></pre>
</div>
</div>
<div class="paragraph">
<p>Or use <code>prove</code> after pointing to a local test database in the environment
variable <code>TEST_PG</code>. Also, If you set a custom base directory, be sure to unset
it when running tests. Example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span><span class="tok-nv">TEST_PG</span><span class="tok-o">=</span><span class="tok-s1">&#39;DBI:Pg:dbname=openqa_test;host=/dev/shm/tpg&#39;</span> <span class="tok-nv">OPENQA_BASEDIR</span><span class="tok-o">=</span> prove -v t/14-grutasks.t</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the case of wanting to tweak the tests as above, to speed up the test
initialization, start PostgreSQL using <code>t/test_postgresql</code> instead of using
the system service. E.g.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span>t/test_postgresql /dev/shm/tpg</code></pre>
</div>
</div>
<div class="paragraph">
<p>To check the coverage by individual test files easily call e.g.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span>make coverage <span class="tok-nv">TESTS</span><span class="tok-o">=</span>t/24-worker-engine.t</code></pre>
</div>
</div>
<div class="paragraph">
<p>and take a look into the generated coverage HTML report in
<code>cover_db/coverage.html</code>.</p>
</div>
<div class="paragraph">
<p>We use annotations in some places to mark "uncoverable" code such as this:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># uncoverable subroutine</pre>
</div>
</div>
<div class="paragraph">
<p>See the docs for details <a href="https://metacpan.org/pod/Devel::Cover" class="bare">https://metacpan.org/pod/Devel::Cover</a></p>
</div>
<div class="paragraph">
<p>There are some ways to save some time when executing local tests:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>One option is selecting individual tests to run as explained above</p>
</li>
<li>
<p>Set the make variable <code>KEEP_DB=1</code> to keep the test database process spawned
for tests for faster re-runs or run tests with <code>prove</code> manually after the
test database has been created.</p>
</li>
<li>
<p>Run <code>tools/tidy --only-changed</code> to tidy up code before committing in git</p>
</li>
<li>
<p>Set the environment variable <code>DIE_ON_FAIL=1</code> from <code>Test::Most</code> for faster
aborts from failed tests.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For easier debugging of t/full-stack.t one can set the environment variable
<code>OPENQA_FULLSTACK_TEMP_DIR</code> to a clean directory (relative or absolute path)
to be used for saving temporary data from the test, for example the log files
from individual test job runs within the full stack test.</p>
</div>
</div>
<div class="sect2">
<h3 id="dependencies">Dependencies</h3>
<div class="paragraph">
<p>Have a look at the packaged version (e.g. <code>dist/rpm/openQA.spec</code> within the
root of the openQA repository) for all required dependencies. For development
build time dependencies need to be installed as well. Recommended
dependencies such as logrotate can be ignored. For openSUSE there is also the
<code>openQA-devel</code> meta-package which pulls all required dependencies for
development.</p>
</div>
<div class="paragraph">
<p>You can find all required Perl modules in form of a <code>cpanfile</code> that enables
you to install them with a CPAN client. They are also defined in
<code>dist/rpm/openQA.spec</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="setup-postgresql">Setting up the PostgreSQL database</h3>
<div class="paragraph">
<p>One also needs to setup a PostgreSQL database for openQA manually owned by your regular user:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Install PostgreSQL - under openSUSE the following package are required:
<code>postgresql-server postgresql-init</code></p>
</li>
<li>
<p>Start the server: <code>systemctl start postgresql</code></p>
</li>
<li>
<p>The next two steps need to be done as the user <strong>postgres</strong>: <code>su - postgres</code></p>
</li>
<li>
<p>Create user: <code>createuser your_username</code> where <code>your_username</code> must be
the same as the UNIX user you start your local openQA instance with.</p>
</li>
<li>
<p>Create database: <code>createdb -O your_username openqa-local</code> where
<code>openqa-local</code> is the name you want to use for the database</p>
</li>
<li>
<p>Configure openQA to use PostgreSQL as described in the section
<a href="#database">Database</a> of the installation guide.
User name and password are not required.</p>
</li>
<li>
<p>openQA will default-initialize the new database on the next startup.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The script <code>openqa-setup-db</code> can be used to conduct step 4 and 5.</p>
</div>
<div class="sect3">
<h4 id="_importing_production_data">Importing production data</h4>
<div class="paragraph">
<p>Assuming you have already followed steps 1. to 4. above:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Create a separate database: <code>createdb -O your_username openqa-o3</code> where
<code>openqa-o3+</code> is the name you want to use for the database</p>
</li>
<li>
<p>The next steps must be run as the user you start your local openQA
instance with, i.e. the <code>your_username</code> user.</p>
</li>
<li>
<p>Import dump: <code>pg_restore -c -d openqa-o3 path/to/dump</code>
Note that errors of the form <code>ERROR:  role "geekotest" does not exist</code> are
due to the users in the production setup and can safely be ignored.
Everything will be owned by <code>your_username</code>.</p>
</li>
<li>
<p>Configure openQA to use that database as in step 7. above.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_manual_daemon_setup">Manual daemon setup</h3>
<div class="paragraph">
<p>This section should give you a general idea how to start up daemons manually
for development. For a concrete example some developers use under openSUSE
Tumbleweed have a look at the
<a href="https://github.com/Martchus/openQA-helper">openQA-helper repository</a>.</p>
</div>
<div class="paragraph">
<p>To start the webserver for development, use <code>scripts/openqa daemon</code>. The other
daemons (mentioned in the <a href="images/architecture.svg">architecture diagram</a>)
are started in the same way, e.g. <code>script/openqa-scheduler daemon</code>.</p>
</div>
<div class="paragraph">
<p>You can also have a look at the systemd unit files. Although it likely makes not much sense to use them directly
you can have a look at them to see how the different daemons are started. They are found in the <code>systemd</code> directory
of the openQA repository. You can substitute <code>/usr/share/openqa/</code> with the path of your openQA Git checkout.</p>
</div>
<div class="paragraph">
<p>Of course you can ignore the user specified in these unit files and instead start everything as your
regular user. However, you need to ensure that your user has the permission to the "openQA base directory".
That is not the case by default so it makes sense to <a href="#_customize_base_directory">customize it</a>.</p>
</div>
<div class="paragraph">
<p>Note that the web UI daemon will pull required JavaScript/CSS libraries automatically when started the first time.
This might take a while and requires an internet connection.</p>
</div>
<div class="paragraph">
<p>You do <strong>not</strong> need to setup an additional web server because the daemons already provide one. The port
under which a service is available is logged on startup (the main web UI port is 9625 by default). Local
workers need to be configured to connect to the main web UI port (add <code>HOST = <a href="http://localhost:9526+" class="bare">http://localhost:9526+</a> to
`workers.ini</code>).</p>
</div>
<div class="sect3">
<h4 id="_further_tips">Further tips</h4>
<div class="ulist">
<ul>
<li>
<p>It is also useful to start openQA with morbo which allows applying changes
without restarting the server:
<code>morbo -m development -w assets -w lib -w templates
  -l <a href="http://localhost:9526" class="bare">http://localhost:9526</a> script/openqa daemon</code></p>
</li>
<li>
<p>In case you have problems with broken rendering of the web page it can help
to delete the asset cache and let the webserver regenerate it on first
startup. For this delete the subdirectories <code>.sass-cache/</code>, <code>assets/cache/</code>
and <code>assets/assetpack.db</code>. Make sure to look for error messages on startup
of the webserver and to force the refresh of the web page in your browser.</p>
</li>
<li>
<p>If you get errors like "ERROR: Failed to build gem native extension." make
sure you have all listed dependencies including the "sass" application
installed.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="dependency-handling">Handling of dependencies</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_javascript_and_css">Javascript and CSS</h3>
<div class="paragraph">
<p>Add 3rd party JavaScript and CSS file to <code>assets/assetpack.def</code>. When
restarting the web server the new/updated files are pulled automatically. Also
take care to <a href="#update-asset-cache">update the asset cache
for the openSUSE RPM package</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_perl_and_other_packages">Perl and other packages</h3>
<div class="paragraph">
<p>In openQA, there is a <code>dependencies.yaml</code> file including a list of
dependencies, separated in groups. For example the openQA client does not need
all modules required to run openQA. Edit this file to add or change a dependency
and run <code>make update-deps</code>.  This will generate the <code>cpanfile</code> and
<code>dist/rpm/openQA.spec</code> files.</p>
</div>
<div class="paragraph">
<p>The same applies to <code>os-autoinst</code> where <code>make update-deps</code> will generate the
<code>cpanfile</code>, <code>os-autoinst.spec</code> and <code>container/ci/Dockerfile</code>.</p>
</div>
<div class="paragraph">
<p>If changing any package dependencies make sure packages and updated packages
are available in openSUSE Factory and whatever current Leap version is in
development. New package dependencies can be submitted. Before merging the
according change into the main openQA repo the dependency should be published
as part of openSUSE Tumbleweed.</p>
</div>
</div>
<div class="sect2">
<h3 id="_remarks_regarding_ci">Remarks regarding CI</h3>
<div class="ulist">
<ul>
<li>
<p>The CI of os-autoinst uses the container made using <code>container/ci/Dockerfile</code>.</p>
</li>
<li>
<p>The CI of openQA uses the container made using <code>container/devel:openQA:ci/base/Dockerfile</code>
and further dependencies listed in <code>.circleci/ci-packages.txt</code> (see
<a href="#circleci-workflow">CircleCI documentation</a>).</p>
</li>
<li>
<p>There is an additional check running using OBS to check builds of packages
against openSUSE Tumbleweed and openSUSE Leap.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="update-asset-cache">Update asset cache for openSUSE RPM package</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Clone the repository (or a branch to it if you do not have the rights to
push directly) locally, e.g. <code>osc co devel:openQA/openQA</code>.</p>
</li>
<li>
<p>Get the script <code>update-cache.sh</code> from the main git repository with
<code>osc service ra</code></p>
</li>
<li>
<p>Run <code>bash *update-cache.sh</code> inside the repository folder. Follow the log
checking no download errors occurred.</p>
</li>
<li>
<p>Do a sanity check on the generated <code>cache.txz</code>. It usually should not be
smaller than before, contain the newly added sources and must not contain
any empty files.</p>
</li>
<li>
<p>Add an entry to the changes file using <code>osc vc openQA.changes</code>.</p>
</li>
<li>
<p><code>osc ci -m 'Update asset cache'</code></p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_managing_the_database">Managing the database</h2>
<div class="sectionbody">
<div class="paragraph">
<p>During the development process there are cases in which the database schema
needs to be changed.
there are some steps that have to be followed so that new database instances
and upgrades include those changes.</p>
</div>
<div class="sect2">
<h3 id="_when_is_it_required_to_update_the_database_schema">When is it required to update the database schema?</h3>
<div class="paragraph">
<p>After modifying files in <code>lib/OpenQA/Schema/Result</code>. However, not all changes
require to update the schema. Adding just another method or altering/adding
functions like <code>has_many</code> doesn&#8217;t require an update. However, adding new
columns, modifying or removing existing ones requires to follow the steps
mentioned above. In doubt, just follow the instructions below. If an empty
migration has been emitted (SQL file produced in step 3. does not contain
any statements) you can just drop the migration again.</p>
</div>
</div>
<div class="sect2">
<h3 id="_how_to_update_the_database_schema">How to update the database schema</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>First, you need to increase the database version number in the <code>$VERSION</code>
variable in the <code>lib/OpenQA/Schema.pm</code> file.
Note that it is recommended to notify the other developers before doing so,
to synchronize in case there are more developers wanting to increase the
version number at the same time.</p>
</li>
<li>
<p>Then you need to generate the deployment files for new installations,
this is done by running <code>./script/initdb --prepare_init</code>.</p>
</li>
<li>
<p>Afterwards you need to generate the deployment files for existing installations,
this is done by running <code>./script/upgradedb --prepare_upgrade</code>.
After doing so, the directories <code>dbicdh/$ENGINE/deploy/&lt;new version&gt;</code> and
<code>dbicdh/$ENGINE/upgrade/&lt;prev version&gt;-&lt;new version&gt;</code> for PostgreSQL
should have been created with some SQL files inside containing the statements to
initialize the schema and to upgrade from one version
to the next in the corresponding database engine.</p>
</li>
<li>
<p>Custom migration scripts to upgrade from previous versions can be added under
<code>dbicdh/_common/upgrade</code>. Create a <code>&lt;prev_version&gt;-&lt;new_version&gt;</code> directory and
put some files there with DBIx commands for the migration. For examples just
have a look at the migrations which are already there.
The custom migration scripts are executed in addition to the automatically
generated ones. If the name of the custom migration script comes before
<code>001-auto.sql</code> in alphabetical order it will be executed <strong>before</strong> the
automatically created migration script. That is most of the times <strong>not</strong> desired.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The above steps are only for preparing the required SQL statements for the migration.</p>
</div>
<div class="paragraph">
<p>The migration itself (which alters your database!) is done <strong>automatically</strong> the first
time the web UI is (re)started. So be sure <strong>to backup your database</strong> before restarting
to be able to downgrade again if something goes wrong or you just need to continue
working on another branch. To do so, the following command can be used to create a copy:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span>createdb -O ownername -T originaldb newdb</code></pre>
</div>
</div>
<div class="paragraph">
<p>To initialize or update the database manually before restarting the web UI you can run
either <code>./script/initdb --init_database</code> or <code>./script/upgradedb --upgrade_database</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_how_to_add_fixtures_to_the_database">How to add fixtures to the database</h3>
<div class="paragraph">
<p>Note: This section is not about the fixtures for the testsuite. Those are located
under t/fixtures.</p>
</div>
<div class="paragraph">
<p>Note: This section might not be relevant anymore. At least there are currently
none of the mentioned directories with files containing SQL statements present.</p>
</div>
<div class="paragraph">
<p>Fixtures (initial data stored in tables at installation time) are stored
in files into the <code>dbicdh/_common/deploy/_any/&lt;version&gt;</code> and
<code>dbicdh/_common/upgrade/&lt;prev_version&gt;-&lt;next_version&gt;</code> directories.</p>
</div>
<div class="paragraph">
<p>You can create as many files as you want in each directory. These files contain
SQL statements that will be executed when initializing or upgrading a database.
Note that those files (and directories) have to be created manually.</p>
</div>
<div class="paragraph">
<p>Executed SQL statements can be traced by setting the <code>DBIC_TRACE</code> environment
variable.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span><span class="tok-nb">export</span> <span class="tok-nv">DBIC_TRACE</span><span class="tok-o">=</span><span class="tok-m">1</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_how_to_overwrite_config_files">How to overwrite config files</h2>
<div class="sectionbody">
<div class="paragraph">
<p>It can be necessary during development to change the config files in <code>etc/</code>.
For example you have to edit etc/openqa/database.ini to use another database.
Or to increase the log level it&#8217;s useful to set the loglevel to debug in
etc/openqa/openqa.ini.</p>
</div>
<div class="paragraph">
<p>To avoid these changes getting in your git workflow, copy them to a new
directory and set OPENQA_CONFIG in your shell setup files.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span>cp -ar etc/openqa etc/mine
<span class="tok-nb">export</span> <span class="tok-nv">OPENQA_CONFIG</span><span class="tok-o">=</span><span class="tok-nv">$PWD</span>/etc/mine</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that OPENQA_CONFIG points to the directory containing openqa.ini, database.ini,
client.conf and workers.ini.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_adding_new_authentication_module">Adding new authentication module</h2>
<div class="sectionbody">
<div class="paragraph">
<p>OpenQA comes with two authentication modules providing authentication methods:
OpenID and Fake (see <a href="#authentication">User authentication</a>).</p>
</div>
<div class="paragraph">
<p>All authentication modules reside in <code>lib/OpenQA/Auth</code> directory. During
OpenQA start, <code>[auth]/method</code> section of <code>/etc/openqa/openqa.ini</code> is read and according
to its value (or default OpenID) OpenQA tries to require OpenQA::WebAPI::Auth::$method.
If successful, module for given method is imported or the OpenQA ends with error.</p>
</div>
<div class="paragraph">
<p>Each authentication module is expected to export <code>auth_login</code> and <code>auth_logout</code> functions. In case of request-response mechanism (as in
OpenID), <code>auth_response</code> is imported on demand.</p>
</div>
<div class="paragraph">
<p>Currently there is no login page because all implemented methods use either 3rd party
page or none.</p>
</div>
<div class="paragraph">
<p>Authentication module is expected to return HASH:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="perl"><span></span>
<span class="tok-nv">%res</span> <span class="tok-o">=</span> <span class="tok-p">(</span>
    <span class="tok-c1"># error = 1 signals auth error</span>
    <span class="tok-n">error</span> <span class="tok-o">=&gt;</span> <span class="tok-mi">0</span><span class="tok-o">|</span><span class="tok-mi">1</span>
    <span class="tok-c1"># where to redirect the user</span>
    <span class="tok-n">redirect</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&#39;&#39;</span>
<span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Authentication module is expected to create or update user entry in OpenQA database
after user validation. See included modules for inspiration.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_customize_base_directory">Customize base directory</h2>
<div class="sectionbody">
<div id="customize_base_directory" class="paragraph">
<p>It is possible to customize the openQA base directory (which is for instance used to store
test results) by setting the environment variable <code>OPENQA_BASEDIR</code>. The default value
is <code>/var/lib</code>. Be sure to clear that variable when running unit tests locally (see next
section). Take into account that the test results and assets can need a big amount of disk
space.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_running_tests_of_openqa_itself">Running tests of openQA itself</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Beside simply running the testsuite, it is also possible to use containers. Using containers,
tests are executed in the same environment as on CircleCI. This allows to reproduce issues
specific to that environment.</p>
</div>
<div class="sect2">
<h3 id="_run_tests_without_container">Run tests without container</h3>
<div class="paragraph">
<p>Be sure to install all required dependencies. The package <code>openQA-devel</code> will
provide them.</p>
</div>
<div class="paragraph">
<p>If the package is not available the dependencies can also be found in the file
<code>dist/rpm/openQA.spec</code> in the openQA repository. In this case also the package
<code>perl-Selenium-Remote-Driver</code> is required to run UI tests. You also need to
install chromedriver and either chrome or chromium for the UI tests.</p>
</div>
<div class="paragraph">
<p>To execute the testsuite use <code>make test</code>. This will also initialize a
temporary PostgreSQL database used for testing. To do this step manually run
<code>t/test_postgresql /dev/shm/tpg</code> to initialize a temporary PostgreSQL database
and export the environment variable as instructed by that script.
It is also possible to run a particular test, for example
<code>prove t/api/01-workers.t</code>.</p>
</div>
<div class="paragraph">
<p>To watch the execution of the UI tests, set the environment variable <code>NOT_HEADLESS</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_run_tests_with_docker">Run tests with Docker</h3>
<div class="paragraph">
<p>The container used in this section of the documentation is not identical with the container used
within the CI. To run tests within the CI environment locally, checkout the
<a href="#circleci-local-docker">CircleCI documentation</a> below.</p>
</div>
<div class="paragraph">
<p>To run tests in Docker please be sure that Docker is installed and the Docker daemon is running.
To launch the test suite first it is required to pull the docker image:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>docker pull registry.opensuse.org/devel/openqa/containers/openqa_dev:latest</pre>
</div>
</div>
<div class="paragraph">
<p>This Docker image is provided by the OBS repository <a href="https://build.opensuse.org/package/show/devel:openQA/openqa_dev" class="bare">https://build.opensuse.org/package/show/devel:openQA/openqa_dev</a>
and based on the <code>Dockerfile</code> within the <code>docker/ci</code> sub directory of the openQA repository.</p>
</div>
<div class="paragraph">
<p>Build the image using Makefile target:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>make docker-test-build</pre>
</div>
</div>
<div class="paragraph">
<p>Note that the image created by that target is called <code>openqa:latest</code> while the raw container
pulled from OBS is called <code>openqa_dev:latest</code>.</p>
</div>
<div class="paragraph">
<p>Launch the tests using Makefile target:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>make launch-docker-to-run-tests-within</pre>
</div>
</div>
<div class="paragraph">
<p>Run tests by invoking Docker manually, e.g.:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>docker run -v OPENQA_LOCAL_CODE:/opt/openqa -e VAR1=1 -e VAR2=1 openqa:latest make run-tests-within-container</pre>
</div>
</div>
<div class="paragraph">
<p>Replace <code>OPENQA_LOCAL_CODE</code> with the location where you have the openQA code.</p>
</div>
<div class="paragraph">
<p>The command line to run tests manually reveals that the Makefile target <code>run-tests-within-container</code> is used to run the tests <strong>inside</strong> the
container. It does some preparations to be able to run the full stack test within Docker and considers a few
environment variables defining our test matrix:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CHECKSTYLE=1</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">FULLSTACK=0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">UITESTS=0</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">FULLSTACK=0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">UITESTS=1</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">FULLSTACK=1</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">HEAVY=1</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">GH_PUBLISH=true</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>So by replacing VAR1 and VAR2 with those values one can trigger the different tests of the matrix.</p>
</div>
<div class="paragraph">
<p>Of course it is also possible to run (specific) tests directly via <code>prove</code> instead of using the Makefile targets.</p>
</div>
<div class="sect3">
<h4 id="_tips">Tips</h4>
<div class="paragraph">
<p>Commands passed to <code>docker run</code> will be executed after the initialization script (which does database creation and so on). So if there is
the need to run an interactive session after it just do:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>docker run -it -v OPENQA_LOCAL_CODE:/opt/openqa openqa:latest bash</pre>
</div>
</div>
<div class="paragraph">
<p>Of course you can also use <code>make run-tests-within-container \; bash</code> to run the tests first and then open a shell for further investigation.</p>
</div>
<div class="paragraph">
<p>There is also the possibility to change the initialization scripts with the <code>--entrypoint switch</code>. This allows us to go into an interactive
session without any initialization script run:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>docker run -it --entrypoint /bin/bash -v OPENQA_LOCAL_CODE:/opt/openqa registry.opensuse.org/devel/openqa/containers/openqa_dev</pre>
</div>
</div>
<div class="paragraph">
<p>In case there is the need to follow what is happening in the currently running container (the execution will terminate the session):</p>
</div>
<div class="literalblock">
<div class="content">
<pre>docker exec -ti $(docker ps | awk '!/CONTAINER/{print $1}') /bin/bash</pre>
</div>
</div>
<div class="paragraph">
<p>Running UI tests in non-headless mode is also possible, eg.:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>xhost `local:root
docker run --rm -ti --name openqa-testsuite -v /tmp/.X11-unix:/tmp/.X11-unix:rw -e DISPLAY="$DISPLAY" -e NOT_HEADLESS=1 openqa:latest prove -v t/ui/14-dashboard.t
xhost -local:root</pre>
</div>
</div>
<div class="paragraph">
<p>It is also possible to use a custom os-autoinst checkout using the following arguments:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>docker run … -e CUSTOM_OS_AUTOINST=1 -v /path/to/your/os-autoinst:/opt/os-autoinst make run-tests-within-container</pre>
</div>
</div>
<div class="paragraph">
<p>By default, <code>configure</code> and <code>make</code> are still executed (so a clean checkout is expected). If your checkout is already prepared to use,
set <code>CUSTOM_OS_AUTOINST_SKIP_BUILD</code> to prevent this. Be aware that the build produced outside of the container might not work inside the
container if both environments provide different, incompatible library versions (eg. OpenCV).</p>
</div>
<div class="paragraph">
<p>It is also important to mention that your local repositories will be copied into the container. This can take very long if those are big,
e.g. when the openQA repo contains a lot of profiling data because you enabled <code>Mojolicious::Plugin::NYTProf</code>.</p>
</div>
<div class="paragraph">
<p>In general, if starting the tests via Docker seems to hang, it is a good idea to inspect the process tree to see which command is currently
executed.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_logging_behavior">Logging behavior</h3>
<div class="paragraph">
<p>Logs are redirected to a logfile when running tests within the CI. The output
can therefore not be asserted using <code>Test::Output</code>. This can be worked around
by temporarily assigning a different <code>Mojo::Log</code> object to the application. To
test locally under the same condition set the environment variable
<code>OPENQA_LOGFILE</code>.</p>
</div>
<div class="paragraph">
<p>Note that redirecting the logs to a logfile only works for tests which run
<code>OpenQA::Log::setup_log</code>. In other tests the log is just printed to the
standard output. This makes use of <code>Test::Output</code> simple but it should be
taken care that the test output is not cluttered by log messages which can be
quite irritating.</p>
</div>
</div>
<div class="sect2">
<h3 id="_test_runtime_limits">Test runtime limits</h3>
<div class="paragraph">
<p>The test modules use <code>OpenQA::Test::TimeLimit</code> to introduce a test module
specific timeout. The timeout is automatically scaled up based on environment
variables, e.g. <code>CI</code> for continuous integration environments, as well as when
executing while test coverage data is collected as longer runtimes should be
expected in these cases. Consider lowering the timeout value based on usual
local execution times whenever a test module is optimized in runtime. If the
timeout is hit the test module normally aborts with a corresponding message.</p>
</div>
<div class="paragraph">
<p>To disable the timeout globably set the environment variable
<code>OPENQA_TEST_TIMEOUT_DISABLE=1</code>.</p>
</div>
<div class="paragraph">
<p>Please be aware of the exception when the timeout triggers after the actual
test part of a test module has finished but not all involved processes have
finished or END blocks are processed. In this case the output can look like</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code><span></span>t/my_test.t .. All 1 subtests passed

Test Summary Report
-------------------
t/my_test.t (Wstat: 14 Tests: 1 Failed: 0)
  Non-zero wait status: 14
Files=1, Tests=1,  2 wallclock secs ( 0.03 usr  0.00 sys +  0.09 cusr  0.00 csys =  0.12 CPU)
Result: FAIL</code></pre>
</div>
</div>
<div class="paragraph">
<p>where "Wstat: 14" and "Non-zero wait status: 14" mean that the test process
received the "ALRM" signal (signal number 14).</p>
</div>
<div class="paragraph">
<p>In case of problems with timeouts look into <code>OpenQA::Test::TimeLimit</code> to find
environment variables that can tweaked to disable or change timeout values or
timeout scale factors. If you want to disable the timeout for indefinite
manual debugging, set the environment variable
<code>OPENQA_TEST_TIMEOUT_DISABLE=1</code>. The option <code>OPENQA_TEST_TIMEOUT_SCALE_CI</code> is
only effective if the environment variable <code>CI</code> is set, which e.g. it is in
circleCI and OBS but not in local development environments. When running with
coverage analysis enabled the scaling factor of
<code>OPENQA_TEST_TIMEOUT_SCALE_COVER</code> is applied to account for the runtime
overhead.</p>
</div>
<div class="paragraph">
<p>In case of Selenium based UI tests timing out trying to find a local
chromedriver instance the variable <code>OPENQA_SELENIUM_TEST_STARTUP_TIMEOUT</code> can
be set to a higher value. See
<a href="https://metacpan.org/pod/Selenium::Chrome#startup_timeout" class="bare">https://metacpan.org/pod/Selenium::Chrome#startup_timeout</a> for details.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="circleci-workflow">CircleCI workflow</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The goal of the following workflow is to provide a way to run tests with a
pre-approved list of dependencies both in the CI and locally.</p>
</div>
<div class="sect2">
<h3 id="_dependency_artefacts">Dependency artefacts</h3>
<div class="ulist">
<ul>
<li>
<p>ci-packages.txt lists dependencies to test against.</p>
</li>
<li>
<p>autoinst.sha contains sha of os-autoinst commit for integration testing.
The testing will run against the latest master if empty.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_managing_and_troubleshooting_dependencies">Managing and troubleshooting dependencies</h3>
<div class="paragraph">
<p><code>ci-packages.txt</code> and <code>autoinst.sha</code> are aimed to represent those dependencies
which change often. In normal workflow these files are generated automatically
by dedicated Bot, then go in PR through CI, then reviewed and accepted by
human.
So, in normal workflow it is guaranteed that everyone always works on list of
correct and approved dependencies (unless they explicitly tell CI to use
custom dependencies).</p>
</div>
<div class="paragraph">
<p>The Bot tracks dependencies only in master branch by default, but this may be
extended in circleci config file.
The Bot uses <code>.circleci/build_dependencies.sh</code> script to detect any changes.
This script can be used manually as well.
Alternatively just add newly introduced dependencies into ci-packages.txt, so
CI will run tests with them.</p>
</div>
<div class="paragraph">
<p>Occasionally it may be a challenge to work with ci-packages.txt
(e.g. package version is not available anymore). In such case you can either
try to rebuild ci-packages.txt using <code>.circleci/build_dependencies.sh</code> or
just remove all entries and put only openQA-devel into it
Script <code>.circleci/build_dependencies.sh</code> can be also modified when major
changes are performed, e.g. different OS version or packages from forked OBS
project, etc.</p>
</div>
</div>
<div class="sect2">
<h3 id="circleci-local-docker">Run tests locally using Docker</h3>
<div class="paragraph">
<p>One way is to build an image using the <code>build_local_docker.sh</code> script, start a
container and then use the same commands one would use to test locally.</p>
</div>
<div class="paragraph">
<p>Pull the latest base image (otherwise it may be outdated):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code><span></span>docker pull registry.opensuse.org/devel/openqa/ci/containers/base:latest</code></pre>
</div>
</div>
<div class="paragraph">
<p>Create an image called <code>localtest</code> based on the contents of <code>ci-packages.txt</code>
and <code>autoinst</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code><span></span>.circleci/build_local_docker.sh</code></pre>
</div>
</div>
<div class="paragraph">
<p>Mount the openQA checkout under <code>/opt/testing_area</code> within the container and run
tests as usual, e.g.:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code><span></span>docker run -it --rm -v $PWD:/opt/testing_area localtest bash -c &#39;make test TESTS=t/ui/25*&#39;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Alternatively, start the container and execute commands via <code>docker exec</code>, e.g.:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code><span></span>docker run --rm --name t1 -v $PWD:/opt/testing_area localtest tail -f /dev/null &amp; sleep 1
docker exec -it t1 bash -c &#39;make test TESTS=t/ui/25-developer_mode.t&#39;
docker stop -t 0 t1</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_run_tests_using_the_circleci_tool">Run tests using the circleci tool</h3>
<div class="paragraph">
<p>After installing the <code>circleci</code> tool the following commands will be available.
They will build the container and use committed changes from current local branch.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code><span></span>circleci local execute --job test1
circleci local execute --job testui
circleci local execute --job testfullstack
circleci local execute --job testdeveloperfullstack</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_changing_config_cnf">Changing config.cnf</h3>
<div class="paragraph">
<p>Command to verify the YAML with the <code>circleci</code> tool:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code><span></span>circleci config process .circleci/config.yml</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_building_plugins">Building plugins</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Not all code needs to be included in openQA itself. openQA also supports the use
of 3rd party plugins that follow the standards for plugins used by the
<a href="https://mojolicious.org">Mojolicious</a> web framework. These can be distributed as
normal CPAN modules and installed as such alongside openQA.</p>
</div>
<div class="paragraph">
<p>Plugins are a good choice especially for extensions to the UI and HTTP API, but
also for notification systems listening to various events inside the web server.</p>
</div>
<div class="paragraph">
<p>If your plugin was named <code>OpenQA::WebAPI::Plugin::Hello</code>, you would install it
in one of the include directories of the Perl used to run openQA, and then
configure it in <code>openqa.ini</code>. The <code>plugins</code> setting in the <code>global</code> section will
tell openQA what plugins to load.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ini"><span></span><span class="tok-c1"># Tell openQA to load the plugin</span>
<span class="tok-k">[global]</span>
<span class="tok-na">plugins</span> <span class="tok-o">=</span> <span class="tok-s">Hello</span>

<span class="tok-c1"># Plugin specific configuration (optional)</span>
<span class="tok-k">[hello_plugin]</span>
<span class="tok-na">some</span> <span class="tok-o">=</span> <span class="tok-s">value</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The plugin specific configuration is optional, but if defined would be available
in <code>$app&#8594;config&#8594;{hello_plugin}</code>.</p>
</div>
<div class="paragraph">
<p>To extend the UI or HTTP API there are various named routes already defined that
will take care of authentication for your plugin. You just attach the plugin
routes to them and only authenticated requests will get through.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="perl"><span></span><span class="tok-k">package</span> <span class="tok-nn">OpenQA::WebAPI::Plugin::Hello</span><span class="tok-p">;</span>
<span class="tok-k">use</span> <span class="tok-nn">Mojo::Base</span> <span class="tok-s">&#39;Mojolicious::Plugin&#39;</span><span class="tok-p">;</span>

<span class="tok-k">sub</span> <span class="tok-nf">register</span> <span class="tok-p">{</span>
    <span class="tok-k">my</span> <span class="tok-p">(</span><span class="tok-nv">$self</span><span class="tok-p">,</span> <span class="tok-nv">$app</span><span class="tok-p">,</span> <span class="tok-nv">$config</span><span class="tok-p">)</span> <span class="tok-o">=</span> <span class="tok-nv">@_</span><span class="tok-p">;</span>

    <span class="tok-c1"># Only operators may use our plugin</span>
    <span class="tok-k">my</span> <span class="tok-nv">$ensure_operator</span> <span class="tok-o">=</span> <span class="tok-nv">$app</span><span class="tok-o">-&gt;</span><span class="tok-nn">routes</span><span class="tok-o">-&gt;</span><span class="tok-n">find</span><span class="tok-p">(</span><span class="tok-s">&#39;ensure_operator&#39;</span><span class="tok-p">);</span>
    <span class="tok-k">my</span> <span class="tok-nv">$plugin_prefix</span> <span class="tok-o">=</span> <span class="tok-nv">$ensure_operator</span><span class="tok-o">-&gt;</span><span class="tok-n">any</span><span class="tok-p">(</span><span class="tok-s">&#39;/hello_plugin&#39;</span><span class="tok-p">);</span>

    <span class="tok-c1"># Plain text response (under &quot;/admin/hello_plugin/&quot;)</span>
    <span class="tok-nv">$plugin_prefix</span><span class="tok-o">-&gt;</span><span class="tok-n">get</span><span class="tok-p">(</span><span class="tok-s">&#39;/&#39;</span> <span class="tok-o">=&gt;</span> <span class="tok-k">sub</span> <span class="tok-p">{</span>
      <span class="tok-k">my</span> <span class="tok-nv">$c</span> <span class="tok-o">=</span> <span class="tok-nb">shift</span><span class="tok-p">;</span>
      <span class="tok-nv">$c</span><span class="tok-o">-&gt;</span><span class="tok-n">render</span><span class="tok-p">(</span><span class="tok-n">text</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&#39;Hello openQA!&#39;</span><span class="tok-p">);</span>
    <span class="tok-p">})</span><span class="tok-o">-&gt;</span><span class="tok-n">name</span><span class="tok-p">(</span><span class="tok-s">&#39;hello_plugin_index&#39;</span><span class="tok-p">);</span>

    <span class="tok-c1"># Add a link to the UI menu</span>
    <span class="tok-nv">$app</span><span class="tok-o">-&gt;</span><span class="tok-nn">config</span><span class="tok-o">-&gt;</span><span class="tok-p">{</span><span class="tok-n">plugin_links</span><span class="tok-p">}{</span><span class="tok-n">operator</span><span class="tok-p">}{</span><span class="tok-s">&#39;Hello&#39;</span><span class="tok-p">}</span> <span class="tok-o">=</span> <span class="tok-s">&#39;hello_plugin_index&#39;</span><span class="tok-p">;</span>
<span class="tok-p">}</span>

<span class="tok-mi">1</span><span class="tok-p">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>plugin_links</code> configuration setting can be modified by plugins to add links
to the <code>operator</code> and <code>admin</code> sections of the openQA UI menu. Route names or
fully qualified URLs can be used as link targets. If your plugin uses templates,
you should reuse the <code>bootstrap</code> layout provided by openQA. This will ensure a
consistent look, and make the UI menu available everywhere.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="perl"><span></span><span class="tok-nv">%</span> <span class="tok-nv">layout</span> <span class="tok-s">&#39;bootstrap&#39;</span><span class="tok-p">;</span>
<span class="tok-nv">%</span> <span class="tok-nv">title</span> <span class="tok-s">&#39;Hello openQA!&#39;</span><span class="tok-p">;</span>
<span class="tok-sr">&lt;div&gt;</span>
  <span class="tok-sr">&lt;h2&gt;</span><span class="tok-n">Hello</span> <span class="tok-n">openQA</span><span class="tok-o">!</span><span class="tok-sr">&lt;/h2&gt;</span>
<span class="tok-sr">&lt;/div&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>For UI plugins there are two named authentication routes defined:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>ensure_operator</code>: under <code>/admin/</code>, only allows logged in users with <code>operator</code> privileges</p>
</li>
<li>
<p><code>ensure_admin</code>: under <code>/admin/</code>, only allows logged in users with <code>admin</code> privileges</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>And for HTTP API plugins there are four named authentication routes defined:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>api_public</code>: under <code>/api/v1/</code>, allows access to everyone</p>
</li>
<li>
<p><code>api_ensure_user</code>: under <code>/api/v1/</code>, only allows authenticated users</p>
</li>
<li>
<p><code>api_ensure_operator</code>: under <code>/api/v1/</code>, only allows authenticated users with <code>operator</code> privileges</p>
</li>
<li>
<p><code>api_ensure_admin</code>: under <code>/api/v1/</code>, only allows authenticated nusers with <code>admin</code> privileges</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>To generate a minimal installable plugin with a CPAN distribution directory
structure you can use the Mojolicious tools. It can be packaged just like any
other Perl module from CPAN.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span>$ mojo generate plugin -f OpenQA::WebAPI::Plugin::Hello
...
$ <span class="tok-nb">cd</span> OpenQA-WebAPI-Plugin-Hello/
$ perl Makefile.PL
...
$ make <span class="tok-nb">test</span>
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>And if you need code examples, there are some plugins
<a href="https://github.com/os-autoinst/openQA/tree/master/lib/OpenQA/WebAPI/Plugin">included with openQA</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_checking_for_javascript_problems">Checking for JavaScript problems</h2>
<div class="sectionbody">
<div class="paragraph">
<p>One can use the tool <code>jshint</code> to check for problems within JavaScript code. It can be installed
easily via <code>npm</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span>npm install jshint
node_modules/jshint/bin/jshint path/to/javascript.js</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_profiling_the_web_ui">Profiling the web UI</h2>
<div class="sectionbody">
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Install NYTProf, under openSUSE Tumbleweed: <code>zypper in perl-Devel-NYTProf perl-Mojolicious-Plugin-NYTProf</code></p>
</li>
<li>
<p>Put <code>profiling_enabled = 1+ in  `openqa.ini</code>.</p>
</li>
<li>
<p>Optionally import production data like described in the official contributors documentation.</p>
</li>
<li>
<p>Restart the web UI, browse some pages. Profiling is done in the background.</p>
</li>
<li>
<p>Access profiling data via <code>/nytprof</code> route.</p>
</li>
</ol>
</div>
<div class="sect2">
<h3 id="_note">Note</h3>
<div class="paragraph">
<p>Profiling data is extensive. Remove it if you do not need it anymore and disable the <code>profiling_enabled</code>
configuration again if not needed anymore.</p>
</div>
</div>
</div>
</div>
<h1 id="branding" class="sect0">openQA branding</h1>
<div class="openblock partintro">
<div class="content">
<div class="paragraph">
<p>You can alter the appearance of the openQA web UI to some extent through
the 'branding' mechanism. The 'branding' configuration setting in the
'global' section of <code>/etc/openqa/openqa.ini</code> specifies the branding to
use. It defaults to 'openSUSE', and openQA also includes the 'plain'
branding, which is - as its name suggests - plain and generic.</p>
</div>
<div class="paragraph">
<p>To create your own branding for openQA, you can create a subdirectory
of <code>/usr/share/openqa/templates/branding</code> (or wherever openQA is
installed). The subdirectory&#8217;s name will be the name of your branding.
You can copy the files from <code>branding/openSUSE</code> or <code>branding/plain</code> to
use as starting points, and adjust as necessary.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_web_ui_template">Web UI template</h2>
<div class="sectionbody">
<div class="paragraph">
<p>openQA uses the <a href="http://mojolicio.us/">Mojolicious</a> framework&#8217;s templating
system; the branding files are included into the openQA templates at
various points. To see where each branding file is actually included,
you can search through the files in the <code>templates</code> tree for the text
<code>include_branding</code>. Anywhere that helper is called, the branding file
with the matching name is being included.</p>
</div>
<div class="paragraph">
<p>The branding files themselves are Mojolicious 'Embedded Perl' templates just
like the main template files. You can read the <a href="http://mojolicio.us/perldoc/Mojolicious/Guides/Rendering">Mojolicious Documentation</a> for help with the
format.</p>
</div>
</div>
</div>
<h1 id="containerizedsetup" class="sect0">Containerized setup</h1>
<div class="openblock partintro">
<div class="content">
<div class="paragraph">
<p>This section describes two ways to deploy the containers for the openQA web UI
and the workers.</p>
</div>
<div class="paragraph">
<p>The first one describes how to deploy an openQA environment using Docker with
Fedora images or images built locally.</p>
</div>
<div class="paragraph">
<p>The second one uses <code>docker-compose</code> to deploy a complete web UI with HA for the
API and the dashboard. This setup is under development and currently considered
proof-of-concept. Do <strong>not</strong> expect that everything works yet.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_get_container_images">Get container images</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You can either build the images locally or use Fedora images from Docker Hub.</p>
</div>
<div class="paragraph">
<p>For the <code>docker-compose</code> setup it is required to build the images locally.
However, it is done automatically so this section can be skipped unless one
wants to build the containers manually.</p>
</div>
<div class="sect2">
<h3 id="_download_fedora_based_images_from_the_docker_hub">Download Fedora-based images from the Docker Hub</h3>
<div class="literalblock">
<div class="content">
<pre>docker pull fedoraqa/openqa_data
docker pull fedoraqa/openqa_webui
docker pull fedoraqa/openqa_worker</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_build_opensuse_based_images_locally">Build openSUSE-based images locally</h3>
<div class="literalblock">
<div class="content">
<pre>docker build -t openqa_data ./openqa_data
docker build -t openqa_webui ./webui
docker build -t openqa_worker ./worker</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># for docker-compose setup
docker build -f webui/Dockerfile-lb -t openqa_webui_lb ./webui</pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_setup_with_fedora_based_images">Setup with Fedora-based images</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_data_storage_and_directory_structure">Data storage and directory structure</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Our intent was to create universal <code>webui</code> and <code>worker</code> containers and move
all data storage and configurations to a third container, called <code>openqa_data</code>.
<code>openqa_data</code> is a so called
<a href="https://docs.docker.com/storage/volumes#creating-and-mounting-a-data-volume-container">Data Volume Container</a>
and is used for the database and to store results and configuration. During
development and in production, you could update <code>webui</code> and <code>worker</code> images
but as long as <code>openqa_data</code> is intact, you do not lose any data.</p>
</div>
<div class="paragraph">
<p>To make development easier and to reduce the final size of the <code>openqa_data</code>
container, this guide describes how to override <code>tests</code> and <code>factory</code>
directories with directories from your host system. This is not necessary but
recommended. This guide is written with this setup in mind.</p>
</div>
<div class="paragraph">
<p>It is also possible to use <code>tests</code> and <code>factory</code> from within the <code>openqa_data</code>
container (so you do not have any dependency on your host system) or to leave
out the <code>openqa_data</code> container altogether (so you have only <code>webui</code> and
<code>worker</code> containers and data is loaded and saved completely into your host
system). If this is what you prefer, checkout the sections
<a href="#_keeping_all_data_in_the_data_volume_container">Keeping all data in the Data Volume Container</a>
and
<a href="#_keeping_all_data_on_the_host_system">Keeping all data on the host system</a>
respectively.</p>
</div>
<div class="paragraph">
<p>Otherwise, when you want to have the big files (isos and disk images, tests and
needles) outside of the Volume container, you should create this file
structure from within the directory you are going to execute the container:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>mkdir -p data/factory/{iso,hdd} data/tests</pre>
</div>
</div>
<div class="paragraph">
<p>It could be necessary to either run all containers in privileged mode or to
setup SELinux properly. If you are having problems with it, run this command:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>chcon -Rt svirt_sandbox_file_t data</pre>
</div>
</div>
<div class="sect2">
<h3 id="_update_firewall_rules">Update firewall rules</h3>
<div class="paragraph">
<p>There is a
<a href="https://bugzilla.redhat.com/show_bug.cgi?id=1244124">bug in Fedora</a>
with <code>docker-1.7.0-6</code> package that prevents containers to communicate with
each other. This bug prevents workers to connect to the web UI. As a
workaround, run:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>sudo iptables -A DOCKER --source 0.0.0.0/0 --destination 172.17.0.0/16 -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
sudo iptables -A DOCKER --destination 0.0.0.0/0 --source 172.17.0.0/16 -j ACCEPT</pre>
</div>
</div>
<div class="paragraph">
<p>on the host machine.</p>
</div>
</div>
<div class="sect2">
<h3 id="_run_the_data_and_web_ui_containers">Run the data and web UI containers</h3>
<div class="literalblock">
<div class="content">
<pre>docker run -d -h openqa_data --name openqa_data -v `pwd`/data/factory:/data/factory -v `pwd`/data/tests:/data/tests fedoraqa/openqa_data
docker run -d -h openqa_webui --name openqa_webui --volumes-from openqa_data -p 80:80 -p 443:443 fedoraqa/openqa_webui</pre>
</div>
</div>
<div class="paragraph">
<p>You can change the <code>-p</code> parameters if you do not want the openQA instance to
occupy ports 80 and 443, e.g. <code>-p 8080:80 -p 8043:443</code>, but this will cause
problems if you wish to set up workers on other hosts (see below). You do need
root privileges to bind ports 80 and 443 in this way.</p>
</div>
<div class="paragraph">
<p>It is now necessary to create and store the client keys for openQA. In the
next two steps, you will set an OpenID provider (if necessary), create the API
keys in the openQA&#8217;s web interface, and store the configuration in the Data
Container.</p>
</div>
<div class="sect3">
<h4 id="_generate_and_configure_api_credentials">Generate and configure API credentials</h4>
<div class="paragraph">
<p>Go to <a href="https://localhost/api_keys" class="bare">https://localhost/api_keys</a>, generate key and secret. Then run the following
command substituting <code>KEY</code> and <code>SECRET</code> with the generated values:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>docker exec -it openqa_data /scripts/client-conf set -l KEY SECRET</pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_run_the_worker_container">Run the worker container</h3>
<div class="literalblock">
<div class="content">
<pre>docker run -d -h openqa_worker_1 --name openqa_worker_1 --link openqa_webui:openqa_webui --volumes-from openqa_data --privileged fedoraqa/openqa_worker</pre>
</div>
</div>
<div class="paragraph">
<p>Check whether the worker connected in the web UI&#8217;s administration interface.</p>
</div>
<div class="paragraph">
<p>To add more workers, increase the number that is used in hostname and
container name, so to add worker 2 use:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>docker run -d -h openqa_worker_2 --name openqa_worker_2 --link openqa_webui:openqa_webui --volumes-from openqa_data --privileged fedoraqa/openqa_worker</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_enable_services">Enable services</h3>
<div class="paragraph">
<p>Some systemd services are provided to start up the containers, so you do not
have to keep doing it manually. To install and enable them:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>sudo cp systemd/*.service /etc/systemd/system
sudo systemctl daemon-reload
sudo systemctl enable openqa-data.service
sudo systemctl enable openqa-webui.service
sudo systemctl enable openqa-worker@1.service</pre>
</div>
</div>
<div class="paragraph">
<p>Of course, if you set up two workers, also do <code>sudo systemctl enable
openqa-worker@2.service</code>, and so on.</p>
</div>
</div>
<div class="sect2">
<h3 id="_get_tests_isos_and_create_disks">Get tests, ISOs and create disks</h3>
<div class="paragraph">
<p>You have to put your tests under <code>data/tests</code> directory and ISOs under
<code>data/factory/iso</code> directory. For testing Fedora, run:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>git clone https://bitbucket.org/rajcze/openqa_fedora data/tests/fedora
wget https://dl.fedoraproject.org/pub/alt/stage/22_Beta_RC3/Server/x86_64/iso/Fedora-Server-netinst-x86_64-22_Beta.iso -O data/factory/iso/Fedora-Server-netinst-x86_64-22_Beta_RC3.iso</pre>
</div>
</div>
<div class="paragraph">
<p>And set permissions, so any user can read/write the data:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>chmod -R 777 data</pre>
</div>
</div>
<div class="paragraph">
<p>This step is unfortunately necessary because Docker
<a href="https://github.com/docker/docker/issues/7198">can not mount a volume with specific user ownership</a>
in container, so ownership of mounted folders (uid and gid) is the same as on
your host system (presumably 1000:1000 which maps into nonexistent user in all
of the containers).</p>
</div>
<div class="paragraph">
<p>If you wish to keep the tests (for example) separate from the shared
directory, for any reason (we do, in our development scenario) refer to the
[Developing tests with Container setup] section at the end of this document.</p>
</div>
<div class="paragraph">
<p>Populate the openQA database:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>docker exec openqa_webui /var/lib/openqa/tests/fedora/templates</pre>
</div>
</div>
<div class="paragraph">
<p>Create all necessary disk images:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>cd data/factory/hdd &amp;&amp; createhdds.sh VERSION</pre>
</div>
</div>
<div class="paragraph">
<p>where <code>VERSION</code> is the current stable Fedora version (its images will be
created for upgrade tests) and createhdds.sh is in <code>openqa_fedora_tools</code>
repository in <code>/tools</code> directory. Note that you have to have
<code>libguestfs-tools</code> and <code>libguestfs-xfs</code> installed.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_setup_with_opensuse_based_images_and_docker_compose">Setup with openSUSE-based images and docker-compose</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_run_the_data_and_web_ui_containers_in_ha_mode">Run the data and web UI containers in HA mode</h3>
<div class="literalblock">
<div class="content">
<pre>cd 'container/webui'
docker-compose up -d</pre>
</div>
</div>
<div class="paragraph">
<p>To stop it again, run:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>docker-compose down</pre>
</div>
</div>
<div class="sect3">
<h4 id="_change_the_number_of_web_ui_replicas_optional">Change the number of web UI replicas (optional)</h4>
<div class="paragraph">
<p>To set the number of replicas set the environment variable
<code>OPENQA_WEBUI_REPLICAS</code> to the desired number. If this is not set, then the
default value is 2.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code><span></span>export OPENQA_WEBUI_REPLICAS=3</code></pre>
</div>
</div>
<div class="paragraph">
<p>Additionally you can edit the .env file to set the default value for this
variable.</p>
</div>
</div>
<div class="sect3">
<h4 id="_change_the_exported_port_for_the_load_balancer_optional">Change the exported port for the load balancer (optional)</h4>
<div class="paragraph">
<p>By default the load balancer exposes the web UI on ports 9526, 80 and 443.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code><span></span>ports:
  - &quot;80:9526&quot;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_enable_the_ssl_access_to_the_load_balancer_optional">Enable the SSL access to the load balancer (optional)</h4>
<div class="paragraph">
<p>Enable the SSL access in three steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>To expose the SSL port, uncomment this line in the <code>docker-compose.yaml</code> file
in the service nginx:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span>   <span class="tok-p tok-p-Indicator">-</span> <span class="tok-s">&quot;443:443&quot;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You can change the exported port if 443 is already used in your computer, for
instance:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span>   <span class="tok-p tok-p-Indicator">-</span> <span class="tok-s">&quot;10443:443&quot;</span></code></pre>
</div>
</div>
</li>
<li>
<p>Provide an SSL certificate:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span>   <span class="tok-p tok-p-Indicator">-</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">cert.crt:/etc/ssl/certs/openqa.crt</span>
   <span class="tok-p tok-p-Indicator">-</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">cert.key:/etc/ssl/certs/openqa.key</span></code></pre>
</div>
</div>
</li>
<li>
<p>Modify <code>nginx.cfg</code> to use this certificate. Append ` ssl` to the listen command
for port 443 and uncomment the lines:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code><span></span>   ssl_certificate     /etc/ssl/certs/openqa.crt;
   ssl_certificate_key /etc/ssl/certs/openqa.key;</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_generate_and_configure_api_credentials_2">Generate and configure API credentials</h4>
<div class="paragraph">
<p>Go to <a href="https://localhost/api_keys" class="bare">https://localhost/api_keys</a>, generate key and secret. Then run the following
command substituting <code>KEY</code> and <code>SECRET</code> with the generated values:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>docker exec -it openqa_data /scripts/client-conf set -l -t webui_nginx_1 KEY SECRET</pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_run_the_worker_container_2">Run the worker container</h3>
<div class="literalblock">
<div class="content">
<pre>docker run -d -h openqa_worker_1 --name openqa_worker_1 --network webui_default --volumes-from openqa_data --privileged openqa_worker</pre>
</div>
</div>
<div class="paragraph">
<p>Check whether the worker connected in the web UI&#8217;s administration interface.</p>
</div>
<div class="paragraph">
<p>To add more workers, increase the number that is used in hostname and
container name, so to add worker 2 use:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>docker run -d -h openqa_worker_2 --name openqa_worker_2 --network webui_default --volumes-from openqa_data --privileged openqa_worker</pre>
</div>
</div>
<div class="sect3">
<h4 id="_run_a_pool_of_workers_automatically">Run a pool of workers automatically</h4>
<div class="paragraph">
<p>To launch a pool of workers one could use the script <code>./launch_workers_pool.sh</code>.
It will launch the desired number of workers in individual containers using
consecutive numbers for the <code>--instance</code> parameter.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>./launch_workers_pool.sh &lt;number-of-workers&gt;</pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_get_tests_isos_and_create_disks_2">Get tests, ISOs and create disks</h3>
<div class="paragraph">
<p>You have to put your tests under <code>data/tests</code> directory and ISOs under
<code>data/factory/iso</code> directory. For testing openSUSE, follow
<a href="https://github.com/os-autoinst/openQA/blob/master/docs/GettingStarted.asciidoc#testing-opensuse-or-fedora">this guide</a>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_running_jobs">Running jobs</h2>
<div class="sectionbody">
<div class="paragraph">
<p>After performing the "setup" tasks above - do not forget about tests and ISOs
- you can schedule a test like this:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>docker exec openqa_webui /var/lib/openqa/script/client isos post ISO=Fedora-Server-netinst-x86_64-22_Beta_RC3.iso DISTRI=fedora VERSION=rawhide FLAVOR=generic_boot ARCH=x86_64 BUILD=22_Beta_RC3</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_further_configuration_options">Further configuration options</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_change_the_openid_provider">Change the OpenID provider</h3>
<div class="paragraph">
<p><a href="https://www.opensuse.org/openid/user/" class="bare">https://www.opensuse.org/openid/user/</a> is set as a default OpenID provider. To
change it, run:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>docker exec -it openqa_data /scripts/set_openid</pre>
</div>
</div>
<div class="paragraph">
<p>and enter the provider&#8217;s URL.</p>
</div>
</div>
<div class="sect2">
<h3 id="_adding_workers_on_other_hosts">Adding workers on other hosts</h3>
<div class="paragraph">
<p>You may want to add workers on other hosts, so you do not need one powerful
host to run the UI and all the workers.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s assume you are setting up a new 'worker host' and it can see the web UI
host system with the hostname <code>openqa_webui</code>.</p>
</div>
<div class="paragraph">
<p>You must somehow share the <code>data</code> directory from the web UI host to each host
on which you want to run workers. For instance, to use sshfs on the new
worker host, run:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>sshfs -o context=unconfined_u:object_r:svirt_sandbox_file_t:s0 openqa_webui:/path/to/data /path/to/data</pre>
</div>
</div>
<div class="paragraph">
<p>Of course, the worker host must have an ssh key the web UI host will accept.
You can add this mount to <code>/etc/fstab</code> to make it permanent.</p>
</div>
<div class="paragraph">
<p>Then check <code>openqa_fedora_tools</code> out on the worker host and run the data
container, as described above:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>docker run -d -h openqa_data --name openqa_data -v /path/to/data/factory:/data/factory -v /path/to/data/tests:/data/tests fedoraqa/openqa_data</pre>
</div>
</div>
<div class="paragraph">
<p>and set up the API key with <code>docker exec -ti openqa_data /scripts/set_keys</code>.</p>
</div>
<div class="paragraph">
<p>Finally create a worker container, but omit the use of <code>--link</code>.  Ensure you
use a hostname which is different from all other worker instances on all other
hosts. The container name only has to be unique on this host, but it probably
makes sense to always match the hostname to the container name:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>docker run -h openqa_worker_3 --name openqa_worker_3 -d --volumes-from openqa_data --privileged fedoraqa/openqa_worker</pre>
</div>
</div>
<div class="paragraph">
<p>If the container will not be able to resolve the <code>openqa_webui</code> hostname (this
depends on your network setup) you can use <code>--add-host</code> to add a line to
<code>/etc/hosts</code> when running the container:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>docker run -h openqa_worker_3 --name openqa_worker_3 -d --add-host="openqa_webui:10.0.0.1" --volumes-from openqa_data --privileged fedoraqa/openqa_worker</pre>
</div>
</div>
<div class="paragraph">
<p>Worker instances always expect to find the server as <code>openqa_webui</code>; if this
will not work you must adjust the <code>/data/conf/client.conf</code> and
<code>/data/conf/workers.ini</code> files in the data container. You will also need to
adjust these files if you use non-standard ports (see above).</p>
</div>
</div>
<div class="sect2">
<h3 id="_keeping_all_data_in_the_data_volume_container">Keeping all data in the Data Volume container</h3>
<div class="paragraph">
<p>If you decided to keep all the data in the Volume container (<code>openqa_data</code>), run the following commands:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>docker exec openqa_data mkdir -p data/factory/{iso,hdd} data/tests
docker exec openqa_data chmod -R 777 data/factory/{iso,hdd} data/tests</pre>
</div>
</div>
<div class="paragraph">
<p>In the
<a href="#_run_the_data_and_web_ui_containers">section about running the web UI and data container</a>,
use the <code>openqa_data</code>
container like this instead:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>docker run -d -h openqa_data --name openqa_data fedoraqa/openqa_data</pre>
</div>
</div>
<div class="paragraph">
<p>And finally, download the tests and ISOs directly into the container:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>docker exec openqa_data git clone https://bitbucket.org/rajcze/openqa_fedora /data/tests/fedora
docker exec openqa_data wget https://dl.fedoraproject.org/pub/alt/stage/22_Beta_RC3/Server/x86_64/iso/Fedora-Server-netinst-x86_64-22_Beta.iso -O /data/factory/iso/Fedora-Server-netinst-x86_64-22_Beta_RC3</pre>
</div>
</div>
<div class="paragraph">
<p>The rest of the steps should be the same.</p>
</div>
</div>
<div class="sect2">
<h3 id="_keeping_all_data_on_the_host_system">Keeping all data on the host system</h3>
<div class="paragraph">
<p>If you want to keep all the data in the host system and you prefer not to use
a Volume Container, run the following commands:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>cp -a openqa_data/data.template data
chcon -Rt svirt_sandbox_file_t data</pre>
</div>
</div>
<div class="paragraph">
<p>In the
<a href="#_run_the_data_and_web_ui_containers">section about running the web UI and data container</a>,
do <strong>not</strong> run the <code>openqa_data</code>
container and run the <code>webui</code> container like this instead:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>docker run -d -h openqa_webui -v `pwd`/data:/data --name openqa_webui -p 443:443 -p 80:80 fedoraqa/openqa_webui:4.1-3.12</pre>
</div>
</div>
<div class="paragraph">
<p>Change OpenID provider in <code>data/conf/openqa.ini</code> under <code>provider</code> in
<code>[openid]</code> section and then put Key and Secret under both sections in
<code>data/conf/client.conf</code>.</p>
</div>
<div class="paragraph">
<p>In the
<a href="#_run_the_worker_container">run worker container section</a>,
run the worker as:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>docker run -h openqa_worker_1 --name openqa_worker_1 -d --link openqa_webui:openqa_webui -v `pwd`/data:/data --volumes-from openqa_webui --privileged fedoraqa/openqa_worker:4.1-3.12 1</pre>
</div>
</div>
<div class="paragraph">
<p>Then continue with tests and ISOs downloading as before.</p>
</div>
</div>
<div class="sect2">
<h3 id="_developing_tests_with_container_setup">Developing tests with container setup</h3>
<div class="paragraph">
<p>With this setup, the needles created from the web UI will almost certainly have
a different owner and group than your user account. As we have the tests in
Git, we still want to retain the original owner and permissions, even when we
update/create needles from openQA. To accomplish this, we can use BindFS.
An example entry in <code>/etc/fstab</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>bindfs#/home/jskladan/src/openQA/openqa_fedora    /home/jskladan/src/openQA/openqa_fedora_tools/docker/data/tests/fedora    fuse    create-for-user=jskladan,create-for-group=jskladan,create-with-perms=664:a+X,perms=777    0    0</pre>
</div>
</div>
<div class="paragraph">
<p>Mounts the <code>openqa_fedora</code> directory to the <code>&#8230;&#8203;/tests/fedora directory</code>. All
files in the <code>tests/fedora</code> directory seem to have 777 permissions set, but
new files are created (in the underlying <code>openqa_fedora</code> directory) with
<code>jskladan:jskladan</code> user and group, and 664:a+X permissions.</p>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2021-08-24 02:22:02 UTC
</div>
</div>
</body>
</html>